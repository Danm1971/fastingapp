<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8" />
<title>Faste-tracker v42</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
:root {
--bg: #050816;
--card: #0b1020;
--accent: #35c76a;
--accent-soft: #1c7dff;
--danger: #ff4d4f;
--text: #f5f5f7;
--muted: #9ca3af;
--border: #1f2933;
--gold: #facc15;
}

* {
box-sizing: border-box;
margin: 0;
padding: 0;
font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
}

body {
background: radial-gradient(circle at top, #111827 0, #020617 50%, #000 100%);
color: var(--text);
min-height: 100vh;
display: flex;
justify-content: center;
padding: 16px;
}

.app {
width: 100%;
max-width: 900px;
}

.app-header {
display: flex;
justify-content: space-between;
align-items: baseline;
margin-bottom: 12px;
}

.app-title {
font-size: 1.4rem;
font-weight: 600;
}

.version {
font-size: 0.8rem;
color: var(--muted);
}

.grid {
display: grid;
grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
gap: 12px;
}

@media (max-width: 768px) {
.grid {
grid-template-columns: minmax(0, 1fr);
}
}

.card {
background: radial-gradient(circle at top left, #1f2937 0, #020617 55%, #000 100%);
border-radius: 16px;
border: 1px solid var(--border);
padding: 12px 14px;
box-shadow: 0 18px 40px rgba(0, 0, 0, 0.4);
}

.card h2 {
font-size: 0.95rem;
margin-bottom: 8px;
font-weight: 600;
}

.card p {
font-size: 0.8rem;
color: var(--muted);
}

.field-row {
display: grid;
grid-template-columns: repeat(2, minmax(0, 1fr));
gap: 8px;
margin-bottom: 8px;
}

.field {
display: flex;
flex-direction: column;
gap: 2px;
}

.field label {
font-size: 0.7rem;
color: var(--muted);
}

select,
input {
background: #020617;
border-radius: 999px;
border: 1px solid #111827;
padding: 4px 10px;
font-size: 0.8rem;
color: var(--text);
outline: none;
}

input[type="number"] {
-moz-appearance: textfield;
}

input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button {
-webkit-appearance: none;
margin: 0;
}

.pill {
border-radius: 999px;
padding: 6px 10px;
font-size: 0.78rem;
border: 1px solid #111827;
display: inline-flex;
align-items: center;
gap: 6px;
margin-bottom: 6px;
}

.pill-dot {
width: 7px;
height: 7px;
border-radius: 50%;
background: var(--accent);
}

.timer {
font-variant-numeric: tabular-nums;
font-size: 1.4rem;
font-weight: 600;
margin-bottom: 2px;
}

.timer-sub {
font-size: 0.8rem;
color: var(--muted);
margin-bottom: 8px;
}

.buttons-row {
display: flex;
gap: 8px;
flex-wrap: wrap;
margin-top: 6px;
}

button {
border: none;
cursor: pointer;
border-radius: 999px;
padding: 6px 12px;
font-size: 0.8rem;
font-weight: 500;
display: inline-flex;
align-items: center;
gap: 6px;
background: #111827;
color: var(--text);
transition: background 0.12s ease, transform 0.08s ease;
}

button.primary {
background: linear-gradient(135deg, var(--accent-soft), var(--accent));
color: #000;
}

button.danger {
background: #111827;
border: 1px solid #ef4444;
color: #fecaca;
}

button:active {
transform: scale(0.97);
}

.status-row {
display: grid;
grid-template-columns: minmax(0, 1.3fr) minmax(0, 1.2fr);
gap: 8px;
margin-top: 8px;
}

@media (max-width: 768px) {
.status-row {
grid-template-columns: minmax(0, 1fr);
}
}

.status-box {
background: rgba(15, 23, 42, 0.9);
border-radius: 14px;
padding: 8px 10px;
border: 1px solid #111827;
}

.status-title {
font-size: 0.75rem;
color: var(--muted);
margin-bottom: 4px;
}

.status-main {
font-size: 0.9rem;
font-weight: 600;
}

.status-sub {
font-size: 0.75rem;
color: var(--muted);
}

.weight-main {
font-size: 1.2rem;
font-weight: 700;
color: var(--accent);
}

.weight-sub {
font-size: 0.78rem;
color: var(--muted);
}

/* Gauge (Apple-agtig) */

.gauge-card {
margin-top: 6px;
}

.gauge-wrapper {
display: flex;
flex-direction: column;
align-items: center;
margin-top: 4px;
}

.gauge {
position: relative;
width: 220px;
height: 110px;
overflow: hidden;
}

.gauge-arc {
position: absolute;
bottom: -110px;
left: 0;
width: 220px;
height: 220px;
border-radius: 50%;
background: conic-gradient(
from 180deg,
#22c55e 0deg,
#eab308 60deg,
#f97316 120deg,
#ef4444 180deg
);
filter: drop-shadow(0 0 12px rgba(34, 197, 94, 0.4));
opacity: 0.9;
}

.gauge-mask {
position: absolute;
bottom: -110px;
left: 10px;
width: 200px;
height: 200px;
border-radius: 50%;
background: radial-gradient(circle at center, #020617 0, #020617 60%, transparent 61%);
}

.gauge-needle {
position: absolute;
bottom: 0;
left: 50%;
width: 2px;
height: 96px;
background: #e5e7eb;
transform-origin: bottom center;
transform: rotate(-90deg);
transition: transform 0.3s ease-out;
box-shadow: 0 0 8px rgba(248, 250, 252, 0.8);
}

.gauge-center-dot {
position: absolute;
bottom: 0;
left: 50%;
width: 18px;
height: 18px;
transform: translateX(-50%);
border-radius: 50%;
background: radial-gradient(circle at 30% 30%, #f9fafb, #9ca3af);
box-shadow: 0 0 12px rgba(148, 163, 184, 0.9);
}

.gauge-labels {
display: flex;
justify-content: space-between;
width: 100%;
font-size: 0.7rem;
color: var(--muted);
margin-top: 2px;
}

.gauge-boost-text {
margin-top: 4px;
font-size: 0.8rem;
text-align: center;
}

.gauge-boost-highlight {
color: var(--accent);
font-weight: 600;
}

/* Energikilder */

.energy-bars {
margin-top: 6px;
display: grid;
grid-template-columns: minmax(0, 1fr);
gap: 4px;
}

.energy-row {
display: flex;
align-items: center;
justify-content: space-between;
font-size: 0.78rem;
}

.energy-label {
display: flex;
align-items: center;
gap: 6px;
}

.energy-pill {
width: 10px;
height: 10px;
border-radius: 3px;
}

.energy-bar-track {
flex: 1;
height: 6px;
border-radius: 999px;
background: #020617;
margin: 0 8px;
overflow: hidden;
}

.energy-bar-fill {
height: 100%;
border-radius: 999px;
}

/* Colors for energy types */
.energy-fat { background: #22c55e; }
.energy-carb { background: #f97316; }
.energy-muscle { background: #f472b6; }
.energy-bone { background: #e11d48; }

.energy-fat-pill { background: #22c55e; }
.energy-carb-pill { background: #f97316; }
.energy-muscle-pill { background: #f472b6; }
.energy-bone-pill { background: #e11d48; }

/* Badges & autofagi */

.badges-row {
display: flex;
flex-wrap: wrap;
gap: 6px;
margin-top: 6px;
}

.badge {
border-radius: 999px;
padding: 4px 10px;
font-size: 0.7rem;
display: inline-flex;
align-items: center;
gap: 6px;
border: 1px solid #374151;
background: rgba(15,23,42,0.85);
}

.badge-dot {
width: 9px;
height: 9px;
border-radius: 50%;
}

.badge-faste {
border-color: var(--accent);
}

.badge-faste .badge-dot {
background: var(--accent);
box-shadow: 0 0 8px rgba(34,197,94,0.8);
}

.badge-auto {
border-color: var(--accent-soft);
}

.badge-auto .badge-dot {
background: var(--accent-soft);
box-shadow: 0 0 8px rgba(59,130,246,0.9);
}

.pulse {
animation: pulse 1.8s infinite;
}

@keyframes pulse {
0% { transform: scale(1); }
50% { transform: scale(1.08); }
100% { transform: scale(1); }
}

.autofagi-info {
margin-top: 4px;
font-size: 0.78rem;
color: var(--muted);
}

.autofagi-strong {
color: var(--accent-soft);
font-weight: 600;
}

/* Historik */

.history-list {
margin-top: 6px;
font-size: 0.78rem;
max-height: 180px;
overflow-y: auto;
}

.history-item {
display: flex;
justify-content: space-between;
padding: 4px 0;
border-bottom: 1px solid #111827;
}

.history-main {
font-weight: 500;
}

.history-sub {
color: var(--muted);
font-size: 0.72rem;
}

.history-empty {
font-size: 0.75rem;
color: var(--muted);
margin-top: 2px;
}

.hint {
font-size: 0.7rem;
color: var(--muted);
margin-top: 4px;
}

.hint strong {
color: #e5e7eb;
}

.warn {
color: #fbbf24;
}
</style>
</head>
<body>
<div class="app">
<div class="app-header">
<div class="app-title">Faste-tracker</div>
<div class="version">v42 ‚Äì test</div>
</div>

<div class="grid">
<!-- VENSTRE SIDE: Profil + styring + status -->
<div>
<div class="card">
<h2>Din profil</h2>
<p>Bruges til at estimere dit daglige kalorieforbrug og v√¶gttab.</p>

<div class="field-row" style="margin-top:8px;">
<div class="field">
<label for="gender">K√∏n</label>
<select id="gender">
<option value="mand">Mand</option>
<option value="kvinde">Kvinde</option>
<option value="andet">Andet / vil ikke sige</option>
</select>
</div>
<div class="field">
<label for="age">Aldersgruppe</label>
<select id="age">
<option value="under40">Under 40</option>
<option value="40-59" selected>40‚Äì59</option>
<option value="60plus">60+</option>
</select>
</div>
</div>

<div class="field-row">
<div class="field">
<label for="muscle">Muskelmasse</label>
<select id="muscle">
<option value="lav">Lidt muskul√∏s</option>
<option value="normal">Normal</option>
<option value="h√∏j" selected>Meget muskul√∏s</option>
</select>
</div>
<div class="field">
<label for="weight">V√¶gt (kg)</label>
<input id="weight" type="number" value="85" min="40" max="200" />
</div>
</div>

<div class="pill" id="bmr-pill">
<div class="pill-dot"></div>
<span>Estimeret hvileforbr√¶nding: <span id="bmr-value">‚Äì</span> kcal/d√∏gn</span>
</div>

<hr style="border-color:#111827; margin:8px 0;" />

<h2>Styring af faste</h2>
<p>Skriv hvor l√¶nge siden sidste bid, og tryk <strong>Start</strong>.</p>

<div class="field-row" style="margin-top:6px;">
<div class="field">
<label for="already">Allerede fastet (timer)</label>
<input id="already" type="number" value="0" min="0" step="0.5" />
</div>
<div class="field">
<label for="start-weight">Startv√¶gt (kg ‚Äì valgfrit)</label>
<input id="start-weight" type="number" placeholder="fx 85" />
</div>
</div>

<div class="buttons-row">
<button class="primary" id="start-btn">Start / genoptag</button>
<button class="danger" id="reset-btn">Nulstil</button>
<button id="save-btn">Gem denne faste</button>
</div>

<p class="hint">
<span class="warn">Bem√¶rk:</span> Faster under <strong>12 timer</strong> kan ikke gemmes som ‚Äúrigtig faste‚Äù.
</p>

<hr style="border-color:#111827; margin:8px 0;" />

<!-- TIMER + V√ÜGTTAB -->
<div class="status-row">
<div class="status-box">
<div class="status-title">Tid i denne faste</div>
<div class="timer" id="timer-display">00:00:00</div>
<div class="timer-sub">
Reelt: <span id="hours-real">0,0</span> t ¬∑ Effektivt: <span id="hours-effective">0,0</span> t
</div>
<div class="status-sub">
Siden sidste bid: <span id="since-last">‚Äì</span>
</div>
</div>

<div class="status-box">
<div class="status-title">Samlet v√¶gttab (estimeret)</div>
<div class="weight-main" id="weight-loss-total">0 g</div>
<div class="weight-sub">
Heraf fra fasten alene: <span id="weight-loss-fasting">0 g</span>
</div>
</div>
</div>

<!-- GEAR: badges + autofagi -->
<div class="status-row" style="margin-top:8px;">
<div class="status-box">
<div class="status-title">Badges & helbredende effekter</div>
<div class="badges-row" id="badges-row">
<!-- badges injiceres her -->
</div>
<div class="autofagi-info" id="autofagi-info">
Autofagi starter normalt f√∏rst efter ca. 16 timers effektiv faste.
</div>
</div>

<div class="status-box">
<div class="status-title">Autofagi-tid</div>
<div class="status-main">
I autofagi: <span id="autofagi-hours">0,0</span> t
</div>
<div class="status-sub">
<span id="autofagi-countdown">Autofagi om: 16,0 t</span>
</div>
</div>
</div>
</div>
</div>

<!-- H√òJRE SIDE: Gauge + energikilder + historik -->
<div>
<div class="card gauge-card">
<h2>Fedt-boost & energi</h2>
<p>Viser hvor meget hurtigere du br√¶nder fedt lige nu end normalt.</p>

<div class="gauge-wrapper">
<div class="gauge">
<div class="gauge-arc"></div>
<div class="gauge-mask"></div>
<div class="gauge-needle" id="gauge-needle"></div>
<div class="gauge-center-dot"></div>
</div>
<div class="gauge-labels">
<span>Langsom</span>
<span>Mellem</span>
<span>Max-boost</span>
</div>
<div class="gauge-boost-text">
Fedt-boost nu:
<span class="gauge-boost-highlight" id="boost-factor">1,0√ó</span>
<span style="color:var(--muted); font-size:0.75rem;">(if√∏lge model)</span>
</div>
</div>

<div class="energy-bars">
<div class="energy-row">
<div class="energy-label">
<div class="energy-pill energy-fat-pill"></div>
<span>Fedt</span>
</div>
<div class="energy-bar-track">
<div class="energy-bar-fill energy-fat" id="fat-bar" style="width:0%"></div>
</div>
<span id="fat-pct">0%</span>
</div>

<div class="energy-row">
<div class="energy-label">
<div class="energy-pill energy-carb-pill"></div>
<span>Kulhydrat</span>
</div>
<div class="energy-bar-track">
<div class="energy-bar-fill energy-carb" id="carb-bar" style="width:0%"></div>
</div>
<span id="carb-pct">0%</span>
</div>

<div class="energy-row">
<div class="energy-label">
<div class="energy-pill energy-muscle-pill"></div>
<span>Muskler</span>
</div>
<div class="energy-bar-track">
<div class="energy-bar-fill energy-muscle" id="muscle-bar" style="width:0%"></div>
</div>
<span id="muscle-pct">0%</span>
</div>

<div class="energy-row">
<div class="energy-label">
<div class="energy-pill energy-bone-pill"></div>
<span>Knogler</span>
</div>
<div class="energy-bar-track">
<div class="energy-bar-fill energy-bone" id="bone-bar" style="width:0%"></div>
</div>
<span id="bone-pct">0%</span>
</div>
</div>
</div>

<div class="card" style="margin-top:12px;">
<h2>Faste-historik (lokalt p√• enheden)</h2>
<p>Gem kun de faste, hvor du har holdt mindst 12 timer.</p>
<div class="history-list" id="history-list"></div>
</div>
</div>
</div>
</div>

<script>
// ---------- STATE ----------
let startTime = null;
let timerId = null;
let running = false;
let offsetHours = 0; // "Allerede fastet"
let lastHours = 0;

let bmrPerDay = 2200; // estimeres dynamisk
const BASELINE_FAT_FRAC = 0.30; // "normal" fedtandel uden faste
let totalFatGrams = 0;
let baselineFatGrams = 0;

// DOM refs
const genderEl = document.getElementById('gender');
const ageEl = document.getElementById('age');
const muscleEl = document.getElementById('muscle');
const weightEl = document.getElementById('weight');

const bmrValEl = document.getElementById('bmr-value');

const alreadyEl = document.getElementById('already');
const startBtn = document.getElementById('start-btn');
const resetBtn = document.getElementById('reset-btn');
const saveBtn = document.getElementById('save-btn');

const timerDisplay = document.getElementById('timer-display');
const hoursRealEl = document.getElementById('hours-real');
const hoursEffEl = document.getElementById('hours-effective');
const sinceLastEl = document.getElementById('since-last');

const weightLossTotalEl = document.getElementById('weight-loss-total');
const weightLossFastingEl = document.getElementById('weight-loss-fasting');

const badgesRow = document.getElementById('badges-row');
const autofagiInfoEl = document.getElementById('autofagi-info');
const autofagiHoursEl = document.getElementById('autofagi-hours');
const autofagiCountdownEl = document.getElementById('autofagi-countdown');

const needleEl = document.getElementById('gauge-needle');
const boostFactorEl = document.getElementById('boost-factor');

const fatBar = document.getElementById('fat-bar');
const carbBar = document.getElementById('carb-bar');
const muscleBar = document.getElementById('muscle-bar');
const boneBar = document.getElementById('bone-bar');

const fatPctEl = document.getElementById('fat-pct');
const carbPctEl = document.getElementById('carb-pct');
const musclePctEl = document.getElementById('muscle-pct');
const bonePctEl = document.getElementById('bone-pct');

const historyListEl = document.getElementById('history-list');

// ---------- BMR-BEREGNING ----------
function recalcBMR() {
const weight = parseFloat(weightEl.value) || 80;
const gender = genderEl.value;
const age = ageEl.value;
const muscle = muscleEl.value;

// basis: 26 kcal/kg/d√∏gn
let bmr = weight * 26;

if (gender === 'mand') bmr *= 1.05;
if (gender === 'kvinde') bmr *= 0.95;

if (age === '40-59') bmr *= 0.95;
if (age === '60plus') bmr *= 0.9;

if (muscle === 'lav') bmr *= 0.95;
if (muscle === 'normal') bmr *= 1.0;
if (muscle === 'h√∏j') bmr *= 1.12; // lidt ekstra til dig üòÑ

// rimelig gr√¶nser
bmr = Math.max(1300, Math.min(3500, bmr));

bmrPerDay = bmr;
bmrValEl.textContent = Math.round(bmrPerDay) + ' kcal';
}

genderEl.addEventListener('change', recalcBMR);
ageEl.addEventListener('change', recalcBMR);
muscleEl.addEventListener('change', recalcBMR);
weightEl.addEventListener('input', recalcBMR);

recalcBMR();

// ---------- ENERGIMIX-MODEL ----------
function getEnergyMix(hours) {
// hours = effektiv fastetid
if (hours <= 0) {
return { carb: 100, fat: 0, muscle: 0, bone: 0 };
}

let carb, fat, muscle = 0, bone = 0;

if (hours <= 4) {
// 0-4 t: 100% kulhydrat -> 80% kulhydrat, 0 -> 20% fedt
const t = hours / 4;
carb = 100 - 20 * t;
fat = 0 + 20 * t;
} else if (hours <= 12) {
// 4-12 t: 80->50 kulhydrat, 20->50 fedt
const t = (hours - 4) / 8;
carb = 80 - 30 * t;
fat = 20 + 30 * t;
} else if (hours <= 24) {
// 12-24 t: 50->10 kulhydrat, 50->90 fedt
const t = (hours - 12) / 12;
carb = 50 - 40 * t;
fat = 50 + 40 * t;
} else if (hours <= 36) {
// 24-36 t: 10->5 kulhydrat, 90->92 fedt, 0->3 muskler
const t = (hours - 24) / 12;
carb = 10 - 5 * t;
fat = 90 + 2 * t;
muscle = 0 + 3 * t;
} else if (hours <= 48) {
// 36-48 t: 5->3 kulhydrat, 92->90 fedt, 3->5 muskler, 0->2 knogle
const t = (hours - 36) / 12;
carb = 5 - 2 * t;
fat = 92 - 2 * t;
muscle = 3 + 2 * t;
bone = 0 + 2 * t;
} else {
carb = 3;
fat = 88;
muscle = 5;
bone = 4;
}

// sikkerhed
if (carb < 0) carb = 0;
if (fat < 0) fat = 0;
if (muscle < 0) muscle = 0;
if (bone < 0) bone = 0;

const sum = carb + fat + muscle + bone || 1;
return {
carb: (carb / sum) * 100,
fat: (fat / sum) * 100,
muscle: (muscle / sum) * 100,
bone: (bone / sum) * 100
};
}

// ---------- V√ÜGTTABSINTEGRATION FOR OFFSET ----------
function integrateFatUntil(hours) {
const bmrHour = bmrPerDay / 24;
const step = 0.1; // timer
let totFat = 0;
let baseFat = 0;

for (let t = 0; t < hours; t += step) {
const hMid = t + step / 2;
const mix = getEnergyMix(hMid);
const fatFrac = mix.fat / 100;
totFat += (bmrHour * fatFrac * step) / 7.7;
baseFat += (bmrHour * BASELINE_FAT_FRAC * step) / 7.7;
}

return { totFat, baseFat };
}

// ---------- FORMATTERE ----------
function fmtTime(hours) {
const totalSec = Math.max(0, Math.round(hours * 3600));
const h = Math.floor(totalSec / 3600);
const m = Math.floor((totalSec % 3600) / 60);
const s = totalSec % 60;
return (
String(h).padStart(2, '0') + ':' +
String(m).padStart(2, '0') + ':' +
String(s).padStart(2, '0')
);
}

function fmtHours(h) {
return h.toFixed(1).replace('.', ',');
}

function fmtGrams(g) {
return Math.round(g) + ' g';
}

// ---------- GAUGE ----------
function updateGauge(fatFraction) {
// fatFraction: 0-1
const base = 0.10; // "normal" fedtandel
const boost = fatFraction <= 0 ? 1 : Math.max(1, fatFraction / base);
const clampedBoost = Math.min(boost, 9); // max visning 9√ó

const angle = -90 + ((clampedBoost - 1) / 8) * 180;
needleEl.style.transform = `rotate(${angle}deg)`;
boostFactorEl.textContent = clampedBoost.toFixed(1).replace('.', ',') + '√ó';
}

// ---------- BADGES ----------
function updateBadges(effHours) {
badgesRow.innerHTML = '';

// Badge 1: Officiel faste (>= 12 t)
if (effHours >= 12) {
const b1 = document.createElement('div');
b1.className = 'badge badge-faste pulse';
b1.innerHTML = `
<div class="badge-dot"></div>
<span>üéñÔ∏è Officiel faste (+12 t)</span>
`;
badgesRow.appendChild(b1);
}

// Badge 2: Autofagi (>= 16 t)
if (effHours >= 16) {
const b2 = document.createElement('div');
b2.className = 'badge badge-auto pulse';
b2.innerHTML = `
<div class="badge-dot"></div>
<span>üß¨ Autofagi i gang</span>
`;
badgesRow.appendChild(b2);
}

if (badgesRow.innerHTML === '') {
badgesRow.innerHTML = `<span style="font-size:0.75rem; color:var(--muted);">Hold mindst 12 timer for at f√• din f√∏rste faste-badge.</span>`;
}
}

// ---------- HISTORIK ----------
function loadHistory() {
try {
const raw = localStorage.getItem('fastHistory_v42');
if (!raw) return [];
return JSON.parse(raw);
} catch {
return [];
}
}

function saveHistoryList(list) {
localStorage.setItem('fastHistory_v42', JSON.stringify(list));
}

function renderHistory() {
const list = loadHistory();
historyListEl.innerHTML = '';

if (!list.length) {
historyListEl.innerHTML = `<div class="history-empty">Ingen gemte faster endnu. Gem dine >12-timers faster her.</div>`;
return;
}

list
.slice()
.reverse()
.forEach(item => {
const row = document.createElement('div');
row.className = 'history-item';
row.innerHTML = `
<div>
<div class="history-main">${item.hours.toFixed(1).replace('.', ',')} t ¬∑ ${Math.round(item.weight)} g</div>
<div class="history-sub">${new Date(item.date).toLocaleString('da-DK')}</div>
</div>
<div class="history-sub">
Autofagi: ${item.autoHours.toFixed(1).replace('.', ',')} t
</div>
`;
historyListEl.appendChild(row);
});
}

renderHistory();

// ---------- TIMER-OPDATERING ----------
function updateUI() {
if (!running) return;

const now = Date.now();
const elapsedMs = now - startTime;
const elapsedHours = elapsedMs / 3600000;
const realHours = Math.max(0, offsetHours + elapsedHours);
const effHours = realHours; // her kan senere tilf√∏jes sport/refeed, hvis vi vil

// incremental v√¶gttab fra sidst
const bmrHour = bmrPerDay / 24;
const deltaHours = realHours - lastHours;
if (deltaHours > 0) {
const mix = getEnergyMix(effHours);
const fatFrac = mix.fat / 100;
totalFatGrams += (bmrHour * fatFrac * deltaHours) / 7.7;
baselineFatGrams += (bmrHour * BASELINE_FAT_FRAC * deltaHours) / 7.7;
lastHours = realHours;
}

const totalFat = Math.max(0, totalFatGrams);
const fastOnly = Math.max(0, totalFatGrams - baselineFatGrams);

// timer-visning
timerDisplay.textContent = fmtTime(realHours);
hoursRealEl.textContent = fmtHours(realHours);
hoursEffEl.textContent = fmtHours(effHours);
sinceLastEl.textContent = fmtTime(realHours);

// v√¶gttab
weightLossTotalEl.textContent = fmtGrams(totalFat);
weightLossFastingEl.textContent = fmtGrams(fastOnly);

// energimix
const mixNow = getEnergyMix(effHours);
const fatFracNow = mixNow.fat / 100;

fatBar.style.width = mixNow.fat.toFixed(0) + '%';
carbBar.style.width = mixNow.carb.toFixed(0) + '%';
muscleBar.style.width = mixNow.muscle.toFixed(0) + '%';
boneBar.style.width = mixNow.bone.toFixed(0) + '%';

fatPctEl.textContent = mixNow.fat.toFixed(0) + '%';
carbPctEl.textContent = mixNow.carb.toFixed(0) + '%';
musclePctEl.textContent = mixNow.muscle.toFixed(0) + '%';
bonePctEl.textContent = mixNow.bone.toFixed(0) + '%';

// gauge
updateGauge(fatFracNow);

// autofagi
let autoHours = 0;
if (effHours >= 16) {
autoHours = effHours - 16;
autofagiHoursEl.textContent = fmtHours(autoHours);
autofagiCountdownEl.textContent = 'Autofagi aktiv ‚úÖ';
autofagiInfoEl.innerHTML = `<span class="autofagi-strong">Kroppen rydder op i slidte celler (autofagi).</span>`;
} else {
const toAuto = 16 - effHours;
autofagiHoursEl.textContent = '0,0';
autofagiCountdownEl.textContent = 'Autofagi om: ' + fmtHours(Math.max(0, toAuto)) + ' t';
autofagiInfoEl.textContent = 'Autofagi starter normalt f√∏rst efter ca. 16 timers effektiv faste.';
}

// badges
updateBadges(effHours);
}

// ---------- START / NULSTIL / GEM ----------
startBtn.addEventListener('click', () => {
if (running) return; // undg√• dobbel-start

offsetHours = parseFloat(alreadyEl.value.replace(',', '.')) || 0;
offsetHours = Math.max(0, offsetHours);

// reset v√¶gttab og integr√©r op til offsetHours
const pre = integrateFatUntil(offsetHours);
totalFatGrams = pre.totFat;
baselineFatGrams = pre.baseFat;
lastHours = offsetHours;

startTime = Date.now();
running = true;

if (timerId) clearInterval(timerId);
timerId = setInterval(updateUI, 1000);
updateUI();
});

resetBtn.addEventListener('click', () => {
running = false;
if (timerId) clearInterval(timerId);
startTime = null;
offsetHours = 0;
lastHours = 0;
alreadyEl.value = '0';

totalFatGrams = 0;
baselineFatGrams = 0;

timerDisplay.textContent = '00:00:00';
hoursRealEl.textContent = '0,0';
hoursEffEl.textContent = '0,0';
sinceLastEl.textContent = '‚Äì';

weightLossTotalEl.textContent = '0 g';
weightLossFastingEl.textContent = '0 g';

fatBar.style.width = '0%';
carbBar.style.width = '0%';
muscleBar.style.width = '0%';
boneBar.style.width = '0%';

fatPctEl.textContent = '0%';
carbPctEl.textContent = '0%';
musclePctEl.textContent = '0%';
bonePctEl.textContent = '0%';

updateGauge(0.1);
autofagiHoursEl.textContent = '0,0';
autofagiCountdownEl.textContent = 'Autofagi om: 16,0 t';
autofagiInfoEl.textContent = 'Autofagi starter normalt f√∏rst efter ca. 16 timers effektiv faste.';
updateBadges(0);
});

saveBtn.addEventListener('click', () => {
if (!running && !startTime) {
alert('Der er ingen aktiv faste at gemme.');
return;
}

// beregn seneste tider √©n gang
const now = Date.now();
const elapsedMs = running ? (now - startTime) : 0;
const elapsedHours = elapsedMs / 3600000;
const realHours = Math.max(0, offsetHours + elapsedHours);
const effHours = realHours;

if (effHours < 12) {
alert(
'Du kan kun gemme faster p√• mindst 12 timer.\n\n' +
'Det er for at sikre, at din historik kun best√•r af rigtige faster ‚Äì ikke bare almindelige pauser mellem m√•ltider.'
);
return;
}

// brug de nuv√¶rende akkumulerede v√¶rdier
const totalFat = Math.max(0, totalFatGrams);
const autoHours = Math.max(0, effHours - 16);

const list = loadHistory();
list.push({
date: new Date().toISOString(),
hours: effHours,
weight: totalFat,
autoHours: autoHours
});
saveHistoryList(list);
renderHistory();
alert('Faste gemt i din lokale historik ‚úÖ');
});

// initial gauge
updateGauge(0.1);
</script>
</body>
</html>
