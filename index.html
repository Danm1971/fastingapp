<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8" />
<title>Faste-tracker v23</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
:root {
--bg: #050816;
--bg-card: #0d1220;
--accent: #ff4b91;
--accent-soft: #ffc7dd;
--accent-2: #26c6da;
--accent-3: #ffca28;
--text: #f5f5f7;
--text-soft: #a0aec0;
--danger: #ff1744;
--ok: #00e676;
--border-subtle: #20263a;
}

* {
box-sizing: border-box;
font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
"Segoe UI", sans-serif;
}

body {
margin: 0;
padding: 0;
background: radial-gradient(circle at top, #181a3a, #050816 55%);
color: var(--text);
display: flex;
justify-content: center;
min-height: 100vh;
}

.page {
width: 100%;
max-width: 960px;
padding: 16px;
}

h1 {
margin-top: 0;
font-size: 1.6rem;
display: flex;
align-items: center;
gap: 8px;
}

h1 span.logo-pill {
display: inline-flex;
align-items: center;
justify-content: center;
width: 32px;
height: 32px;
border-radius: 999px;
background: radial-gradient(circle at 30% 30%, #ff9a9e, #ff4b91);
color: #fff;
font-weight: 700;
font-size: 0.9rem;
}

.subtitle {
font-size: 0.9rem;
color: var(--text-soft);
margin-bottom: 16px;
}

.layout {
display: grid;
gap: 12px;
}

@media (min-width: 800px) {
.layout {
grid-template-columns: minmax(0, 3fr) minmax(0, 2fr);
align-items: flex-start;
}
}

.card {
background: linear-gradient(145deg, #0b1020, #11172a);
border-radius: 16px;
padding: 14px 14px 16px;
border: 1px solid var(--border-subtle);
box-shadow: 0 24px 40px rgba(0, 0, 0, 0.55);
}

.card h2 {
margin: 0 0 8px;
font-size: 1rem;
display: flex;
align-items: center;
gap: 6px;
}

.card h2 span.tag {
font-size: 0.7rem;
padding: 2px 8px;
border-radius: 999px;
border: 1px solid rgba(255, 255, 255, 0.08);
color: var(--text-soft);
}

.timer-row {
display: flex;
flex-wrap: wrap;
align-items: center;
gap: 8px;
margin-bottom: 8px;
}

.timer-main {
font-variant-numeric: tabular-nums;
font-size: 1.7rem;
font-weight: 600;
letter-spacing: 0.04em;
}

.timer-label {
font-size: 0.8rem;
color: var(--text-soft);
}

.badge {
display: inline-flex;
align-items: center;
gap: 6px;
padding: 4px 8px;
border-radius: 999px;
background: rgba(255, 255, 255, 0.03);
font-size: 0.75rem;
color: var(--text-soft);
}

.badge span.dot {
width: 8px;
height: 8px;
border-radius: 50%;
background: var(--accent);
box-shadow: 0 0 8px rgba(255, 75, 145, 0.8);
}

.grid-2 {
display: grid;
gap: 6px;
}

@media (min-width: 600px) {
.grid-2 {
grid-template-columns: repeat(2, minmax(0, 1fr));
}
}

.field {
display: flex;
flex-direction: column;
gap: 4px;
margin-bottom: 6px;
}

.field label {
font-size: 0.78rem;
color: var(--text-soft);
}

.field input,
.field select {
border-radius: 999px;
border: 1px solid rgba(255, 255, 255, 0.12);
background: rgba(0, 0, 0, 0.2);
color: var(--text);
padding: 6px 10px;
font-size: 0.8rem;
outline: none;
}

.field input::placeholder {
color: #5c6477;
}

.field small {
font-size: 0.7rem;
color: var(--text-soft);
}

.btn-row {
display: flex;
flex-wrap: wrap;
gap: 6px;
margin: 6px 0 0;
}

button {
border-radius: 999px;
border: none;
cursor: pointer;
font-size: 0.8rem;
padding: 6px 12px;
display: inline-flex;
align-items: center;
gap: 6px;
background: #22263b;
color: var(--text);
transition: transform 0.07s ease, box-shadow 0.07s ease,
background 0.15s ease;
}

button.primary {
background: linear-gradient(135deg, #ff4b91, #ff7b54);
color: #fff;
box-shadow: 0 8px 16px rgba(255, 75, 145, 0.45);
}

button.danger {
background: rgba(255, 53, 94, 0.08);
color: #ff8a80;
border: 1px solid rgba(255, 82, 82, 0.4);
}

button.secondary {
background: rgba(144, 202, 249, 0.12);
color: #e3f2fd;
border: 1px solid rgba(144, 202, 249, 0.5);
}

button:active {
transform: translateY(1px) scale(0.99);
box-shadow: none;
}

.pill-stat {
background: rgba(0, 0, 0, 0.35);
border-radius: 14px;
padding: 6px 8px;
display: flex;
justify-content: space-between;
align-items: baseline;
margin-top: 4px;
border: 1px solid rgba(255, 255, 255, 0.04);
}

.pill-stat-label {
font-size: 0.7rem;
color: var(--text-soft);
}

.pill-stat-value {
font-variant-numeric: tabular-nums;
font-size: 0.9rem;
}

.pill-stat-value strong {
font-weight: 600;
color: var(--accent-soft);
}

.phase-strip {
margin-top: 6px;
padding: 8px;
border-radius: 12px;
background: radial-gradient(circle at top left, #312258, #0b101f);
border: 1px solid rgba(255, 255, 255, 0.06);
}

.phase-strip-header {
display: flex;
justify-content: space-between;
align-items: center;
gap: 6px;
margin-bottom: 6px;
}

.phase-title {
font-size: 0.8rem;
display: flex;
align-items: center;
gap: 6px;
}

.phase-title span.emoji {
font-size: 1rem;
}

.phase-label {
font-size: 0.7rem;
color: var(--text-soft);
}

.phase-bar {
position: relative;
height: 14px;
border-radius: 999px;
background: linear-gradient(
90deg,
#374151 0%,
#f97316 20%,
#22c55e 50%,
#f97316 80%,
#ef4444 100%
);
overflow: hidden;
}

.phase-bar-fill {
position: absolute;
top: 0;
left: 0;
bottom: 0;
background: rgba(15, 23, 42, 0.9);
transform-origin: left;
transform: scaleX(0);
transition: transform 0.25s ease-out;
}

.phase-bar-marker {
position: absolute;
top: -2px;
width: 2px;
bottom: -2px;
background: #f9fafb;
box-shadow: 0 0 6px rgba(248, 250, 252, 0.8);
}

.phase-strip-footer {
margin-top: 4px;
font-size: 0.7rem;
color: var(--text-soft);
display: flex;
justify-content: space-between;
gap: 6px;
flex-wrap: wrap;
}

.fat-block {
margin-top: 8px;
padding: 8px;
border-radius: 12px;
background: rgba(15, 23, 42, 0.9);
border: 1px solid rgba(148, 163, 184, 0.35);
}

.fat-block h3 {
margin: 0 0 4px;
font-size: 0.8rem;
display: flex;
justify-content: space-between;
gap: 6px;
}

.fat-grid {
display: grid;
grid-template-columns: repeat(4, minmax(0, 1fr));
gap: 4px;
margin-top: 6px;
}

.fat-pill {
text-align: center;
border-radius: 999px;
padding: 3px 0;
font-size: 0.7rem;
background: rgba(15, 23, 42, 0.8);
border: 1px solid rgba(148, 163, 184, 0.3);
color: var(--text-soft);
}

.fat-pill span.val {
display: block;
font-variant-numeric: tabular-nums;
font-size: 0.78rem;
color: var(--text);
}

.fat-pill.carb {
border-color: #fb923c;
background: rgba(251, 146, 60, 0.08);
}
.fat-pill.fat {
border-color: #4ade80;
background: rgba(34, 197, 94, 0.08);
}
.fat-pill.muscle {
border-color: #f472b6;
background: rgba(236, 72, 153, 0.08);
}
.fat-pill.bone {
border-color: #38bdf8;
background: rgba(56, 189, 248, 0.08);
}

.medal-row {
display: flex;
align-items: center;
justify-content: space-between;
margin-top: 6px;
font-size: 0.8rem;
}

.medal-main {
display: inline-flex;
align-items: center;
gap: 6px;
}

.medal-emoji {
font-size: 1.3rem;
}

.medal-label {
font-size: 0.75rem;
color: var(--text-soft);
}

.weight-chip {
position: relative;
margin-top: 4px;
background: radial-gradient(circle at 30% 20%, #ff9a9e, #f97316);
border-radius: 999px;
padding: 4px 10px;
display: inline-flex;
align-items: baseline;
gap: 4px;
font-size: 0.82rem;
box-shadow: 0 4px 12px rgba(248, 113, 113, 0.55);
}

.weight-chip strong {
font-variant-numeric: tabular-nums;
}

.weight-chip span.unit {
font-size: 0.7rem;
opacity: 0.8;
}

.weight-chip small {
font-size: 0.65rem;
opacity: 0.85;
}

.tiny-note {
font-size: 0.65rem;
color: var(--text-soft);
margin-top: 4px;
}

.disclaimer {
margin-top: 10px;
font-size: 0.7rem;
color: var(--text-soft);
line-height: 1.4;
}

.disclaimer strong {
color: #e5e7eb;
}

.autofagi-tag {
display: inline-flex;
align-items: center;
gap: 6px;
font-size: 0.75rem;
margin-top: 4px;
padding: 3px 8px;
border-radius: 999px;
background: rgba(56, 189, 248, 0.1);
border: 1px solid rgba(56, 189, 248, 0.65);
color: #e0f2fe;
}
</style>
</head>
<body>
<div class="page">
<h1>
<span class="logo-pill">F</span>
Faste-tracker v23
</h1>
<div class="subtitle">
Tryk <strong>Start</strong>, n√•r du tager sidste bid mad ‚Äì appen husker
din faste, selvom du lukker den og kommer tilbage senere.
</div>

<div class="layout">
<!-- VENSTRE SIDE: TIMER + GRAFIK -->
<div class="card">
<h2>
Faste-status
<span class="tag" id="phaseTag">Ikke startet</span>
</h2>

<div class="timer-row">
<div>
<div class="timer-main" id="realTimer">00:00:00</div>
<div class="timer-label">Reel tid siden sidste m√•ltid</div>
</div>
<div>
<div class="timer-main" id="effectiveTimer">00:00:00</div>
<div class="timer-label">
Effektiv faste-tid (sport/refeed indregnet)
</div>
</div>
</div>

<div class="badge">
<span class="dot"></span>
<span id="phaseTextShort">Start fasten for at se din fase.</span>
</div>

<!-- FASE-BAR -->
<div class="phase-strip">
<div class="phase-strip-header">
<div class="phase-title">
<span class="emoji" id="phaseEmoji">‚è∏Ô∏è</span>
<span id="phaseTitle">Ingen faste endnu</span>
</div>
<div class="phase-label" id="timeToOptimalLabel">
‚Äì timer til optimal fedtforbr√¶nding
</div>
</div>
<div class="phase-bar">
<div class="phase-bar-fill" id="phaseBarFill"></div>
<div class="phase-bar-marker" id="phaseMarker"></div>
</div>
<div class="phase-strip-footer">
<span>Lav / kulhydrat</span>
<span>P√• vej</span>
<span>Optimal</span>
<span>Over ‚Äì aftagende</span>
</div>
</div>

<!-- FEDT / KULHYDRAT / MUSKLER / KNOGLE -->
<div class="fat-block">
<h3>
Energikilde lige nu
<span id="fatSummary" style="font-weight:400;font-size:0.75rem">
‚Äì
</span>
</h3>
<div class="fat-grid">
<div class="fat-pill carb">
Kulhydrat
<span class="val" id="carbPercent">‚Äì%</span>
</div>
<div class="fat-pill fat">
Fedt
<span class="val" id="fatPercent">‚Äì%</span>
</div>
<div class="fat-pill muscle">
Muskler
<span class="val" id="musclePercent">‚Äì%</span>
</div>
<div class="fat-pill bone">
Knogle / ‚Äúh√•rdt v√¶v‚Äù
<span class="val" id="bonePercent">‚Äì%</span>
</div>
</div>

<div class="medal-row">
<div class="medal-main">
<span class="medal-emoji" id="medalEmoji">‚¨ú</span>
<div>
<div id="medalTitle">Ingen medalje endnu</div>
<div class="medal-label" id="medalDesc">
Fast lidt l√¶ngere for at optjene din f√∏rste.
</div>
</div>
</div>
<div class="weight-chip" id="weightChip">
<strong id="weightLossGrams">0</strong>
<span class="unit">g</span>
<small>samlet v√¶gttab</small>
</div>
</div>

<div
class="autofagi-tag"
id="autofagiTag"
style="display: none; margin-top: 6px"
>
üß¨ Autofagi: Kroppen er i ‚Äúoprydnings-mode‚Äù og nedbryder sv√¶kkede
celler.
</div>

<div class="tiny-note">
<strong>V√¶gttab</strong> inkluderer b√•de faste (kalorieunderskud),
basisforbr√¶nding og indtastet aktivitet. Tallene er grove modeller.
</div>
</div>

<div class="disclaimer">
<strong>Ansvarsfraskrivelse:</strong> Dette er kun en
motivations-model baseret p√• simple antagelser. Den erstatter ikke
l√¶gelig r√•dgivning og er ikke personlig medicinsk vejledning.
</div>
</div>

<!-- H√òJRE SIDE: PROFIL + KONTROL -->
<div class="card">
<h2>
Din profil & styring
<span class="tag">Gemmes automatisk p√• enheden</span>
</h2>

<div class="grid-2">
<div class="field">
<label>Aldersgruppe</label>
<select id="ageGroup">
<option value="18-29">18‚Äì29 √•r</option>
<option value="30-39">30‚Äì39 √•r</option>
<option value="40-49" selected>40‚Äì49 √•r</option>
<option value="50-59">50‚Äì59 √•r</option>
<option value="60-69">60‚Äì69 √•r</option>
<option value="70+">70+ √•r</option>
</select>
</div>
<div class="field">
<label>K√∏n</label>
<select id="gender">
<option value="mand" selected>Mand</option>
<option value="kvinde">Kvinde</option>
<option value="andet">Andet / vil ikke sige</option>
</select>
</div>
</div>

<div class="grid-2">
<div class="field">
<label>V√¶gt (kg)</label>
<input
type="number"
id="weight"
min="30"
max="250"
step="0.5"
placeholder="fx 80"
/>
</div>
<div class="field">
<label>Helbred (selvvurderet)</label>
<select id="health">
<option value="sund" selected>Generelt sund</option>
<option value="let">Let p√•virket (fx BT, kolesterol)</option>
<option value="kronisk">Kronisk sygdom / medicin</option>
</select>
</div>
</div>

<div class="pill-stat">
<div class="pill-stat-label">
Estimeret dagligt kalorieforbrug (inkl. basisforbr√¶nding)
</div>
<div class="pill-stat-value">
<strong id="dailyCalories">‚Äì</strong> kcal/d√∏gn
</div>
</div>

<div class="pill-stat">
<div class="pill-stat-label">
Basisforbr√¶nding pr. time (bruges til sport/refeed-beregning)
</div>
<div class="pill-stat-value">
<strong id="bmrHour">‚Äì</strong> kcal/time
</div>
</div>

<hr style="border:none;border-top:1px solid rgba(148,163,184,0.35);margin:10px 0" />

<div class="field">
<label>
Hvor mange timer siden du sidst spiste?
</label>
<input
type="number"
id="preHours"
min="0"
step="0.25"
placeholder="fx 3 (hvis du spiste for 3 timer siden)"
/>
<small>
Bruges √©n gang ved start (eller n√•r du genstarter), s√• du slipper
for at starte fra 0, hvis du allerede har v√¶ret i gang.
</small>
</div>

<div class="btn-row">
<button class="primary" id="startBtn">‚ñ∂Ô∏è Start / forts√¶t</button>
<button class="danger" id="resetBtn">üîÅ Nulstil faste</button>
</div>

<div class="pill-stat">
<div class="pill-stat-label">Effektiv faste-tid lige nu</div>
<div class="pill-stat-value">
<strong id="effectiveHoursLabel">0,0</strong> timer
</div>
</div>

<div class="pill-stat">
<div class="pill-stat-label">
Reel faste-tid (siden sidste m√•ltid + evt. forrige faste)
</div>
<div class="pill-stat-value">
<strong id="realHoursLabel">0,0</strong> timer
</div>
</div>

<hr style="border:none;border-top:1px solid rgba(148,163,184,0.35);margin:10px 0" />

<h2 style="margin-top:4px;font-size:0.9rem">
Sport & aktivitet
<span class="tag">‚ÄúGenvej‚Äù til resultater</span>
</h2>

<div class="field">
<label>Kalorier forbr√¶ndt ved aktivitet</label>
<input
type="number"
id="activityCalories"
min="0"
step="10"
placeholder="fx 400 efter cykeltur"
/>
<small>
Du kan tilf√∏je aktivitet flere gange under samme faste (g√•tur,
cykling, styrketr√¶ning osv.).
</small>
</div>
<div class="btn-row">
<button class="secondary" id="addActivityBtn">
üí™ Tilf√∏j aktivitet til fasen
</button>
</div>
<div class="pill-stat">
<div class="pill-stat-label">
Samlede aktivitets-kalorier i denne faste
</div>
<div class="pill-stat-value">
<strong id="totalActivityCalories">0</strong> kcal
</div>
</div>

<hr style="border:none;border-top:1px solid rgba(148,163,184,0.35);margin:10px 0" />

<h2 style="margin-top:4px;font-size:0.9rem">
Refeed-m√•ltid (√©n gang per faste)
<span class="tag">Valgfrit</span>
</h2>

<div class="field">
<label>
Kalorier i refeed-m√•ltid
</label>
<input
type="number"
id="refeedCalories"
min="0"
step="10"
placeholder="fx 400"
/>
<small>
Brug kun dette, hvis du √©n gang under en l√¶ngere faste tager et
mindre m√•ltid og forts√¶tter fasten bagefter. Modellen antager, at
det tager dobbelt s√• lang tid at ‚Äúvinde effekten tilbage‚Äù som det
ville tage at forbr√¶nde m√•ltidet ved basisforbr√¶nding.
</small>
</div>
<div class="btn-row">
<button class="secondary" id="applyRefeedBtn">
üçΩÔ∏è Brug m√•ltid til at forl√¶nge fasen
</button>
</div>
<div class="pill-stat">
<div class="pill-stat-label">Samlet refeed-energi i denne faste</div>
<div class="pill-stat-value">
<strong id="totalRefeedCalories">0</strong> kcal
</div>
</div>
<div class="tiny-note">
Refeed straffer den <em>effektive</em> faste-tid (du ‚Äúryger lidt
tilbage‚Äù), mens aktivitet giver ekstra ‚Äúfastetimer‚Äù som bonus.
</div>
</div>
</div>
</div>

<script>
// === STATE & KONSTANTER ===
const STORAGE_KEY = "fastingAppState_v23";

const state = {
profile: {
ageGroup: "40-49",
gender: "mand",
weight: null,
health: "sund",
},
startTime: null, // timestamp (ms)
manualOffsetHours: 0, // timer inden start (fx "det er 3 timer siden jeg spiste")
isRunning: false,
totalActivityCalories: 0,
totalRefeedCalories: 0,
};

let timerId = null;

// === HJ√ÜLPEFUNKTIONER ===

function saveState() {
try {
localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
} catch (e) {
console.warn("Kunne ikke gemme state", e);
}
}

function loadState() {
try {
const raw = localStorage.getItem(STORAGE_KEY);
if (!raw) return;
const saved = JSON.parse(raw);
if (!saved || typeof saved !== "object") return;

// Merge forsigtigt
if (saved.profile) {
state.profile = {
...state.profile,
...saved.profile,
};
}
if (typeof saved.startTime === "number") {
state.startTime = saved.startTime;
}
if (typeof saved.manualOffsetHours === "number") {
state.manualOffsetHours = saved.manualOffsetHours;
}
if (typeof saved.isRunning === "boolean") {
state.isRunning = saved.isRunning;
}
if (typeof saved.totalActivityCalories === "number") {
state.totalActivityCalories = saved.totalActivityCalories;
}
if (typeof saved.totalRefeedCalories === "number") {
state.totalRefeedCalories = saved.totalRefeedCalories;
}
} catch (e) {
console.warn("Kunne ikke loade state", e);
}
}

function formatHmsFromHours(hours) {
const totalSeconds = Math.max(0, Math.round(hours * 3600));
const h = Math.floor(totalSeconds / 3600);
const m = Math.floor((totalSeconds % 3600) / 60);
const s = totalSeconds % 60;
const pad = (n) => (n < 10 ? "0" + n : "" + n);
return `${pad(h)}:${pad(m)}:${pad(s)}`;
}

function estimateDailyCalories(weightKg, gender, ageGroup) {
if (!weightKg) return null;
let factor = 24; // mand 18-59 ca
if (gender === "kvinde") factor = 22;
if (ageGroup === "60-69") factor -= 1;
if (ageGroup === "70+") factor -= 2;
if (ageGroup === "18-29") factor += 1;
if (ageGroup === "30-39") factor += 0.5;
return Math.round(weightKg * factor);
}

function getPhaseInfo(effHours) {
// Returnerer fase-tekst, emoji og progress 0-1
if (effHours <= 0) {
return {
tag: "Ikke startet",
title: "Ingen faste endnu",
short: "Tryk Start for at g√• i gang.",
emoji: "‚è∏Ô∏è",
progress: 0,
};
}

if (effHours < 4) {
return {
tag: "Lav",
title: "Indledende fase",
short: "Prim√¶rt kulhydratforbr√¶nding ‚Äì du er lige startet.",
emoji: "üü°",
progress: effHours / 16, // relativt til optimal
};
} else if (effHours < 12) {
return {
tag: "P√• vej",
title: "P√• vej mod mere fedtforbr√¶nding",
short:
"Kulhydraterne er ved at t√∏mmes ‚Äì fedtforbr√¶ndingen tager mere over.",
emoji: "üü†",
progress: Math.min(0.6, effHours / 16),
};
} else if (effHours < 20) {
return {
tag: "H√∏j",
title: "H√∏j fedtforbr√¶nding",
short: "Fedt er nu den dominerende energikilde.",
emoji: "üü¢",
progress: Math.min(0.85, effHours / 24),
};
} else if (effHours < 28) {
return {
tag: "Optimal",
title: "Optimal fedtforbr√¶nding",
short:
"Du er i den mest effektive zone for fedtforbr√¶nding og autofagi (modellen).",
emoji: "üíé",
progress: Math.min(1, effHours / 24),
};
} else if (effHours < 36) {
return {
tag: "Over",
title: "Over optimal ‚Äì aftagende fordel",
short:
"Fedtforbr√¶nding er stadig h√∏j, men risiko for muskeltab begynder at stige.",
emoji: "üü†",
progress: 0.9,
};
} else {
return {
tag: "Advarsel",
title: "Lang faste ‚Äì v√¶r forsigtig",
short:
"Modellen antager nu √∏get risiko for muskler og h√•rdt v√¶v. R√•df√∏r dig med l√¶ge.",
emoji: "‚ö†Ô∏è",
progress: 1,
};
}
}

function getFuelMix(effHours) {
// Grove modeller, kun til visualisering
let carb = 0,
fat = 0,
muscle = 0,
bone = 0;

if (effHours <= 0) {
carb = 50;
fat = 50;
} else if (effHours < 4) {
carb = 90;
fat = 10;
} else if (effHours < 12) {
const t = (effHours - 4) / 8;
carb = Math.round(90 - 50 * t);
fat = Math.round(10 + 50 * t);
} else if (effHours < 24) {
const t = (effHours - 12) / 12;
carb = Math.round(40 - 20 * t);
fat = Math.round(60 + 15 * t);
muscle = Math.round(0 + 5 * t);
} else if (effHours < 36) {
const t = (effHours - 24) / 12;
carb = Math.round(20 - 10 * t);
fat = Math.round(75 - 5 * t);
muscle = Math.round(5 + 10 * t);
bone = Math.round(0 + 5 * t);
} else {
carb = 10;
fat = 60;
muscle = 20;
bone = 10;
}

// Normaliser til 100
const sum = carb + fat + muscle + bone;
if (sum > 0) {
carb = Math.round((carb / sum) * 100);
fat = Math.round((fat / sum) * 100);
muscle = Math.round((muscle / sum) * 100);
bone = 100 - carb - fat - muscle;
}

return { carb, fat, muscle, bone };
}

function getMedal(effHours) {
if (effHours < 12) {
return {
emoji: "‚¨ú",
title: "Ingen medalje endnu",
desc: "Fast lidt l√¶ngere for at optjene din f√∏rste medalje.",
};
} else if (effHours < 16) {
return {
emoji: "ü•â",
title: "Bronze-medalje",
desc: "Stabil indsats ‚Äì du har v√¶ret i gang l√¶nge nok til at det m√¶rkes.",
};
} else if (effHours < 22) {
return {
emoji: "ü•à",
title: "S√∏lv-medalje",
desc: "St√¶rkt! Du er i kernesonen for b√•de fedtforbr√¶nding og autofagi.",
};
} else if (effHours < 30) {
return {
emoji: "ü•á",
title: "Guld-medalje",
desc: "Toppr√¶station ‚Äì husk ogs√• at lytte til kroppen.",
};
} else {
return {
emoji: "üèÜ",
title: "Ekstrem faste",
desc: "Det her er for erfarne ‚Äì dr√∏ft altid l√¶ngere faste med l√¶ge.",
};
}
}

// === DOM-REFERENCER ===
const realTimerEl = document.getElementById("realTimer");
const effectiveTimerEl = document.getElementById("effectiveTimer");
const phaseTagEl = document.getElementById("phaseTag");
const phaseTextShortEl = document.getElementById("phaseTextShort");
const phaseTitleEl = document.getElementById("phaseTitle");
const phaseEmojiEl = document.getElementById("phaseEmoji");
const phaseBarFillEl = document.getElementById("phaseBarFill");
const phaseMarkerEl = document.getElementById("phaseMarker");
const timeToOptimalLabelEl = document.getElementById("timeToOptimalLabel");

const carbPercentEl = document.getElementById("carbPercent");
const fatPercentEl = document.getElementById("fatPercent");
const musclePercentEl = document.getElementById("musclePercent");
const bonePercentEl = document.getElementById("bonePercent");
const fatSummaryEl = document.getElementById("fatSummary");

const medalEmojiEl = document.getElementById("medalEmoji");
const medalTitleEl = document.getElementById("medalTitle");
const medalDescEl = document.getElementById("medalDesc");

const weightLossGramsEl = document.getElementById("weightLossGrams");
const weightChipEl = document.getElementById("weightChip");
const autofagiTagEl = document.getElementById("autofagiTag");

const ageGroupEl = document.getElementById("ageGroup");
const genderEl = document.getElementById("gender");
const weightEl = document.getElementById("weight");
const healthEl = document.getElementById("health");

const dailyCaloriesEl = document.getElementById("dailyCalories");
const bmrHourEl = document.getElementById("bmrHour");

const preHoursEl = document.getElementById("preHours");
const startBtnEl = document.getElementById("startBtn");
const resetBtnEl = document.getElementById("resetBtn");

const effectiveHoursLabelEl = document.getElementById("effectiveHoursLabel");
const realHoursLabelEl = document.getElementById("realHoursLabel");

const activityCaloriesEl = document.getElementById("activityCalories");
const addActivityBtnEl = document.getElementById("addActivityBtn");
const totalActivityCaloriesEl = document.getElementById(
"totalActivityCalories"
);

const refeedCaloriesEl = document.getElementById("refeedCalories");
const applyRefeedBtnEl = document.getElementById("applyRefeedBtn");
const totalRefeedCaloriesEl = document.getElementById("totalRefeedCalories");

// === UPDATE UI ===

function updateProfileUI() {
ageGroupEl.value = state.profile.ageGroup || "40-49";
genderEl.value = state.profile.gender || "mand";
healthEl.value = state.profile.health || "sund";
if (state.profile.weight != null) {
weightEl.value = state.profile.weight;
}

const weight = parseFloat(weightEl.value) || null;
const daily = estimateDailyCalories(
weight,
genderEl.value,
ageGroupEl.value
);
if (daily) {
dailyCaloriesEl.textContent = daily.toFixed(0);
bmrHourEl.textContent = (daily / 24).toFixed(0);
} else {
dailyCaloriesEl.textContent = "‚Äì";
bmrHourEl.textContent = "‚Äì";
}

totalActivityCaloriesEl.textContent =
state.totalActivityCalories.toFixed(0);
totalRefeedCaloriesEl.textContent = state.totalRefeedCalories.toFixed(0);
}

function getBmrPerHour() {
const weight = parseFloat(weightEl.value) || null;
const daily = estimateDailyCalories(
weight,
genderEl.value,
ageGroupEl.value
);
if (!daily) return null;
return daily / 24;
}

function computeTimes() {
if (!state.startTime) {
return {
realHours: 0,
effHours: 0,
bmrPerHour: getBmrPerHour(),
sportBonusHours: 0,
refeedPenaltyHours: 0,
totalCaloriesBurned: 0,
fatLossGrams: 0,
};
}
const now = Date.now();
const elapsedMs = now - state.startTime;
const elapsedHours = Math.max(0, elapsedMs / 3600000);
const realHours = elapsedHours + (state.manualOffsetHours || 0);

const bmrPerHour = getBmrPerHour();
let sportBonusHours = 0;
let refeedPenaltyHours = 0;
if (bmrPerHour && bmrPerHour > 0) {
sportBonusHours = state.totalActivityCalories / bmrPerHour;
// Refeed: straf = 2x tid, det ville tage at forbr√¶nde m√•ltidet
refeedPenaltyHours = (state.totalRefeedCalories / bmrPerHour) * 2;
}

let effHours = realHours + sportBonusHours - refeedPenaltyHours;
if (!isFinite(effHours) || effHours < 0) effHours = 0;

// Simpelt v√¶gttabs-estimat:
// - Kalorieunderskud = (realHours * bmrPerHour) + sport - refeed
// - 7700 kcal ~ 1 kg fedt
let totalCaloriesBurned = 0;
if (bmrPerHour && bmrPerHour > 0) {
totalCaloriesBurned =
realHours * bmrPerHour +
state.totalActivityCalories -
state.totalRefeedCalories;
}
let fatLossKg = 0;
if (totalCaloriesBurned > 0) {
fatLossKg = totalCaloriesBurned / 7700;
}
const fatLossGrams = Math.max(0, fatLossKg * 1000);

return {
realHours,
effHours,
bmrPerHour,
sportBonusHours,
refeedPenaltyHours,
totalCaloriesBurned,
fatLossGrams,
};
}

function updateUI() {
updateProfileUI();

const {
realHours,
effHours,
bmrPerHour,
sportBonusHours,
refeedPenaltyHours,
fatLossGrams,
} = computeTimes();

realTimerEl.textContent = formatHmsFromHours(realHours);
effectiveTimerEl.textContent = formatHmsFromHours(effHours);

effectiveHoursLabelEl.textContent = effHours.toFixed(1);
realHoursLabelEl.textContent = realHours.toFixed(1);

weightLossGramsEl.textContent = fatLossGrams.toFixed(0);

// Phase info
const phase = getPhaseInfo(effHours);
phaseTagEl.textContent = phase.tag;
phaseTitleEl.textContent = phase.title;
phaseTextShortEl.textContent = phase.short;
phaseEmojiEl.textContent = phase.emoji;

// Phase-bar
const p = Math.max(0, Math.min(1, phase.progress));
phaseBarFillEl.style.transform = `scaleX(${1 - p})`;
const markerPos = p * 100;
phaseMarkerEl.style.left = `${markerPos}%`;

// Tid til optimal
const targetOptimal = 20; // ca. midten af optimal
if (effHours < targetOptimal) {
const diff = targetOptimal - effHours;
timeToOptimalLabelEl.textContent =
diff.toFixed(1) + " t til optimal fedtforbr√¶nding (model)";
} else {
timeToOptimalLabelEl.textContent =
"Du har passeret den optimale zone (modellen) ‚Äì effekten kan v√¶re aftagende.";
}

// Fuel mix
const mix = getFuelMix(effHours);
carbPercentEl.textContent = mix.carb + "%";
fatPercentEl.textContent = mix.fat + "%";
musclePercentEl.textContent = mix.muscle + "%";
bonePercentEl.textContent = mix.bone + "%";

let mainSource = "fedt";
if (mix.carb >= mix.fat && mix.carb >= mix.muscle) mainSource = "kulhydrat";
if (mix.muscle >= mix.carb && mix.muscle >= mix.fat) mainSource = "muskler";
if (mix.bone >= mix.carb && mix.bone >= mix.fat && mix.bone >= mix.muscle)
mainSource = "h√•rdt v√¶v";

fatSummaryEl.textContent =
"Modellen vurderer, at " +
mix.fat +
"% kommer fra fedt, " +
mix.carb +
"% fra kulhydrat.";

// Medalje
const medal = getMedal(effHours);
medalEmojiEl.textContent = medal.emoji;
medalTitleEl.textContent = medal.title;
medalDescEl.textContent = medal.desc;

// Autofagi
if (effHours >= 16) {
autofagiTagEl.style.display = "inline-flex";
} else {
autofagiTagEl.style.display = "none";
}

// Juster v√¶gt-chip visuel hvis v√¶gttab > 0
if (fatLossGrams > 0) {
weightChipEl.style.opacity = "1";
weightChipEl.style.transform = "scale(1)";
} else {
weightChipEl.style.opacity = "0.7";
weightChipEl.style.transform = "scale(0.98)";
}
}

// === TIMER ===
function startTimerLoop() {
if (timerId != null) clearInterval(timerId);
timerId = setInterval(updateUI, 1000);
updateUI();
}

function stopTimerLoop() {
if (timerId != null) {
clearInterval(timerId);
timerId = null;
}
}

// === H√ÖNDTERING AF INPUTS ===

function onProfileChange() {
state.profile.ageGroup = ageGroupEl.value;
state.profile.gender = genderEl.value;
state.profile.health = healthEl.value;
const w = parseFloat(weightEl.value);
state.profile.weight = isNaN(w) ? null : w;
saveState();
updateUI();
}

ageGroupEl.addEventListener("change", onProfileChange);
genderEl.addEventListener("change", onProfileChange);
healthEl.addEventListener("change", onProfileChange);
weightEl.addEventListener("input", onProfileChange);

// START / FORTS√ÜT
startBtnEl.addEventListener("click", () => {
// Hvis der ikke er en startTime endnu, initialiser
if (!state.startTime) {
const pre = parseFloat(preHoursEl.value);
state.manualOffsetHours = isNaN(pre) ? 0 : Math.max(0, pre);
state.startTime = Date.now();
} else {
// Hvis der er √¶ndret i preHours efterf√∏lgende, l√¶g det til manuel offset
const pre = parseFloat(preHoursEl.value);
if (!isNaN(pre) && pre > 0) {
state.manualOffsetHours += pre;
preHoursEl.value = "";
}
}
state.isRunning = true;
saveState();
startTimerLoop();
});

// NULSTIL
resetBtnEl.addEventListener("click", () => {
if (
!confirm(
"Er du sikker p√•, at du vil nulstille fasen? Alle data for denne faste slettes."
)
) {
return;
}
stopTimerLoop();
state.startTime = null;
state.manualOffsetHours = 0;
state.isRunning = false;
state.totalActivityCalories = 0;
state.totalRefeedCalories = 0;
saveState();
preHoursEl.value = "";
activityCaloriesEl.value = "";
refeedCaloriesEl.value = "";
updateUI();
});

// AKTIVITET
addActivityBtnEl.addEventListener("click", () => {
const val = parseFloat(activityCaloriesEl.value);
if (isNaN(val) || val <= 0) {
alert("Skriv et antal kalorier forbr√¶ndt ved aktivitet f√∏rst.");
return;
}
state.totalActivityCalories += val;
activityCaloriesEl.value = "";
saveState();
updateUI();
});

// REFEED
applyRefeedBtnEl.addEventListener("click", () => {
const val = parseFloat(refeedCaloriesEl.value);
if (isNaN(val) || val <= 0) {
alert("Skriv et kalorie-anslag for m√•ltidet f√∏rst.");
return;
}
// Modellen tillader kun √©t refeed ‚Äì eller akkumulerer meget forsigtigt
state.totalRefeedCalories += val;
refeedCaloriesEl.value = "";
saveState();
updateUI();
});

// === INIT ===
loadState();
updateProfileUI();

if (state.startTime && state.isRunning) {
startTimerLoop();
} else if (state.startTime && !state.isRunning) {
// Faste sat, men ikke k√∏rende ‚Äì opdater blot √©n gang
updateUI();
} else {
updateUI();
}
</script>
</body>
</html>
