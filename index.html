<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8" />
<title>FasteTracker v34 (fix)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
:root {
--bg: #050810;
--card-bg: #0d111c;
--card-alt: #111725;
--accent: #5b8cff;
--accent-soft: #3b6fe0;
--text: #f5f7ff;
--text-soft: #c3c9e5;
--danger: #ff4b6a;
--success: #2ecc71;
--warning: #ffba3a;
--border-subtle: rgba(255,255,255,0.05);
--fat: #41d37e;
--carb: #ffb347;
--muscle: #ff7eb3;
--bone: #ff3b3b;
}

* { box-sizing: border-box; }

body {
margin: 0;
font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
background: radial-gradient(circle at top, #1a2340 0%, #050810 55%);
color: var(--text);
-webkit-font-smoothing: antialiased;
}

.app {
max-width: 900px;
margin: 0 auto;
padding: 1rem 1rem 3rem;
}

h1 {
font-size: 1.4rem;
margin: 0 0 0.5rem;
display: flex;
align-items: center;
gap: 0.4rem;
}

h1 span.emoji { font-size: 1.6rem; }

.subtitle {
font-size: 0.85rem;
color: var(--text-soft);
margin-bottom: 1.2rem;
}

.grid {
display: grid;
grid-template-columns: minmax(0, 2fr) minmax(0, 3fr);
gap: 1rem;
}

@media (max-width: 720px) {
.grid { grid-template-columns: 1fr; }
}

.card {
background: linear-gradient(145deg, rgba(255,255,255,0.02), rgba(0,0,0,0.6));
border-radius: 18px;
padding: 0.9rem 1rem;
border: 1px solid var(--border-subtle);
box-shadow: 0 22px 60px rgba(0,0,0,0.65);
backdrop-filter: blur(16px);
}

.card-header {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 0.4rem;
gap: 0.5rem;
}

.card-title {
font-size: 0.9rem;
font-weight: 600;
display: flex;
align-items: center;
gap: 0.35rem;
}

.chip {
display: inline-flex;
align-items: center;
gap: 0.25rem;
padding: 0.12rem 0.5rem;
border-radius: 999px;
font-size: 0.7rem;
background: rgba(255,255,255,0.05);
border: 1px solid rgba(255,255,255,0.08);
color: var(--text-soft);
}

.chip span.emoji { font-size: 0.9rem; }

/* V√¶gt + tid */
.weight-card-main {
display: flex;
align-items: center;
justify-content: space-between;
gap: 0.75rem;
}

.weight-icon {
width: 68px;
height: 68px;
border-radius: 18px;
background: radial-gradient(circle at 30% 20%, #88ffb7 0%, #189a52 35%, #072213 100%);
display: flex;
align-items: center;
justify-content: center;
box-shadow: 0 12px 30px rgba(0,0,0,0.7);
flex-shrink: 0;
}

.weight-icon span { font-size: 2.1rem; }

.weight-info-main { flex: 1; }

.weight-line {
display: flex;
align-items: baseline;
gap: 0.6rem;
flex-wrap: wrap;
}

.weight-value {
font-size: 1.9rem;
font-weight: 700;
line-height: 1.1;
}

.weight-unit {
font-size: 0.9rem;
opacity: 0.85;
}

.main-time-big {
font-size: 1.1rem;
color: var(--text-soft);
}

.main-time-big span {
font-weight: 600;
color: var(--text);
margin-left: 0.15rem;
font-size: 1.05rem;
}

.weight-sub {
margin-top: 0.25rem;
font-size: 0.78rem;
color: var(--text-soft);
}

.time-row {
display: flex;
flex-wrap: wrap;
gap: 0.35rem;
font-size: 0.82rem;
margin-top: 0.45rem;
}

.time-pill {
padding: 0.18rem 0.55rem;
border-radius: 999px;
background: rgba(255,255,255,0.03);
border: 1px solid rgba(255,255,255,0.06);
color: var(--text-soft);
}

.time-pill strong {
color: var(--text);
font-weight: 600;
}

/* Energifordeling */
.energy-grid {
display: grid;
grid-template-columns: repeat(2, minmax(0, 1fr));
gap: 0.45rem;
margin-top: 0.6rem;
}

.energy-item {
padding: 0.4rem 0.5rem;
border-radius: 10px;
background: rgba(0,0,0,0.45);
border: 1px solid rgba(255,255,255,0.06);
font-size: 0.76rem;
display: flex;
flex-direction: column;
gap: 0.15rem;
}

.energy-label {
display: flex;
justify-content: space-between;
align-items: center;
}

.energy-name {
display: inline-flex;
align-items: center;
gap: 0.3rem;
}

.color-dot {
width: 9px;
height: 9px;
border-radius: 50%;
}

.color-fat { background: var(--fat); }
.color-carb { background: var(--carb); }
.color-muscle { background: var(--muscle); }
.color-bone { background: var(--bone); }

.energy-bar {
position: relative;
margin-top: 0.15rem;
height: 4px;
border-radius: 999px;
background: rgba(255,255,255,0.06);
overflow: hidden;
}

.energy-fill {
position: absolute;
inset: 0;
border-radius: inherit;
transform-origin: left center;
transform: scaleX(0.2);
}

.energy-fat-fill { background: var(--fat); }
.energy-carb-fill { background: var(--carb); }
.energy-muscle-fill { background: var(--muscle); }
.energy-bone-fill { background: var(--bone); }

/* Speedometer ‚Äì Apple-style */
.gauge-card {
display: flex;
flex-direction: column;
gap: 0.6rem;
}

.gauge-svg-wrap {
margin-top: 0.2rem;
}

.gauge-label-row {
display: flex;
justify-content: space-between;
align-items: center;
font-size: 0.78rem;
color: var(--text-soft);
margin-bottom: 0.25rem;
}

.gauge-label-row strong { color: var(--text); }

.gauge-svg {
position: relative;
width: 100%;
padding-top: 55%; /* aspect ratio for halvcirkel */
}

.gauge-svg svg {
position: absolute;
inset: 0;
}

.gauge-needle {
position: absolute;
bottom: 6%;
left: 50%;
width: 2px;
height: 46%;
background: #ffffff;
transform-origin: bottom center;
transform: translateX(-50%) rotate(-120deg);
box-shadow: 0 0 10px rgba(255,255,255,0.9);
border-radius: 999px;
transition: transform 0.25s ease-out;
}

.gauge-center {
position: absolute;
bottom: 5%;
left: 50%;
width: 16px;
height: 16px;
border-radius: 50%;
transform: translate(-50%, 50%);
background: radial-gradient(circle at 30% 30%, #ffffff 0%, #d0d4ff 30%, #6069ff 100%);
box-shadow: 0 0 12px rgba(255,255,255,0.8);
}

.gauge-scale-row {
display: flex;
justify-content: space-between;
font-size: 0.7rem;
color: var(--text-soft);
margin-top: 0.25rem;
}

.boost-text {
font-weight: 600;
color: var(--success);
}

.boost-text.low { color: var(--text-soft); }

.boost-text.negative { color: var(--danger); }

/* Badges */
.badge-row {
display: flex;
flex-wrap: wrap;
gap: 0.5rem;
font-size: 0.75rem;
}

.badge {
display: inline-flex;
align-items: center;
gap: 0.35rem;
padding: 0.2rem 0.6rem;
border-radius: 999px;
background: rgba(255,255,255,0.05);
border: 1px solid rgba(255,255,255,0.1);
color: var(--text-soft);
opacity: 0.55;
}

.badge span.emoji { font-size: 1rem; }

.badge.active {
opacity: 1;
color: #fff;
box-shadow: 0 0 18px rgba(255,255,255,0.25);
animation: pulseBadge 2s infinite ease-in-out;
}

.badge-faste.active {
background: radial-gradient(circle at 20% 0%, #ffe27a 0%, #ff9f43 35%, #b35a00 100%);
border-color: rgba(255,255,255,0.4);
}

.badge-auto.active {
background: radial-gradient(circle at 20% 0%, #9cfffa 0%, #33c1aa 40%, #0b5446 100%);
border-color: rgba(255,255,255,0.4);
}

@keyframes pulseBadge {
0% { transform: scale(1); box-shadow: 0 0 8px rgba(255,255,255,0.25); }
50% { transform: scale(1.04); box-shadow: 0 0 18px rgba(255,255,255,0.55); }
100% { transform: scale(1); box-shadow: 0 0 8px rgba(255,255,255,0.25); }
}

.autofagi-countdown {
font-size: 0.78rem;
color: var(--text-soft);
display: inline-flex;
align-items: center;
gap: 0.3rem;
margin-top: 0.3rem;
}

.autofagi-countdown span.emoji { font-size: 1rem; }

/* Profil / setup */
.setup-card { margin-top: 1rem; }

.setup-grid {
display: grid;
grid-template-columns: repeat(2, minmax(0, 1fr));
gap: 0.5rem;
}

@media (max-width: 720px) {
.setup-grid { grid-template-columns: 1fr; }
}

label {
font-size: 0.74rem;
color: var(--text-soft);
display: block;
margin-bottom: 0.18rem;
}

input[type="number"],
select,
input[type="text"] {
width: 100%;
padding: 0.38rem 0.5rem;
border-radius: 9px;
border: 1px solid rgba(255,255,255,0.14);
background: rgba(0,0,0,0.65);
color: var(--text);
font-size: 0.8rem;
outline: none;
}

input::placeholder { color: rgba(255,255,255,0.35); }

.help-row {
margin-top: 0.25rem;
font-size: 0.7rem;
color: var(--text-soft);
}

.controls {
display: flex;
flex-wrap: wrap;
gap: 0.4rem;
margin-top: 0.7rem;
}

button {
border-radius: 999px;
border: none;
font-size: 0.8rem;
padding: 0.42rem 0.9rem;
cursor: pointer;
display: inline-flex;
align-items: center;
gap: 0.35rem;
background: var(--accent-soft);
color: #fff;
box-shadow: 0 8px 26px rgba(9, 76, 255, 0.45);
transition: transform 0.08s ease-out, box-shadow 0.08s ease-out, opacity 0.08s;
}

button:active {
transform: translateY(1px) scale(0.98);
box-shadow: 0 4px 14px rgba(0,0,0,0.7);
}

button.secondary {
background: rgba(255,255,255,0.06);
color: var(--text-soft);
box-shadow: none;
border: 1px solid rgba(255,255,255,0.1);
}

button.danger {
background: rgba(255,75,106,0.9);
box-shadow: 0 8px 24px rgba(255,75,106,0.55);
}

button:disabled {
opacity: 0.4;
cursor: default;
box-shadow: none;
}

.subgrid {
display: grid;
grid-template-columns: repeat(2, minmax(0, 1fr));
gap: 0.6rem;
margin-top: 0.6rem;
}

@media (max-width: 720px) {
.subgrid { grid-template-columns: 1fr; }
}

.small-note {
font-size: 0.7rem;
color: var(--text-soft);
margin-top: 0.25rem;
}
</style>
</head>
<body>
<div class="app">
<h1>
<span class="emoji">‚è±Ô∏è</span>
FasteTracker v34 (fix)
</h1>
<div class="subtitle">
Live-tracker for faste, v√¶gttab og fedtforbr√¶nding ‚Äì med aktivitet, refeed, autofagi og Apple-style gauge.
</div>

<div class="grid">
<!-- VENSTRE: v√¶gt + energikilder -->
<div class="card">
<div class="card-header">
<div class="card-title">
<span class="emoji">‚öñÔ∏è</span>
Samlet v√¶gttab i denne faste
</div>
</div>

<div class="weight-card-main">
<div class="weight-icon">
<span>üèãÔ∏è‚Äç‚ôÇÔ∏è</span>
</div>
<div class="weight-info-main">
<div class="weight-line">
<div class="weight-value">
<span id="weightLossGrams">0</span><span class="weight-unit"> g</span>
</div>
<div class="main-time-big">
Tid i faste:
<span id="mainTimeText">00:00:00</span>
</div>
</div>
<div class="weight-sub">
Estimeret tab pga. kalorieunderskud og fedtandel. (Modellen er vejledende, ikke medicinsk pr√¶cis.)
</div>
</div>
</div>

<div class="time-row">
<div class="time-pill">
Reelt i faste: <strong><span id="realTimeText">00:00:00</span></strong>
</div>
<div class="time-pill">
Effektiv fastetid: <strong><span id="effectiveTimeText">0,0</span> t</strong>
</div>
<div class="time-pill">
BMR ca.: <strong><span id="bmrText">‚Äì</span> kcal/d√∏gn</strong>
</div>
</div>

<div class="card-header" style="margin-top:0.6rem;">
<div class="card-title">
<span class="emoji">‚ö°</span>
Energikilder lige nu
</div>
</div>
<div class="energy-grid">
<div class="energy-item">
<div class="energy-label">
<div class="energy-name">
<span class="color-dot color-fat"></span>
Fedt
</div>
<span id="fatPct">0%</span>
</div>
<div class="energy-bar">
<div class="energy-fill energy-fat-fill" id="fatBar"></div>
</div>
</div>

<div class="energy-item">
<div class="energy-label">
<div class="energy-name">
<span class="color-dot color-carb"></span>
Kulhydrat
</div>
<span id="carbPct">0%</span>
</div>
<div class="energy-bar">
<div class="energy-fill energy-carb-fill" id="carbBar"></div>
</div>
</div>

<div class="energy-item">
<div class="energy-label">
<div class="energy-name">
<span class="color-dot color-muscle"></span>
Muskler
</div>
<span id="musclePct">0%</span>
</div>
<div class="energy-bar">
<div class="energy-fill energy-muscle-fill" id="muscleBar"></div>
</div>
</div>

<div class="energy-item">
<div class="energy-label">
<div class="energy-name">
<span class="color-dot color-bone"></span>
Knogler
</div>
<span id="bonePct">0%</span>
</div>
<div class="energy-bar">
<div class="energy-fill energy-bone-fill" id="boneBar"></div>
</div>
</div>
</div>
</div>

<!-- H√òJRE: speedometer + badges -->
<div class="card">
<div class="card-header">
<div class="card-title">
<span class="emoji">üèéÔ∏è</span>
Fedtforbr√¶ndings-boost
</div>
<div class="chip">
<span class="emoji">üî•</span>
Live fat-burn
</div>
</div>

<div class="gauge-card">
<div class="gauge-svg-wrap">
<div class="gauge-label-row">
<span>Fedtandel lige nu:</span>
<span><strong id="fatPercentLabel">0%</strong></span>
</div>
<div class="gauge-svg">
<svg viewBox="0 0 200 110" preserveAspectRatio="xMidYMid meet">
<defs>
<linearGradient id="gaugeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
<stop offset="0%" stop-color="#4fb1ff"/>
<stop offset="35%" stop-color="#41d37e"/>
<stop offset="70%" stop-color="#ffba3a"/>
<stop offset="100%" stop-color="#ff4b6a"/>
</linearGradient>
</defs>
<!-- baggrundsbue -->
<path d="M 20 100 A 80 80 0 0 1 180 100"
fill="none"
stroke="rgba(255,255,255,0.12)"
stroke-width="16"
stroke-linecap="round" />
<!-- farvebue -->
<path d="M 20 100 A 80 80 0 0 1 180 100"
fill="none"
stroke="url(#gaugeGradient)"
stroke-width="10"
stroke-linecap="round" />
</svg>
<div class="gauge-needle" id="gaugeNeedle"></div>
<div class="gauge-center"></div>
</div>
<div class="gauge-scale-row">
<span>Lav</span>
<span>Mellem</span>
<span>H√∏j</span>
<span>Max</span>
</div>
</div>

<div class="gauge-label-row" style="margin-top:0.4rem;">
<span>Fedt-boost (ifht. hverdag):</span>
<span class="boost-text" id="boostText">1,0√ó</span>
</div>

<div class="badge-row">
<div class="badge badge-faste" id="badgeFaste">
<span class="emoji">ü•á</span>
Officielt i faste (12+ t)
</div>
<div class="badge badge-auto" id="badgeAuto">
<span class="emoji">ü©∫</span>
Autofagi aktiv (16+ t)
</div>
</div>

<div class="autofagi-countdown" id="autoCountdown">
<span class="emoji">‚è≥</span>
<span>Autofagi om: <strong><span id="autoCountdownText">‚Äì</span></strong></span>
</div>
</div>
</div>
</div>

<!-- SETUP / PROFIL -->
<div class="card setup-card">
<div class="card-header">
<div class="card-title">
<span class="emoji">üë§</span>
Din profil & opstart
</div>
</div>

<div class="setup-grid">
<div>
<label for="gender">K√∏n</label>
<select id="gender">
<option value="male">Mand</option>
<option value="female">Kvinde</option>
<option value="other">Andet / vil ikke sige</option>
</select>
</div>
<div>
<label for="age">Alder (√•r)</label>
<input type="number" id="age" min="15" max="90" value="40" />
</div>
<div>
<label for="weight">V√¶gt (kg)</label>
<input type="number" id="weight" min="40" max="200" value="80" />
</div>
<div>
<label for="muscle">Muskelmasse / kropstype</label>
<select id="muscle">
<option value="low">Lav / lidt muskelmasse</option>
<option value="normal" selected>Normal</option>
<option value="fit">Fit / tr√¶ner j√¶vnligt</option>
<option value="very_muscular">Meget muskul√∏s</option>
</select>
</div>
<div>
<label for="alreadyHours">Allerede i gang? (timer siden sidste m√•ltid)</label>
<input type="number" id="alreadyHours" min="0" step="0.5" placeholder="0" />
<div class="help-row">
Bruges kun ved opstart ‚Äì hvor l√¶nge siden er sidste m√•ltid?
</div>
</div>
</div>

<div class="controls">
<button id="startBtn">
<span class="emoji">‚ñ∂Ô∏è</span>
Start faste
</button>
<button class="secondary" id="stopBtn" disabled>
<span class="emoji">‚èπÔ∏è</span>
Stop faste
</button>
<button class="secondary" id="resetBtn">
<span class="emoji">üßπ</span>
Nulstil alt
</button>
</div>

<div class="subgrid">
<div>
<label for="activityKcal">Tilf√∏j aktivitet (kcal br√¶ndt)</label>
<input type="number" id="activityKcal" min="0" step="10" placeholder="fx 400" />
<button class="secondary" id="addActivityBtn" style="margin-top:0.4rem;">
‚ûï L√¶g til aktivitet
</button>
<div class="small-note">
Samlet aktivitet: <strong><span id="totalActivityKcal">0</span> kcal</strong>
</div>
</div>
<div>
<label for="refeedKcal">Lille m√•ltid (refeed, kcal)</label>
<input type="number" id="refeedKcal" min="0" step="10" placeholder="fx 300" />
<button class="secondary" id="applyRefeedBtn" style="margin-top:0.4rem;">
üçΩ Registr√©r refeed
</button>
<div class="small-note">
Estimeret ‚Äústraftid‚Äù fra refeed: <strong><span id="refeedPenaltyText">0,0</span> t</strong>
</div>
</div>
</div>
</div>
</div>

<script>
const STORAGE_KEY = "fastingTracker_v34_fix";

let state = {
isFasting: false,
startTimestamp: null,
alreadyHours: 0,
profile: {
gender: "male",
age: 40,
weight: 80,
muscle: "normal"
},
bmrPerDay: 0,
totalActivityKcal: 0,
refeedKcal: 0,
cumulativeFatEnergyKcal: 0,
lastUpdateTimestamp: null
};

function saveState() {
try {
localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
} catch (e) {}
}

function loadState() {
try {
const raw = localStorage.getItem(STORAGE_KEY);
if (!raw) return;
const parsed = JSON.parse(raw);
if (!parsed || typeof parsed !== "object") return;
state = { ...state, ...parsed };
} catch (e) {}
}

loadState();

// DOM refs
const weightLossGramsEl = document.getElementById("weightLossGrams");
const mainTimeTextEl = document.getElementById("mainTimeText");
const realTimeTextEl = document.getElementById("realTimeText");
const effectiveTimeTextEl = document.getElementById("effectiveTimeText");
const bmrTextEl = document.getElementById("bmrText");

const fatPctEl = document.getElementById("fatPct");
const carbPctEl = document.getElementById("carbPct");
const musclePctEl = document.getElementById("musclePct");
const bonePctEl = document.getElementById("bonePct");

const fatBarEl = document.getElementById("fatBar");
const carbBarEl = document.getElementById("carbBar");
const muscleBarEl = document.getElementById("muscleBar");
const boneBarEl = document.getElementById("boneBar");

const gaugeNeedleEl = document.getElementById("gaugeNeedle");
const fatPercentLabelEl = document.getElementById("fatPercentLabel");
const boostTextEl = document.getElementById("boostText");

const badgeFasteEl = document.getElementById("badgeFaste");
const badgeAutoEl = document.getElementById("badgeAuto");
const autoCountdownTextEl = document.getElementById("autoCountdownText");

const genderEl = document.getElementById("gender");
const ageEl = document.getElementById("age");
const weightEl = document.getElementById("weight");
const muscleEl = document.getElementById("muscle");
const alreadyHoursEl = document.getElementById("alreadyHours");

const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const resetBtn = document.getElementById("resetBtn");

const activityKcalEl = document.getElementById("activityKcal");
const addActivityBtn = document.getElementById("addActivityBtn");
const totalActivityKcalEl = document.getElementById("totalActivityKcal");

const refeedKcalEl = document.getElementById("refeedKcal");
const applyRefeedBtn = document.getElementById("applyRefeedBtn");
const refeedPenaltyTextEl = document.getElementById("refeedPenaltyText");

function computeBmrFromProfile(profile) {
const weight = profile.weight || 80;
const age = profile.age || 40;
const gender = profile.gender || "male";
const muscle = profile.muscle || "normal";

let base = 24 * weight; // udgangspunkt

let genderFactor = 1.0;
if (gender === "male") genderFactor = 1.05;
else if (gender === "female") genderFactor = 0.95;
base *= genderFactor;

if (age > 50 && age <= 60) base *= 0.96;
else if (age > 60) base *= 0.92;

let muscleFactor = 1.0;
if (muscle === "low") muscleFactor = 0.9;
else if (muscle === "normal") muscleFactor = 1.0;
else if (muscle === "fit") muscleFactor = 1.08;
else if (muscle === "very_muscular") muscleFactor = 1.16;

base *= muscleFactor;
return base;
}

function formatHMSFromSeconds(totalSec) {
totalSec = Math.max(0, Math.floor(totalSec));
const h = Math.floor(totalSec / 3600);
const m = Math.floor((totalSec % 3600) / 60);
const s = totalSec % 60;
const pad = v => String(v).padStart(2, "0");
return `${pad(h)}:${pad(m)}:${pad(s)}`;
}

function formatHoursOneDecimal(h) {
return (Math.round(h * 10) / 10).toFixed(1).replace(".", ",");
}

function getEnergyFractions(effectiveHours) {
let carbs = 0.7;
let fat = 0.3;
let muscle = 0.0;
let bone = 0.0;

if (effectiveHours <= 0) {
carbs = 0.9; fat = 0.1;
} else if (effectiveHours <= 4) {
const t = effectiveHours / 4;
carbs = 0.9 - 0.2 * t;
fat = 0.1 + 0.2 * t;
} else if (effectiveHours <= 12) {
const t = (effectiveHours - 4) / 8;
carbs = 0.7 - 0.4 * t;
fat = 0.3 + 0.5 * t;
} else if (effectiveHours <= 24) {
const t = (effectiveHours - 12) / 12;
carbs = 0.3 - 0.25 * t;
fat = 0.8 + 0.1 * t;
muscle = 0.0 + 0.05 * t;
} else if (effectiveHours <= 40) {
const t = (effectiveHours - 24) / 16;
carbs = 0.05 - 0.05 * t;
fat = 0.9 - 0.1 * t;
muscle = 0.05 + 0.05 * t;
bone = 0.0 + 0.02 * t;
} else {
carbs = 0.0;
fat = 0.7;
muscle = 0.2;
bone = 0.1;
}

const sum = carbs + fat + muscle + bone;
if (sum > 0) {
carbs /= sum;
fat /= sum;
muscle /= sum;
bone /= sum;
}

return { carbs, fat, muscle, bone };
}

function updateProfileFromUI() {
const gender = genderEl.value;
const age = Number(ageEl.value) || 40;
const weight = Number(weightEl.value) || 80;
const muscleType = muscleEl.value;

state.profile = { gender, age, weight, muscle: muscleType };
state.alreadyHours = Number(alreadyHoursEl.value) || 0;
state.bmrPerDay = computeBmrFromProfile(state.profile);
}

function computeTimes(now, bmrPerHour) {
let realHours = 0;
if (state.isFasting && state.startTimestamp) {
const elapsedMs = now - state.startTimestamp;
const elapsedHours = elapsedMs / 3600000;
realHours = Math.max(0, elapsedHours + state.alreadyHours);
}

const hoursFromActivity = state.totalActivityKcal / (bmrPerHour || 1);
const hoursPenaltyFromRefeed = (state.refeedKcal / (bmrPerHour || 1)) * 2;
const effectiveHours = Math.max(0, realHours + hoursFromActivity - hoursPenaltyFromRefeed);

return { realHours, effectiveHours, hoursFromActivity, hoursPenaltyFromRefeed };
}

function updateUI() {
updateProfileFromUI();
const bmr = state.bmrPerDay || computeBmrFromProfile(state.profile);
state.bmrPerDay = bmr;
const bmrPerHour = bmr / 24;
const now = Date.now();

const { realHours, effectiveHours } = computeTimes(now, bmrPerHour);

const fatEnergy = Math.max(0, state.cumulativeFatEnergyKcal || 0);
const fatGrams = fatEnergy / 7700 * 1000;

weightLossGramsEl.textContent = Math.round(fatGrams);

const realSeconds = state.isFasting && state.startTimestamp
? (now - state.startTimestamp) / 1000 + state.alreadyHours * 3600
: 0;
const mainTimeStr = formatHMSFromSeconds(realSeconds);
mainTimeTextEl.textContent = mainTimeStr;
realTimeTextEl.textContent = mainTimeStr;

effectiveTimeTextEl.textContent = formatHoursOneDecimal(effectiveHours);
bmrTextEl.textContent = Math.round(bmr);

const fractions = getEnergyFractions(effectiveHours);

const pctFat = Math.round(fractions.fat * 100);
const pctCarb = Math.round(fractions.carb * 100);
const pctMuscle = Math.round(fractions.muscle * 100);
const pctBone = Math.round(fractions.bone * 100);

fatPctEl.textContent = pctFat + "%";
carbPctEl.textContent = pctCarb + "%";
musclePctEl.textContent = pctMuscle + "%";
bonePctEl.textContent = pctBone + "%";

fatBarEl.style.transform = "scaleX(" + (fractions.fat || 0) + ")";
carbBarEl.style.transform = "scaleX(" + (fractions.carb || 0) + ")";
muscleBarEl.style.transform = "scaleX(" + (fractions.muscle || 0) + ")";
boneBarEl.style.transform = "scaleX(" + (fractions.bone || 0) + ")";

// Gauge
fatPercentLabelEl.textContent = pctFat + "%";
const fillScale = Math.min(1, Math.max(0, fractions.fat));
const angle = -120 + fillScale * 240; // -120¬∞ til +120¬∞
gaugeNeedleEl.style.transform = "translateX(-50%) rotate(" + angle.toFixed(1) + "deg)";

let boost = fractions.fat / 0.15;
if (!isFinite(boost) || boost < 0) boost = 0;
boost = Math.max(0.2, boost);
const boostRounded = Math.round(boost * 10) / 10;
boostTextEl.textContent = boostRounded.toFixed(1).replace(".", ",") + "√ó";
boostTextEl.classList.remove("low", "negative");
if (boostRounded < 1.0) boostTextEl.classList.add("low");

// Badges
if (effectiveHours >= 12) {
badgeFasteEl.classList.add("active");
} else {
badgeFasteEl.classList.remove("active");
}

if (effectiveHours >= 16) {
badgeAutoEl.classList.add("active");
} else {
badgeAutoEl.classList.remove("active");
}

// Autofagi countdown
if (effectiveHours < 16) {
const remainingH = 16 - effectiveHours;
const totalSec = remainingH * 3600;
autoCountdownTextEl.textContent = formatHMSFromSeconds(totalSec);
} else {
autoCountdownTextEl.textContent = "Aktiv ‚úÖ";
}

// Aktivitet / refeed UI
totalActivityKcalEl.textContent = Math.round(state.totalActivityKcal);
const penaltyHours = state.refeedKcal > 0 ? (state.refeedKcal / (bmrPerHour || 1)) * 2 : 0;
refeedPenaltyTextEl.textContent = formatHoursOneDecimal(penaltyHours);

// Knapper
if (state.isFasting) {
startBtn.disabled = true;
stopBtn.disabled = false;
} else {
startBtn.disabled = false;
stopBtn.disabled = true;
}

saveState();
}

function tick() {
const now = Date.now();
if (!state.isFasting || !state.startTimestamp) {
state.lastUpdateTimestamp = now;
return;
}

if (!state.lastUpdateTimestamp) {
state.lastUpdateTimestamp = now;
return;
}

let dtHours = (now - state.lastUpdateTimestamp) / 3600000;
if (dtHours <= 0) {
state.lastUpdateTimestamp = now;
return;
}
if (dtHours > 0.5) dtHours = 0.5;

state.lastUpdateTimestamp = now;

const bmr = state.bmrPerDay || computeBmrFromProfile(state.profile);
const bmrPerHour = bmr / 24;
const { effectiveHours } = computeTimes(now, bmrPerHour);
const fractions = getEnergyFractions(effectiveHours);

const deltaKcal = bmrPerHour * dtHours;
state.cumulativeFatEnergyKcal = (state.cumulativeFatEnergyKcal || 0) + deltaKcal * fractions.fat;

saveState();
}

let timerId = null;
function startLoop() {
if (timerId) return;
timerId = setInterval(() => {
tick();
updateUI();
}, 1000);
}

function stopLoop() {
if (timerId) {
clearInterval(timerId);
timerId = null;
}
}

// Init form fra state
genderEl.value = state.profile.gender || "male";
ageEl.value = state.profile.age || 40;
weightEl.value = state.profile.weight || 80;
muscleEl.value = state.profile.muscle || "normal";
alreadyHoursEl.value = state.alreadyHours || "";

// Start / stop / nulstil
startBtn.addEventListener("click", () => {
const now = Date.now();
updateProfileFromUI();

const bmr = state.bmrPerDay || computeBmrFromProfile(state.profile);
state.bmrPerDay = bmr;
const bmrPerHour = bmr / 24;

// Timer siden sidste m√•ltid ved opstart
const initialRealHours = state.alreadyHours || 0;

// Fedtandel ved denne effektive tid
const fractions = getEnergyFractions(initialRealHours);

// Energiunderskud fra BMR i de timer, man allerede har fastet
const initialEnergyFromBmr = bmrPerHour * initialRealHours;

// Start med et v√¶gttab svarende til de timer, man allerede har fastet (kun fedtdelen)
const initialFatEnergy = initialEnergyFromBmr * (fractions.fat || 0);

state.isFasting = true;
state.startTimestamp = now;
state.cumulativeFatEnergyKcal = initialFatEnergy;
state.lastUpdateTimestamp = now;

saveState();
startLoop();
updateUI();
});

stopBtn.addEventListener("click", () => {
state.isFasting = false;
saveState();
stopLoop();
updateUI();
});

resetBtn.addEventListener("click", () => {
state.isFasting = false;
state.startTimestamp = null;
state.alreadyHours = 0;
state.totalActivityKcal = 0;
state.refeedKcal = 0;
state.cumulativeFatEnergyKcal = 0;
state.lastUpdateTimestamp = null;
saveState();
stopLoop();
updateUI();
});

// Aktivitet ‚Äì l√¶g til b√•de ‚Äúeffektiv tid‚Äù og fedt-energi ved aktuel fedtandel
addActivityBtn.addEventListener("click", () => {
const val = Number(activityKcalEl.value) || 0;
if (val > 0) {
const bmr = state.bmrPerDay || computeBmrFromProfile(state.profile);
const bmrPerHour = bmr / 24;
const now = Date.now();
const { effectiveHours } = computeTimes(now, bmrPerHour);
const fractions = getEnergyFractions(effectiveHours);

state.totalActivityKcal += val;
state.cumulativeFatEnergyKcal =
(state.cumulativeFatEnergyKcal || 0) + val * fractions.fat;

activityKcalEl.value = "";
saveState();
updateUI();
}
});

// Refeed ‚Äì tr√¶k energi og fedt-energi fra ved aktuel fedtandel
applyRefeedBtn.addEventListener("click", () => {
const val = Number(refeedKcalEl.value) || 0;
if (val > 0) {
const bmr = state.bmrPerDay || computeBmrFromProfile(state.profile);
const bmrPerHour = bmr / 24;
const now = Date.now();
const { effectiveHours } = computeTimes(now, bmrPerHour);
const fractions = getEnergyFractions(effectiveHours);

state.refeedKcal += val;
const deltaFat = val * fractions.fat;
state.cumulativeFatEnergyKcal = Math.max(
0,
(state.cumulativeFatEnergyKcal || 0) - deltaFat
);

refeedKcalEl.value = "";
saveState();
updateUI();
}
});

// N√•r siden loader
updateUI();
if (state.isFasting && state.startTimestamp) {
startLoop();
}
</script>
</body>
</html>
