<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8" />
<title>Faste-tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
:root {
--bg: #050812;
--bg-panel: #101624;
--bg-panel-soft: #161d2c;
--accent: #ffb347;
--accent-strong: #ff7a3c;
--accent-green: #3fd57b;
--accent-red: #ff4b5c;
--text-main: #f7f7ff;
--text-muted: #a4b0cf;
--chip-on-bg: #0e2a19;
--chip-on-border: #27c361;
--chip-off-bg: #1c2231;
--chip-off-border: #3d465d;
--badge-on-bg: #16325f;
--badge-on-border: #4e8cff;
--badge-off-bg: #1c2231;
--badge-off-border: #3d465d;
--radius-panel: 18px;
--radius-chip: 999px;
--shadow-soft: 0 18px 40px rgba(0, 0, 0, 0.45);
}

* {
box-sizing: border-box;
}

body {
margin: 0;
padding: 0;
font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
"Segoe UI", sans-serif;
background: radial-gradient(circle at top left, #1c2940 0, #050812 55%);
color: var(--text-main);
}

.app-shell {
max-width: 1200px;
margin: 0 auto;
padding: 24px 16px 40px;
}

.app-header {
margin-bottom: 16px;
}

.app-title-row {
display: flex;
align-items: center;
gap: 10px;
margin-bottom: 4px;
}

.app-title-dot {
width: 14px;
height: 14px;
border-radius: 50%;
background: radial-gradient(circle at 30% 30%, #ffdf7a 0, #ff7a3c 60%);
box-shadow: 0 0 14px rgba(255, 160, 70, 0.8);
}

h1 {
font-size: 24px;
font-weight: 700;
letter-spacing: 0.03em;
margin: 0;
}

.app-subtitle {
font-size: 13px;
color: var(--text-muted);
}

/* layout */

.layout {
display: grid;
grid-template-columns: 3fr 2fr;
gap: 16px;
}

@media (max-width: 900px) {
.layout {
grid-template-columns: 1fr;
}
}

.panel {
background: radial-gradient(circle at top left, #182235 0, #111726 55%);
border-radius: var(--radius-panel);
box-shadow: var(--shadow-soft);
padding: 16px 18px 18px;
border: 1px solid rgba(255, 255, 255, 0.02);
}

.panel-header {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 10px;
}

.panel-title {
font-size: 15px;
font-weight: 600;
letter-spacing: 0.04em;
text-transform: uppercase;
color: #e3ebff;
}

.chip {
display: inline-flex;
align-items: center;
gap: 6px;
padding: 3px 10px;
border-radius: var(--radius-chip);
font-size: 11px;
border: 1px solid transparent;
white-space: nowrap;
}

.chip-dot {
width: 7px;
height: 7px;
border-radius: 50%;
}

.chip-on {
background: var(--chip-on-bg);
border-color: var(--chip-on-border);
color: #a5f5c1;
}

.chip-on .chip-dot {
background: #42f27d;
box-shadow: 0 0 8px rgba(101, 255, 166, 0.9);
}

.chip-off {
background: var(--chip-off-bg);
border-color: var(--chip-off-border);
color: var(--text-muted);
}

.chip-off .chip-dot {
background: #6b738a;
}

/* top stats */

.top-stats {
display: grid;
grid-template-columns: repeat(2, minmax(0, 1fr));
gap: 10px;
margin-bottom: 14px;
}

.top-stat-card {
background: rgba(5, 10, 25, 0.85);
border-radius: 14px;
padding: 10px 12px;
border: 1px solid rgba(255, 255, 255, 0.03);
display: flex;
flex-direction: column;
gap: 4px;
}

.top-stat-label {
font-size: 11px;
color: var(--text-muted);
text-transform: uppercase;
letter-spacing: 0.06em;
}

.top-stat-value {
font-size: 20px;
font-weight: 600;
}

.top-stat-sub {
font-size: 11px;
color: var(--text-muted);
}

.top-stat-sub strong {
color: #f5f5ff;
}

/* gauge */

.gauge-panel {
margin-top: 4px;
}

.gauge-wrapper {
position: relative;
width: 100%;
aspect-ratio: 2.4 / 1;
margin-bottom: 6px;
overflow: hidden;
border-radius: 999px 999px 40% 40%;
background: radial-gradient(circle at 50% 130%, #050812 0, #050812 60%);
}

.gauge-arc {
position: absolute;
inset: 12% 8% 35%;
border-radius: 999px;
background: conic-gradient(
from 210deg,
#41d574 0deg,
#b0f25e 80deg,
#ffd14e 150deg,
#ff7a3c 210deg,
#ff4b5c 260deg,
#ff4b5c 320deg
);
-webkit-mask: radial-gradient(circle at 50% 120%, transparent 60%, #000 60%);
mask: radial-gradient(circle at 50% 120%, transparent 60%, #000 60%);
opacity: 0.92;
}

.gauge-inner-shadow {
position: absolute;
inset: 16% 12% 40%;
border-radius: 999px;
background: radial-gradient(circle at 50% 140%, #050812 0, #050812 70%, transparent 90%);
opacity: 0.9;
}

.gauge-needle {
position: absolute;
left: 50%;
bottom: 12%;
transform-origin: 50% 100%;
transform: translate(-50%, -100%) rotate(-110deg);
width: 2px;
height: 55%;
}

.gauge-needle-line {
position: absolute;
left: 50%;
bottom: 0;
width: 2px;
height: 100%;
transform: translateX(-50%);
background: linear-gradient(to top, #ffffff, #ffffff, rgba(255, 255, 255, 0));
box-shadow: 0 0 12px rgba(255, 255, 255, 0.8);
border-radius: 999px;
}

.gauge-needle-knob {
position: absolute;
left: 50%;
bottom: 0;
width: 14px;
height: 14px;
transform: translate(-50%, 45%);
border-radius: 50%;
background: radial-gradient(circle at 30% 30%, #ffffff 0, #d0d5ff 60%, #6f7bff 100%);
box-shadow:
0 0 10px rgba(96, 255, 178, 0.9),
0 0 18px rgba(96, 255, 178, 0.6);
border: 2px solid #050812;
}

.gauge-scale-labels {
position: absolute;
inset: 0;
display: flex;
align-items: flex-end;
justify-content: space-between;
padding: 0 24px 10px;
font-size: 11px;
color: #b8c3e8;
pointer-events: none;
}

.gauge-footer-row {
display: flex;
align-items: center;
justify-content: space-between;
font-size: 12px;
margin-top: 6px;
}

.gauge-footer-row strong {
font-size: 14px;
}

/* energi-bars */

.energy-section {
margin-top: 10px;
}

.energy-title {
font-size: 12px;
text-transform: uppercase;
letter-spacing: 0.06em;
color: var(--text-muted);
margin-bottom: 6px;
}

.energy-rows {
display: grid;
grid-template-columns: repeat(2, minmax(0, 1fr));
gap: 4px 12px;
}

.energy-row {
display: flex;
flex-direction: column;
gap: 2px;
font-size: 12px;
}

.energy-label {
display: flex;
align-items: center;
justify-content: space-between;
}

.energy-name {
display: flex;
align-items: center;
gap: 6px;
}

.energy-dot {
width: 8px;
height: 8px;
border-radius: 50%;
}

.energy-dot.fat {
background: #3fd57b;
}

.energy-dot.carb {
background: #ffd14e;
}

.energy-dot.muscle {
background: #ff7a9f;
}

.energy-dot.bone {
background: #8ac6ff;
}

.energy-bar-bg {
height: 4px;
border-radius: 999px;
background: #1f2535;
overflow: hidden;
}

.energy-bar-fill {
height: 100%;
width: 0%;
border-radius: 999px;
background: linear-gradient(to right, #3fd57b, #ffd14e);
}

.energy-bar-fill.carb {
background: linear-gradient(to right, #ffd14e, #ff7a3c);
}

.energy-bar-fill.muscle {
background: linear-gradient(to right, #ff7a9f, #ff4b5c);
}

.energy-bar-fill.bone {
background: linear-gradient(to right, #8ac6ff, #4e8cff);
}

/* autofagi */

.autofagi-panel {
margin-top: 12px;
padding: 10px 11px 10px;
border-radius: 14px;
background: linear-gradient(135deg, #111a2b, #0b1525);
border: 1px solid rgba(255, 255, 255, 0.03);
font-size: 12px;
}

.autofagi-header {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 4px;
}

.autofagi-header-title {
display: flex;
align-items: center;
gap: 6px;
font-size: 13px;
font-weight: 500;
}

.autofagi-header-title span.emoji {
font-size: 16px;
}

.autofagi-lines {
display: flex;
flex-direction: column;
gap: 2px;
color: var(--text-muted);
}

.autofagi-lines strong {
color: #f7f7ff;
}

.autofagi-footnote {
margin-top: 4px;
font-size: 11px;
color: var(--text-muted);
}

.badge {
display: inline-flex;
align-items: center;
gap: 6px;
padding: 4px 10px;
border-radius: 999px;
font-size: 11px;
border: 1px solid transparent;
white-space: nowrap;
}

.badge-on {
background: var(--badge-on-bg);
border-color: var(--badge-on-border);
color: #d4e5ff;
box-shadow: 0 0 12px rgba(78, 140, 255, 0.4);
}

.badge-off {
background: var(--badge-off-bg);
border-color: var(--badge-off-border);
color: var(--text-muted);
}

.badge-row {
display: flex;
flex-wrap: wrap;
gap: 6px;
margin-top: 6px;
}

/* h√∏jre side ‚Äì profil */

.form-grid {
display: grid;
grid-template-columns: repeat(2, minmax(0, 1fr));
gap: 8px 10px;
margin-top: 4px;
font-size: 12px;
}

.form-field {
display: flex;
flex-direction: column;
gap: 3px;
}

.form-label {
color: var(--text-muted);
font-size: 11px;
}

select,
input[type="number"],
input[type="text"] {
width: 100%;
border-radius: 999px;
border: 1px solid rgba(255, 255, 255, 0.07);
background: rgba(5, 9, 20, 0.9);
color: var(--text-main);
padding: 4px 10px;
font-size: 13px;
outline: none;
-webkit-appearance: none;
appearance: none;
}

select:focus,
input[type="number"]:focus,
input[type="text"]:focus {
border-color: rgba(119, 182, 255, 0.9);
box-shadow: 0 0 0 1px rgba(119, 182, 255, 0.5);
}

.small-pill {
font-size: 11px;
padding: 3px 8px;
border-radius: 999px;
background: rgba(255, 255, 255, 0.03);
border: 1px solid rgba(255, 255, 255, 0.06);
display: inline-flex;
align-items: center;
gap: 4px;
color: var(--text-muted);
}

.small-pill strong {
color: #f5f5ff;
}

/* aktivitet-knapper */

.activity-row {
display: flex;
gap: 6px;
align-items: center;
margin-top: 4px;
}

.btn {
border-radius: 999px;
border: none;
font-size: 13px;
padding: 7px 14px;
cursor: pointer;
font-weight: 500;
display: inline-flex;
align-items: center;
justify-content: center;
gap: 6px;
transition: transform 0.05s ease, box-shadow 0.05s ease, background 0.1s;
}

.btn-primary {
background: linear-gradient(135deg, #ffb347, #ff7a3c);
color: #11121b;
box-shadow: 0 8px 18px rgba(255, 138, 76, 0.45);
}

.btn-primary:active {
transform: translateY(1px);
box-shadow: 0 4px 10px rgba(255, 138, 76, 0.4);
}

.btn-secondary {
background: rgba(255, 255, 255, 0.04);
color: #f5f5ff;
border: 1px solid rgba(255, 255, 255, 0.12);
}

.btn-secondary:active {
transform: translateY(1px);
}

.btn-danger {
background: rgba(255, 75, 92, 0.12);
color: #ff9ba7;
border: 1px solid rgba(255, 75, 92, 0.5);
}

.btn-danger:active {
transform: translateY(1px);
}

.btn-small {
font-size: 11px;
padding: 5px 10px;
}

.btn-full {
width: 100%;
justify-content: center;
}

.btn-group {
display: flex;
gap: 6px;
margin-top: 6px;
}

.history-header {
display: flex;
align-items: center;
justify-content: space-between;
font-size: 12px;
margin-top: 12px;
margin-bottom: 4px;
color: var(--text-muted);
}

.history-list {
display: flex;
flex-direction: column;
gap: 6px;
max-height: 160px;
overflow-y: auto;
padding-right: 4px;
}

.history-empty {
font-size: 11px;
color: var(--text-muted);
font-style: italic;
}

.history-chip {
border-radius: 12px;
padding: 6px 9px;
background: rgba(5, 9, 20, 0.9);
border: 1px solid rgba(255, 255, 255, 0.06);
display: flex;
flex-direction: column;
gap: 2px;
font-size: 11px;
}

.history-chip-main {
display: flex;
justify-content: space-between;
color: #e4ecff;
}

.history-chip-sub {
display: flex;
justify-content: space-between;
color: var(--text-muted);
}

.footer-note {
margin-top: 10px;
font-size: 10px;
color: var(--text-muted);
line-height: 1.4;
}

@media (max-width: 700px) {
.top-stats {
grid-template-columns: 1fr;
}
.form-grid {
grid-template-columns: 1fr;
}
.energy-rows {
grid-template-columns: 1fr;
}
}
</style>
</head>
<body>
<div class="app-shell">
<header class="app-header">
<div class="app-title-row">
<div class="app-title-dot"></div>
<h1>Faste-tracker</h1>
</div>
<div class="app-subtitle">
Tryk start, n√•r du tager sidste bid mad ‚Äì og se, hvordan din faste "booster"
fedtforbr√¶ndingen over tid.
</div>
</header>

<div class="layout">
<!-- VENSTRE SIDE: LIVE FASTE -->
<section class="panel">
<div class="panel-header">
<div class="panel-title">Din faste lige nu</div>
<div class="chip chip-off" data-live-status-chip>
<span class="chip-dot"></span>
<span data-live-status-text>Ikke startet</span>
</div>
</div>

<div class="top-stats">
<div class="top-stat-card">
<div class="top-stat-label">Varighed</div>
<div class="top-stat-value" data-duration>00:00:00</div>
<div class="top-stat-sub">
<strong data-duration-hours>0,0 t</strong> ¬∑
Effektiv faste inkl. aktivitet & refeed:
<strong data-effective-hours>0,0 t</strong>
</div>
</div>
<div class="top-stat-card">
<div class="top-stat-label">Samlet v√¶gttab</div>
<div class="top-stat-value" data-total-loss>0 g</div>
<div class="top-stat-sub">
<strong data-total-loss-kg>0,000 kg</strong> ¬∑
Estimeret tab pga. kalorieunderskud & fedtandel.
</div>
</div>
</div>

<!-- FEDT-BOOST -->
<div class="gauge-panel">
<div class="panel-header" style="margin-bottom: 4px;">
<div class="panel-title">Fedtforbr√¶ndings-boost</div>
<span class="chip chip-on chip-small">
<span class="chip-dot"></span>
Live fat-burn
</span>
</div>

<div class="gauge-wrapper">
<div class="gauge-arc"></div>
<div class="gauge-inner-shadow"></div>

<div class="gauge-needle" data-gauge-needle>
<div class="gauge-needle-line"></div>
<div class="gauge-needle-knob"></div>
</div>

<div class="gauge-scale-labels">
<span>Lav</span>
<span>Mellem</span>
<span>H√∏j</span>
<span>Max</span>
</div>
</div>

<div class="gauge-footer-row">
<div>
Fedt-boost i dag:
<strong data-gauge-boost>1,0√ó</strong>
</div>
<div>
Fedtandel lige nu:
<strong data-gauge-fat-share>10%</strong>
</div>
</div>
</div>

<!-- ENERGIKILDER -->
<div class="energy-section">
<div class="energy-title">Energikilder lige nu (groft sk√∏n over energifordeling)</div>
<div class="energy-rows">
<div class="energy-row">
<div class="energy-label">
<div class="energy-name">
<span class="energy-dot fat"></span>
<span>Fedt</span>
</div>
<span data-fat-pct>10%</span>
</div>
<div class="energy-bar-bg">
<div class="energy-bar-fill fat" data-bar-fat></div>
</div>
</div>
<div class="energy-row">
<div class="energy-label">
<div class="energy-name">
<span class="energy-dot carb"></span>
<span>Kulhydrat</span>
</div>
<span data-carb-pct>90%</span>
</div>
<div class="energy-bar-bg">
<div class="energy-bar-fill carb" data-bar-carb></div>
</div>
</div>
<div class="energy-row">
<div class="energy-label">
<div class="energy-name">
<span class="energy-dot muscle"></span>
<span>Muskler</span>
</div>
<span data-muscle-pct>0%</span>
</div>
<div class="energy-bar-bg">
<div class="energy-bar-fill muscle" data-bar-muscle></div>
</div>
</div>
<div class="energy-row">
<div class="energy-label">
<div class="energy-name">
<span class="energy-dot bone"></span>
<span>Knogler</span>
</div>
<span data-bone-pct>0%</span>
</div>
<div class="energy-bar-bg">
<div class="energy-bar-fill bone" data-bar-bone></div>
</div>
</div>
</div>
</div>

<!-- AUTOFAGI -->
<div class="autofagi-panel">
<div class="autofagi-header">
<div class="autofagi-header-title">
<span class="emoji">ü©∫</span>
<span>Autofagi</span>
</div>
<div class="chip chip-off" data-autofagy-status>
<span class="chip-dot"></span>
<span>Ikke aktiv endnu</span>
</div>
</div>
<div class="autofagi-lines">
<div>Forventet start: ca. 16 timer uden mad.</div>
<div>
Tid til autofagi:
<strong data-time-to-autofagy>16,0 t</strong>
</div>
<div>
Timer i autofagi:
<strong data-hours-in-autofagy>0,0 t</strong>
</div>
</div>
<div class="badge-row">
<div class="badge badge-off" data-badge-official-fast>
ü•á Officielt i faste (12+ t)
</div>
<div class="badge badge-off" data-badge-autofagy>
üîß Autofagi aktiv (16+ t)
</div>
</div>
<div class="autofagi-footnote">
Autofagi = kroppens "oprydning" af slidte celler og affaldsstoffer.
Effekten er groft modelleret og ikke personlig medicinsk r√•dgivning.
</div>
</div>
</section>

<!-- H√òJRE SIDE: PROFIL & HISTORIK -->
<section class="panel">
<div class="panel-header">
<div class="panel-title">Din profil & opstart</div>
<span class="small-pill">
Gemmes lokalt p√• enheden
</span>
</div>

<div class="form-grid">
<div class="form-field">
<div class="form-label">K√∏n</div>
<select data-input-gender>
<option value="mand">Mand</option>
<option value="kvinde">Kvinde</option>
</select>
</div>
<div class="form-field">
<div class="form-label">Aldersgruppe</div>
<select data-input-age>
<option value="18-29">18-29</option>
<option value="30-39">30-39</option>
<option value="40-49">40-49</option>
<option value="50-59" selected>50-59</option>
<option value="60-69">60-69</option>
<option value="70+">70+</option>
</select>
</div>
<div class="form-field">
<div class="form-label">V√¶gt (kg)</div>
<input type="number" min="35" max="200" step="0.5" value="85" data-input-weight />
</div>
<div class="form-field">
<div class="form-label">Muskel-niveau</div>
<select data-input-muscle>
<option value="lille_muskulatur">Lille muskelmasse</option>
<option value="normal">Normal</option>
<option value="muskuloes" selected>Muskul√∏s</option>
<option value="meget_muskuloes">Meget muskul√∏s</option>
</select>
</div>
<div class="form-field">
<div class="form-label">Allerede fastet (timer)</div>
<input
type="number"
min="0"
max="72"
step="0.5"
value="0"
data-input-already-fast
/>
</div>
<div class="form-field">
<div class="form-label">Refeed-m√•ltid (kcal)</div>
<input
type="number"
min="0"
max="6000"
step="10"
value="0"
data-input-refeed
/>
</div>
<div class="form-field">
<div class="form-label">Aktivitet i dag (kcal)</div>
<input
type="number"
min="0"
max="6000"
step="10"
value="0"
data-input-activity-today
/>
</div>
<div class="form-field">
<div class="form-label">Estimeret basisforbr√¶nding</div>
<span class="small-pill">
BMR ca.
<strong data-bmr-label>2200 kcal/d√∏gn</strong>
</span>
</div>
</div>

<!-- EKSTRA AKTIVITET -->
<div class="form-field" style="margin-top:10px;">
<div class="form-label">Ekstra bev√¶gelse (l√¶g "godt-gjort" til faste-tiden)</div>
<div class="activity-row">
<input
type="number"
min="0"
max="4000"
step="10"
value="0"
placeholder="fx 400 kcal"
data-input-add-activity
/>
<button class="btn btn-secondary btn-small" data-btn-add-activity>
+ L√¶g til aktivitet
</button>
</div>
<div style="margin-top:4px;font-size:11px;color:var(--text-muted);">
Samlet aktivitet: <strong data-total-activity>0 kcal</strong>
</div>
</div>

<!-- KNAPPER -->
<div class="btn-group">
<button class="btn btn-primary btn-full" data-btn-start>
‚ñ∂Ô∏è Start / genoptag
</button>
<button class="btn btn-secondary btn-full" data-btn-stop>
‚è∏ Stop faste
</button>
<button class="btn btn-danger btn-full" data-btn-reset>
üîÅ Nulstil alt
</button>
</div>

<!-- HISTORIK -->
<div class="history-header">
<span>Faste-historik (lokalt)</span>
<button class="btn btn-secondary btn-small" data-btn-save-fast>
üíæ Gem denne faste
</button>
</div>
<div class="history-list" data-history-container>
<span class="history-empty">Ingen gemte faster endnu.</span>
</div>
<div style="margin-top:6px; display:flex; justify-content:flex-end;">
<button class="btn btn-danger btn-small" data-btn-clear-history>
Ryd historik
</button>
</div>

<div class="footer-note">
Appen er et simpelt motivationsv√¶rkt√∏j ‚Äì ikke l√¶gefaglig r√•dgivning.
Tal er sk√∏n baseret p√• egne input.
</div>
</section>
</div>
</div>

<!-- LOGIK ‚Äì INGEN DESIGN-√ÜNDRING -->
<script>
const STORAGE_KEY_STATE = "fastetracker_state_v47";
const STORAGE_KEY_HISTORY = "fastetracker_history_v47";
const AUTOPHAGY_THRESHOLD_HOURS = 16;

function toNumber(v, fallback = 0) {
const n = parseFloat(v);
return isNaN(n) ? fallback : n;
}

function formatDuration(seconds) {
if (!isFinite(seconds) || seconds < 0) seconds = 0;
const h = Math.floor(seconds / 3600);
const m = Math.floor((seconds % 3600) / 60);
const s = Math.floor(seconds % 60);
return (
String(h).padStart(2, "0") +
":" +
String(m).padStart(2, "0") +
":" +
String(s).padStart(2, "0")
);
}

function round1(x) {
return Math.round(x * 10) / 10;
}

function roundGram(x) {
return Math.round(x * 10) / 10;
}

function calcBMR({ gender, ageGroup, weight, muscleLevel }) {
let perKg = gender === "kvinde" ? 20 : 22;

if (ageGroup === "18-29") perKg += 1.5;
else if (ageGroup === "30-39") perKg += 1;
else if (ageGroup === "40-49") perKg += 0.5;
else if (ageGroup === "60-69") perKg -= 1;
else if (ageGroup === "70+") perKg -= 2;

if (muscleLevel === "muskuloes") perKg += 2;
else if (muscleLevel === "meget_muskuloes") perKg += 4;
else if (muscleLevel === "lille_muskulatur") perKg -= 1.5;

const bmr = perKg * weight;
return Math.max(1200, Math.min(3500, bmr));
}

function getFuelAndBoost(effectiveHours) {
if (!isFinite(effectiveHours) || effectiveHours < 0) effectiveHours = 0;
let fatShare;

if (effectiveHours <= 0) {
fatShare = 0.1;
} else if (effectiveHours < 12) {
fatShare = 0.1 + (effectiveHours / 12) * 0.3; // 10->40%
} else if (effectiveHours < 16) {
fatShare = 0.4 + ((effectiveHours - 12) / 4) * 0.15; // 40->55%
} else if (effectiveHours < 24) {
fatShare = 0.55 + ((effectiveHours - 16) / 8) * 0.15; // 55->70%
} else if (effectiveHours < 48) {
fatShare = 0.7 + ((effectiveHours - 24) / 24) * 0.1; // 70->80%
} else {
fatShare = 0.8;
}

fatShare = Math.max(0.1, Math.min(0.8, fatShare));

const carbShare = 1 - fatShare;
const boost = 1 + ((fatShare - 0.1) * 6) / 0.8;

return {
fatShare,
carbShare,
muscleShare: 0,
boneShare: 0,
boost,
};
}

function fuelShareToAngle(fatShare) {
const minAngle = -110;
const maxAngle = 110;
const clamped = Math.max(0.1, Math.min(0.8, fatShare));
const t = (clamped - 0.1) / 0.7;
return minAngle + t * (maxAngle - minAngle);
}

const els = {
statusChip: document.querySelector("[data-live-status-chip]"),
statusText: document.querySelector("[data-live-status-text]"),

durationLabel: document.querySelector("[data-duration]"),
durationHoursLabel: document.querySelector("[data-duration-hours]"),
totalLossLabel: document.querySelector("[data-total-loss]"),
totalLossKgLabel: document.querySelector("[data-total-loss-kg]"),
effectiveHoursLabel: document.querySelector("[data-effective-hours]"),

fatBar: document.querySelector("[data-bar-fat]"),
carbBar: document.querySelector("[data-bar-carb]"),
muscleBar: document.querySelector("[data-bar-muscle]"),
boneBar: document.querySelector("[data-bar-bone]"),

fatPctLabel: document.querySelector("[data-fat-pct]"),
carbPctLabel: document.querySelector("[data-carb-pct]"),
musclePctLabel: document.querySelector("[data-muscle-pct]"),
bonePctLabel: document.querySelector("[data-bone-pct]"),

gaugeNeedle: document.querySelector("[data-gauge-needle]"),
gaugeBoostLabel: document.querySelector("[data-gauge-boost]"),
gaugeFatShareLabel: document.querySelector("[data-gauge-fat-share]"),

autofagyStatusChip: document.querySelector("[data-autofagy-status]"),
timeToAutofagyLabel: document.querySelector("[data-time-to-autofagy]"),
hoursInAutofagyLabel: document.querySelector("[data-hours-in-autofagy]"),

gender: document.querySelector("[data-input-gender]"),
ageGroup: document.querySelector("[data-input-age]"),
weight: document.querySelector("[data-input-weight]"),
muscleLevel: document.querySelector("[data-input-muscle]"),
alreadyFasted: document.querySelector("[data-input-already-fast]"),
refeedKcal: document.querySelector("[data-input-refeed]"),
activityTodayKcal: document.querySelector("[data-input-activity-today]"),
bmrLabel: document.querySelector("[data-bmr-label]"),

addActivityKcal: document.querySelector("[data-input-add-activity]"),
addActivityBtn: document.querySelector("[data-btn-add-activity]"),
totalActivityLabel: document.querySelector("[data-total-activity]"),

startBtn: document.querySelector("[data-btn-start]"),
stopBtn: document.querySelector("[data-btn-stop]"),
resetBtn: document.querySelector("[data-btn-reset]"),

historyContainer: document.querySelector("[data-history-container]"),
saveFastBtn: document.querySelector("[data-btn-save-fast]"),
clearHistoryBtn: document.querySelector("[data-btn-clear-history]"),

officialFastChip: document.querySelector("[data-badge-official-fast]"),
autofagyBadgeChip: document.querySelector("[data-badge-autofagy]"),
};

let state = {
isRunning: false,
startTimestamp: null,
baseStartHours: 0,

gender: "mand",
ageGroup: "50-59",
weight: 80,
muscleLevel: "normal",

refeedKcal: 0,
activityTodayKcal: 0,
addedActivityKcal: 0,

bmr: 2200,
totalDeficitKcal: 0,
totalFatLossGram: 0,
};

function saveState() {
try {
localStorage.setItem(STORAGE_KEY_STATE, JSON.stringify(state));
} catch (e) {
console.warn("Kunne ikke gemme state:", e);
}
}

function loadState() {
try {
const raw = localStorage.getItem(STORAGE_KEY_STATE);
if (!raw) return;
const data = JSON.parse(raw);
state = { ...state, ...data };
} catch (e) {
console.warn("Kunne ikke l√¶se state:", e);
}
}

function loadHistory() {
try {
const raw = localStorage.getItem(STORAGE_KEY_HISTORY);
if (!raw) return [];
return JSON.parse(raw);
} catch {
return [];
}
}

function saveHistory(list) {
try {
localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(list));
} catch (e) {
console.warn("Kunne ikke gemme historik:", e);
}
}

function applyProfileToInputs() {
els.gender.value = state.gender;
els.ageGroup.value = state.ageGroup;
els.weight.value = state.weight;
els.muscleLevel.value = state.muscleLevel;
els.alreadyFasted.value = String(state.baseStartHours).replace(".", ",");
els.refeedKcal.value = state.refeedKcal || 0;
els.activityTodayKcal.value = state.activityTodayKcal || 0;
els.addActivityKcal.value = "";
els.totalActivityLabel.textContent =
(state.addedActivityKcal || 0) + " kcal";
els.bmrLabel.textContent = Math.round(state.bmr) + " kcal/d√∏gn";
}

function renderHistory() {
if (!els.historyContainer) return;
const history = loadHistory();
if (!history.length) {
els.historyContainer.innerHTML =
'<span class="history-empty">Ingen gemte faster endnu.</span>';
return;
}
const chips = history
.slice()
.reverse()
.map((f) => {
const date = new Date(f.savedAt);
const dStr =
date.getDate() +
"-" +
(date.getMonth() + 1) +
"-" +
date.getFullYear().toString().slice(-2);
return `
<div class="history-chip">
<div class="history-chip-main">
<span>${dStr}</span>
<span>${roundGram(f.totalFatLossGram)} g tabt</span>
</div>
<div class="history-chip-sub">
<span>${round1(f.durationHours)} t</span>
<span>Effektiv: ${round1(f.effectiveHours)} t</span>
</div>
</div>
`;
})
.join("");
els.historyContainer.innerHTML = chips;
}

function updateUI() {
const now = Date.now();
let extraSeconds = 0;
if (state.isRunning && state.startTimestamp) {
extraSeconds = (now - state.startTimestamp) / 1000;
}

const elapsedHours = state.baseStartHours + extraSeconds / 3600;

state.bmr = calcBMR(state);
const kcalPerHour = state.bmr / 24;
const totalActivityKcal =
(state.activityTodayKcal || 0) + (state.addedActivityKcal || 0);

const activityHoursEquiv = totalActivityKcal / kcalPerHour;
const refeedHoursEquiv = (state.refeedKcal || 0) / kcalPerHour;

const effectiveHoursRaw =
elapsedHours + activityHoursEquiv - refeedHoursEquiv;
const effectiveHours = Math.max(0, effectiveHoursRaw);

const fuel = getFuelAndBoost(effectiveHours);
const fatShare = fuel.fatShare;
const carbShare = fuel.carbShare;
const muscleShare = fuel.muscleShare;
const boneShare = fuel.boneShare;

const basalKcal = kcalPerHour * elapsedHours;
const deficitKcal = Math.max(
0,
basalKcal + totalActivityKcal - (state.refeedKcal || 0)
);
state.totalDeficitKcal = deficitKcal;

const fatKcal = deficitKcal * fatShare;
const fatGram = fatKcal / 9;
state.totalFatLossGram = fatGram;

if (state.isRunning) {
els.statusChip?.classList.add("chip-on");
els.statusChip?.classList.remove("chip-off");
if (els.statusText) els.statusText.textContent = "Faste i gang";
} else {
els.statusChip?.classList.remove("chip-on");
els.statusChip?.classList.add("chip-off");
if (els.statusText) els.statusText.textContent = "Ikke startet";
}

const totalSeconds = elapsedHours * 3600;
els.durationLabel.textContent = formatDuration(totalSeconds);
els.durationHoursLabel.textContent = round1(elapsedHours) + " t";
els.totalLossLabel.textContent = roundGram(fatGram) + " g";
els.totalLossKgLabel.textContent =
(roundGram(fatGram) / 1000).toFixed(3) + " kg";
els.effectiveHoursLabel.textContent = round1(effectiveHours) + " t";

const fatPct = Math.round(fatShare * 100);
const carbPct = Math.round(carbShare * 100);
const musclePct = Math.round(muscleShare * 100);
const bonePct = Math.round(boneShare * 100);

if (els.fatBar) els.fatBar.style.width = fatPct + "%";
if (els.carbBar) els.carbBar.style.width = carbPct + "%";
if (els.muscleBar) els.muscleBar.style.width = musclePct + "%";
if (els.boneBar) els.boneBar.style.width = bonePct + "%";

if (els.fatPctLabel) els.fatPctLabel.textContent = fatPct + "%";
if (els.carbPctLabel) els.carbPctLabel.textContent = carbPct + "%";
if (els.musclePctLabel) els.musclePctLabel.textContent = musclePct + "%";
if (els.bonePctLabel) els.bonePctLabel.textContent = bonePct + "%";

const angle = fuelShareToAngle(fatShare);
if (els.gaugeNeedle) {
els.gaugeNeedle.style.transform =
"translate(-50%, -100%) rotate(" + angle + "deg)";
}
if (els.gaugeBoostLabel) {
els.gaugeBoostLabel.textContent = round1(fuel.boost) + "√ó";
}
if (els.gaugeFatShareLabel) {
els.gaugeFatShareLabel.textContent = fatPct + "%";
}

let autofagyHours = 0;
let timeToAutofagy = AUTOPHAGY_THRESHOLD_HOURS - effectiveHours;
if (effectiveHours >= AUTOPHAGY_THRESHOLD_HOURS) {
autofagyHours = effectiveHours - AUTOPHAGY_THRESHOLD_HOURS;
timeToAutofagy = 0;
}
if (els.timeToAutofagyLabel) {
els.timeToAutofagyLabel.textContent =
round1(Math.max(0, timeToAutofagy)) + " t";
}
if (els.hoursInAutofagyLabel) {
els.hoursInAutofagyLabel.textContent =
round1(Math.max(0, autofagyHours)) + " t";
}
if (effectiveHours >= AUTOPHAGY_THRESHOLD_HOURS) {
els.autofagyStatusChip?.classList.add("chip-on");
els.autofagyStatusChip?.classList.remove("chip-off");
} else {
els.autofagyStatusChip?.classList.remove("chip-on");
els.autofagyStatusChip?.classList.add("chip-off");
}

if (els.officialFastChip) {
if (elapsedHours >= 12)
els.officialFastChip.classList.add("badge-on");
else els.officialFastChip.classList.remove("badge-on");
}
if (els.autofagyBadgeChip) {
if (effectiveHours >= AUTOPHAGY_THRESHOLD_HOURS)
els.autofagyBadgeChip.classList.add("badge-on");
else els.autofagyBadgeChip.classList.remove("badge-on");
}

els.bmrLabel.textContent = Math.round(state.bmr) + " kcal/d√∏gn";
}

function readProfileFromInputs() {
state.gender = els.gender?.value || "mand";
state.ageGroup = els.ageGroup?.value || "50-59";
state.weight = toNumber(els.weight?.value || state.weight, state.weight);
state.muscleLevel = els.muscleLevel?.value || "normal";
state.baseStartHours = toNumber(els.alreadyFasted?.value, 0);
state.refeedKcal = toNumber(els.refeedKcal?.value, 0);
state.activityTodayKcal = toNumber(els.activityTodayKcal?.value, 0);
}

function onStart() {
readProfileFromInputs();
state.isRunning = true;
state.startTimestamp = Date.now();
saveState();
updateUI();
}

function onStop() {
state.isRunning = false;
saveState();
updateUI();
}

function onResetAll() {
state.isRunning = false;
state.startTimestamp = null;
state.baseStartHours = 0;
state.refeedKcal = 0;
state.activityTodayKcal = 0;
state.addedActivityKcal = 0;
state.totalDeficitKcal = 0;
state.totalFatLossGram = 0;
saveState();
applyProfileToInputs();
updateUI();
}

function onAddActivity() {
const add = toNumber(els.addActivityKcal?.value, 0);
if (!add || add <= 0) return;
state.addedActivityKcal =
(state.addedActivityKcal || 0) + add;
els.addActivityKcal.value = "";
els.totalActivityLabel.textContent =
state.addedActivityKcal + " kcal";
saveState();
updateUI();
}

function onSaveFast() {
const now = Date.now();
let extraSeconds = 0;
if (state.isRunning && state.startTimestamp) {
extraSeconds = (now - state.startTimestamp) / 1000;
}
const elapsedHours = state.baseStartHours + extraSeconds / 3600;
const kcalPerHour = state.bmr / 24;
const totalActivityKcal =
(state.activityTodayKcal || 0) + (state.addedActivityKcal || 0);
const activityHoursEquiv = totalActivityKcal / kcalPerHour;
const refeedHoursEquiv = (state.refeedKcal || 0) / kcalPerHour;
const effectiveHours = Math.max(
0,
elapsedHours + activityHoursEquiv - refeedHoursEquiv
);

if (elapsedHours < 12) {
alert(
"Du skal mindst have fastet i 12 timer for at kunne gemme fasten i din historik."
);
return;
}

const history = loadHistory();
history.push({
savedAt: now,
durationHours: elapsedHours,
effectiveHours,
totalFatLossGram: state.totalFatLossGram,
});
saveHistory(history);
renderHistory();
alert("Fasten er gemt lokalt p√• enheden.");
}

function onClearHistory() {
if (!confirm("Vil du rydde hele faste-historikken p√• denne enhed?")) return;
saveHistory([]);
renderHistory();
}

function init() {
loadState();
state.bmr = calcBMR(state);
applyProfileToInputs();
renderHistory();
updateUI();

els.startBtn?.addEventListener("click", onStart);
els.stopBtn?.addEventListener("click", onStop);
els.resetBtn?.addEventListener("click", onResetAll);
els.addActivityBtn?.addEventListener("click", onAddActivity);
els.saveFastBtn?.addEventListener("click", onSaveFast);
els.clearHistoryBtn?.addEventListener("click", onClearHistory);

[
els.gender,
els.ageGroup,
els.weight,
els.muscleLevel,
els.alreadyFasted,
els.refeedKcal,
els.activityTodayKcal,
].forEach((input) => {
input?.addEventListener("change", () => {
readProfileFromInputs();
state.bmr = calcBMR(state);
saveState();
updateUI();
});
});

setInterval(() => {
if (!state.isRunning) return;
updateUI();
}, 1000);
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
