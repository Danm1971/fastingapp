<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8" />
<title>Faste-tracker v42</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
:root {
--bg: #05070b;
--card: #111522;
--card-soft: #15192a;
--accent: #4ade80;
--accent-soft: rgba(74, 222, 128, 0.15);
--accent-strong: #22c55e;
--warn: #f97316;
--danger: #ef4444;
--text: #e5e7eb;
--subtle: #9ca3af;
--fat: #22c55e;
--carb: #fbbf24;
--muscle: #fb7185;
--bone: #f97316;
--border-soft: #1f2933;
--badge-gold: #facc15;
--badge-gold-soft: rgba(250, 204, 21, 0.17);
--badge-blue: #38bdf8;
--badge-blue-soft: rgba(56, 189, 248, 0.15);
}

* {
box-sizing: border-box;
}

body {
margin: 0;
padding: 0;
font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
sans-serif;
background: radial-gradient(circle at top, #020617, #02040a 45%, #000 100%);
color: var(--text);
display: flex;
justify-content: center;
min-height: 100vh;
}

.app {
width: 100%;
max-width: 900px;
padding: 16px;
padding-bottom: 40px;
}

h1 {
font-size: 1.4rem;
margin: 0 0 4px;
display: flex;
align-items: center;
gap: 0.4rem;
}

h1 span.logo-dot {
width: 18px;
height: 18px;
border-radius: 6px;
background: radial-gradient(circle at 30% 10%, #facc15, #f97316 40%, #991b1b 100%);
box-shadow: 0 0 12px rgba(248, 250, 252, 0.5);
}

.subtitle {
font-size: 0.8rem;
color: var(--subtle);
margin-bottom: 12px;
}

.grid {
display: grid;
grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
gap: 12px;
}

@media (max-width: 768px) {
.grid {
grid-template-columns: minmax(0, 1fr);
}
}

.card {
background: radial-gradient(circle at top left, #111827, #020617);
border-radius: 18px;
padding: 14px 14px 16px;
border: 1px solid rgba(148, 163, 184, 0.18);
box-shadow:
0 18px 45px rgba(15, 23, 42, 0.95),
0 0 0 1px rgba(15, 23, 42, 0.9);
}

.card-header {
display: flex;
align-items: center;
justify-content: space-between;
margin-bottom: 8px;
}

.card-title {
font-size: 0.9rem;
font-weight: 600;
display: flex;
align-items: center;
gap: 0.35rem;
}

.card-title span.dot {
width: 7px;
height: 7px;
border-radius: 999px;
background: var(--accent);
box-shadow: 0 0 6px rgba(74, 222, 128, 0.9);
}

.chip {
font-size: 0.7rem;
padding: 3px 8px;
border-radius: 999px;
background: rgba(15, 23, 42, 0.9);
border: 1px solid rgba(148, 163, 184, 0.35);
color: var(--subtle);
}

/* Top metrics */
.top-metrics {
display: flex;
gap: 10px;
margin-bottom: 8px;
}

.metric {
flex: 1;
padding: 7px 9px;
background: radial-gradient(circle at top, rgba(15,23,42,0.9), #020617);
border-radius: 12px;
border: 1px solid rgba(51,65,85,0.8);
display: flex;
flex-direction: column;
gap: 4px;
}

.metric-label {
font-size: 0.7rem;
color: var(--subtle);
display: flex;
align-items: center;
gap: 4px;
}

.metric-value {
font-size: 0.95rem;
font-weight: 600;
letter-spacing: 0.03em;
}

.metric-value.big {
font-size: 1.2rem;
}

.pill {
font-size: 0.68rem;
padding: 2px 7px;
border-radius: 999px;
background: rgba(15, 23, 42, 0.9);
border: 1px solid rgba(148, 163, 184, 0.35);
color: var(--subtle);
}

/* Gauge */
.gauge-wrapper {
margin-top: 4px;
margin-bottom: 10px;
}

.gauge-shell {
position: relative;
width: 100%;
max-width: 360px;
margin: 0 auto;
aspect-ratio: 1.6 / 1;
display: flex;
align-items: flex-end;
justify-content: center;
padding-bottom: 8px;
}

.gauge-arc {
position: relative;
width: 100%;
height: 100%;
border-radius: 999px;
background:
conic-gradient(
from 210deg,
#22c55e 0deg,
#22c55e 80deg,
#eab308 120deg,
#f97316 155deg,
#ef4444 180deg,
transparent 180deg,
transparent 360deg
);
mask:
radial-gradient(circle at 50% 100%, transparent 52%, black 52.1%);
box-shadow:
0 0 40px rgba(56, 189, 248, 0.15),
0 0 80px rgba(34, 197, 94, 0.25);
opacity: 0.9;
}

.gauge-inner {
position: absolute;
inset: 16px 10px 0 10px;
border-radius: 999px;
background: radial-gradient(circle at top, #020617, #020617 55%, transparent 100%);
box-shadow: inset 0 18px 32px rgba(0, 0, 0, 0.9);
}

.gauge-indicator {
position: absolute;
bottom: 6px;
width: 2px;
height: 36%;
background: linear-gradient(to top, #fefefe, #facc15);
border-radius: 999px;
box-shadow:
0 0 10px rgba(248, 250, 252, 0.8),
0 0 24px rgba(250, 204, 21, 0.7);
transform-origin: bottom center;
}

.gauge-center-cap {
position: absolute;
bottom: 6px;
width: 18px;
height: 18px;
border-radius: 999px;
background: radial-gradient(circle at 30% 20%, #e5e7eb, #6b7280 55%, #020617 100%);
box-shadow:
0 0 10px rgba(15, 23, 42, 0.9),
0 0 0 2px rgba(15, 23, 42, 1);
}

.gauge-label-row {
margin-top: -2px;
display: flex;
justify-content: space-between;
align-items: center;
font-size: 0.7rem;
color: var(--subtle);
}

.gauge-label-row span {
display: flex;
align-items: center;
gap: 4px;
}

.gauge-label-dot {
width: 7px;
height: 7px;
border-radius: 999px;
}

.gauge-label-dot.green {
background: #22c55e;
}

.gauge-label-dot.yellow {
background: #eab308;
}

.gauge-label-dot.red {
background: #ef4444;
}

.gauge-boost {
margin-top: 4px;
display: flex;
justify-content: space-between;
align-items: baseline;
font-size: 0.8rem;
}

.gauge-boost-main {
font-weight: 600;
}

.gauge-boost-main span {
font-size: 1rem;
color: var(--accent);
}

.gauge-boost-sub {
font-size: 0.7rem;
color: var(--subtle);
}

.divider {
height: 1px;
background: linear-gradient(to right, transparent, rgba(148, 163, 184, 0.5), transparent);
margin: 10px 0;
}

/* Energy bars */
.energy-bars {
display: grid;
grid-template-columns: minmax(0, 1fr);
gap: 6px;
font-size: 0.78rem;
}

.energy-row {
display: flex;
align-items: center;
gap: 6px;
}

.energy-label {
width: 80px;
display: flex;
align-items: center;
gap: 4px;
color: var(--subtle);
}

.color-dot {
width: 8px;
height: 8px;
border-radius: 999px;
}

.energy-bar {
flex: 1;
height: 7px;
border-radius: 999px;
background: radial-gradient(circle at top, #020617, #020617);
border: 1px solid rgba(31, 41, 55, 0.9);
overflow: hidden;
position: relative;
}

.energy-fill {
position: absolute;
inset: 0;
transform-origin: left;
transform: scaleX(0);
border-radius: 999px;
}

.energy-value {
width: 48px;
text-align: right;
font-variant-numeric: tabular-nums;
}

/* Autofagi / badges / info */
.info-grid {
display: grid;
grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
gap: 8px;
margin-top: 6px;
font-size: 0.78rem;
}

@media (max-width: 768px) {
.info-grid {
grid-template-columns: minmax(0, 1fr);
}
}

.info-box {
background: radial-gradient(circle at top, rgba(15, 23, 42, 0.95), #020617);
border-radius: 14px;
border: 1px solid rgba(51, 65, 85, 0.8);
padding: 8px 9px;
}

.info-title {
font-size: 0.78rem;
color: var(--subtle);
margin-bottom: 4px;
display: flex;
align-items: center;
gap: 4px;
}

.badge-row {
display: flex;
gap: 6px;
flex-wrap: wrap;
margin-top: 4px;
}

.badge {
display: inline-flex;
align-items: center;
gap: 4px;
padding: 3px 8px;
border-radius: 999px;
font-size: 0.7rem;
border: 1px solid rgba(248, 250, 252, 0.25);
background: radial-gradient(circle at top, rgba(15, 23, 42, 0.95), #020617);
box-shadow: 0 0 10px rgba(148, 163, 184, 0.3);
}

.badge.gold {
border-color: var(--badge-gold);
background: radial-gradient(circle at top, rgba(161, 98, 7, 0.95), #0b1120);
color: #fef9c3;
box-shadow:
0 0 16px rgba(250, 204, 21, 0.55),
0 0 48px rgba(250, 204, 21, 0.25);
animation: pulse-gold 1.5s infinite ease-in-out;
}

.badge.blue {
border-color: var(--badge-blue);
background: radial-gradient(circle at top, rgba(8, 47, 73, 0.98), #020617);
color: #e0f2fe;
box-shadow:
0 0 16px rgba(56, 189, 248, 0.55),
0 0 48px rgba(56, 189, 248, 0.25);
animation: pulse-blue 1.5s infinite ease-in-out;
}

.badge-icon {
font-size: 0.8rem;
}

@keyframes pulse-gold {
0%, 100% { transform: translateY(0); box-shadow: 0 0 12px rgba(250, 204, 21, 0.55), 0 0 42px rgba(250, 204, 21, 0.3); }
50% { transform: translateY(-1px); box-shadow: 0 0 20px rgba(250, 204, 21, 0.9), 0 0 60px rgba(250, 204, 21, 0.5); }
}

@keyframes pulse-blue {
0%, 100% { transform: translateY(0); box-shadow: 0 0 12px rgba(56, 189, 248, 0.55), 0 0 42px rgba(56, 189, 248, 0.3); }
50% { transform: translateY(-1px); box-shadow: 0 0 20px rgba(56, 189, 248, 0.9), 0 0 60px rgba(56, 189, 248, 0.5); }
}

.auto-key {
font-size: 0.72rem;
color: var(--subtle);
margin-top: 4px;
line-height: 1.3;
}

/* History section */
.history-list {
margin-top: 4px;
max-height: 140px;
overflow-y: auto;
padding-right: 2px;
}

.history-item {
border-bottom: 1px solid rgba(31, 41, 55, 0.85);
padding: 4px 0;
font-size: 0.72rem;
display: flex;
justify-content: space-between;
gap: 8px;
}

.history-item:last-child {
border-bottom: none;
}

.history-main {
color: var(--text);
}

.history-sub {
color: var(--subtle);
text-align: right;
white-space: nowrap;
}

/* Profile + controls */
.profile-card {
background: radial-gradient(circle at top, #020617, #020617 55%, #020617 100%);
border-radius: 18px;
padding: 12px 14px 16px;
border: 1px solid rgba(51, 65, 85, 0.9);
box-shadow:
0 12px 36px rgba(15, 23, 42, 0.95),
0 0 0 1px rgba(15, 23, 42, 0.9);
}

.profile-grid {
display: grid;
grid-template-columns: minmax(0, 1.1fr) minmax(0, 1fr);
gap: 10px;
}

@media (max-width: 768px) {
.profile-grid {
grid-template-columns: minmax(0, 1fr);
}
}

.field-group {
margin-bottom: 6px;
}

.field-label {
font-size: 0.75rem;
color: var(--subtle);
margin-bottom: 3px;
display: flex;
align-items: center;
gap: 4px;
}

select,
input[type="number"] {
width: 100%;
padding: 6px 8px;
border-radius: 10px;
border: 1px solid rgba(55, 65, 81, 0.9);
background: #020617;
color: var(--text);
font-size: 0.8rem;
outline: none;
}

select:focus,
input[type="number"]:focus {
border-color: var(--accent);
box-shadow: 0 0 0 1px rgba(74, 222, 128, 0.4);
}

.field-inline {
display: flex;
gap: 8px;
}

.field-inline > div {
flex: 1;
}

.help-text {
font-size: 0.7rem;
color: var(--subtle);
margin-top: 2px;
}

.controls {
margin-top: 8px;
display: flex;
gap: 8px;
flex-wrap: wrap;
align-items: center;
}

button {
border: none;
border-radius: 999px;
padding: 7px 16px;
font-size: 0.8rem;
font-weight: 600;
cursor: pointer;
display: inline-flex;
align-items: center;
gap: 6px;
transition: transform 0.08s ease, box-shadow 0.1s ease, background 0.1s ease;
}

button span.icon {
font-size: 0.9rem;
}

.btn-primary {
background: linear-gradient(to right, #22c55e, #4ade80);
color: #022c22;
box-shadow:
0 10px 20px rgba(34, 197, 94, 0.4),
0 0 12px rgba(22, 163, 74, 0.9);
}

.btn-primary:active {
transform: translateY(1px) scale(0.99);
box-shadow:
0 4px 10px rgba(34, 197, 94, 0.4),
0 0 6px rgba(22, 163, 74, 0.9);
}

.btn-secondary {
background: #020617;
color: var(--subtle);
border: 1px solid rgba(75, 85, 99, 0.9);
}

.btn-secondary:active {
transform: translateY(1px) scale(0.99);
box-shadow: 0 4px 12px rgba(15, 23, 42, 0.9);
}

button:disabled {
opacity: 0.45;
cursor: default;
transform: none;
box-shadow: none;
}

.warning-text {
font-size: 0.7rem;
color: var(--warn);
margin-top: 4px;
}

.footer-note {
margin-top: 10px;
font-size: 0.68rem;
color: var(--subtle);
line-height: 1.4;
}
</style>
</head>
<body>
<div class="app">
<h1>
<span class="logo-dot"></span>
Faste-tracker
</h1>
<div class="subtitle">
Tryk start, n√•r du tager sidste bid ‚Äì og se, hvordan din faste ‚Äúbooster‚Äù fedtforbr√¶ndingen over tid.
</div>

<div class="grid">
<!-- LEFT: LIVE FASTING VIEW -->
<div class="card" id="liveCard">
<div class="card-header">
<div class="card-title">
<span class="dot"></span>
Din faste lige nu
</div>
<div class="chip" id="statusChip">Ikke startet</div>
</div>

<!-- Top metrics -->
<div class="top-metrics">
<div class="metric">
<div class="metric-label">
‚è± Varighed
</div>
<div class="metric-value big" id="elapsedTime">00:00:00</div>
<div class="pill" id="elapsedHoursLabel">0,0 timer</div>
</div>
<div class="metric">
<div class="metric-label">
‚öñÔ∏è Samlet v√¶gttab
</div>
<div class="metric-value big" id="weightLossGrams">0 g</div>
<div class="pill" id="weightLossKilos">0,000 kg</div>
</div>
</div>

<!-- Gauge -->
<div class="gauge-wrapper">
<div class="gauge-shell">
<div class="gauge-arc"></div>
<div class="gauge-inner"></div>
<div class="gauge-indicator" id="gaugeIndicator"></div>
<div class="gauge-center-cap"></div>
</div>
<div class="gauge-label-row">
<span>
<span class="gauge-label-dot green"></span>
<span>Blid fedtforbr√¶nding</span>
</span>
<span>
<span class="gauge-label-dot yellow"></span>
<span>H√∏j</span>
</span>
<span>
<span class="gauge-label-dot red"></span>
<span>Max boost</span>
</span>
</div>
<div class="gauge-boost">
<div class="gauge-boost-main">
Fedt-boost: <span id="fatBoost">1,0√ó</span>
</div>
<div class="gauge-boost-sub">
Jo l√¶ngere du faster, jo st√∏rre andel af energien kommer fra fedt.
</div>
</div>
</div>

<div class="divider"></div>

<!-- Energy breakdown -->
<div class="energy-bars">
<div class="energy-row">
<div class="energy-label">
<span class="color-dot" style="background: var(--fat);"></span>
<span>Fedt</span>
</div>
<div class="energy-bar">
<div class="energy-fill" id="fatFill" style="background: linear-gradient(to right, #22c55e, #4ade80);"></div>
</div>
<div class="energy-value" id="fatPct">0%</div>
</div>
<div class="energy-row">
<div class="energy-label">
<span class="color-dot" style="background: var(--carb);"></span>
<span>Kulhydrat</span>
</div>
<div class="energy-bar">
<div class="energy-fill" id="carbFill" style="background: linear-gradient(to right, #eab308, #facc15);"></div>
</div>
<div class="energy-value" id="carbPct">0%</div>
</div>
<div class="energy-row">
<div class="energy-label">
<span class="color-dot" style="background: var(--muscle);"></span>
<span>Muskler</span>
</div>
<div class="energy-bar">
<div class="energy-fill" id="muscleFill" style="background: linear-gradient(to right, #fb7185, #f97373);"></div>
</div>
<div class="energy-value" id="musclePct">0%</div>
</div>
<div class="energy-row">
<div class="energy-label">
<span class="color-dot" style="background: var(--bone);"></span>
<span>Knogler</span>
</div>
<div class="energy-bar">
<div class="energy-fill" id="boneFill" style="background: linear-gradient(to right, #f97316, #fb923c);"></div>
</div>
<div class="energy-value" id="bonePct">0%</div>
</div>
</div>

<!-- Autofagi & badges & stats -->
<div class="info-grid">
<div class="info-box">
<div class="info-title">
üß¨ Autofagi
</div>
<div id="autophagyInfo">
<div>Forventet start: ca. 16 timer uden mad.</div>
<div id="autophagyCountdown">Tid til autofagi: ‚Äì</div>
<div id="autophagyActive">Timer i autofagi: 0,0</div>
</div>
<div class="auto-key">
Autofagi = kroppens ‚Äúoprydning‚Äù af slidte celler og affaldsprodukter. Effekten er groft modelleret og ikke personlig medicinsk r√•dgivning.
</div>
</div>
<div class="info-box">
<div class="info-title">
üèÖ Dine badges
</div>
<div class="badge-row" id="badgeRow">
<span class="badge">
<span class="badge-icon">‚¨ú</span>
Ingen badges endnu ‚Äì start en faste
</span>
</div>
<div class="auto-key">
<strong>Faste-badge:</strong> efter 12 timer.
<strong>Autofagi-badge:</strong> efter 16 timer.
</div>
</div>
</div>

<div class="divider"></div>

<div class="info-grid">
<div class="info-box">
<div class="info-title">
üìä Historik (gemte faster)
</div>
<div id="historySummary" style="font-size:0.75rem; margin-bottom:4px;">
Ingen gemte faster endnu.
</div>
<div class="history-list" id="historyList"></div>
</div>
<div class="info-box">
<div class="info-title">
‚ÑπÔ∏è Kort forklaring
</div>
<div style="font-size:0.72rem; color:var(--subtle); line-height:1.35;">
‚Ä¢ V√¶gttabet er et forsigtigt estimat baseret p√• din v√¶gt, alder, muskelmasse og hvor stor andel af energien, der kommer fra fedt over tid.<br/>
‚Ä¢ I starten kommer mest energi fra kulhydrat-lagre. L√¶ngere inde i fasten stiger fedt-andelen ‚Äì og dermed dit ‚Äúfedt-boost‚Äù.<br/>
‚Ä¢ Tallene er forenklede og kan afvige fra din virkelighed. Se dem som motivation, ikke som pr√¶cis m√•ling.
</div>
</div>
</div>
</div>

<!-- RIGHT: PROFILE + CONTROLS -->
<div class="profile-card">
<div class="card-header">
<div class="card-title">
<span class="dot"></span>
Din profil & start
</div>
<div class="chip" id="bmrChip">Dagligt forbrug: ‚Äì</div>
</div>

<div class="profile-grid">
<div>
<div class="field-group">
<div class="field-label">K√∏n</div>
<select id="gender">
<option value="male">Mand</option>
<option value="female">Kvinde</option>
<option value="other">Andet / vil ikke sige</option>
</select>
</div>

<div class="field-group">
<div class="field-label">Alder</div>
<select id="ageGroup">
<option value="18-29">18‚Äì29</option>
<option value="30-39">30‚Äì39</option>
<option value="40-49">40‚Äì49</option>
<option value="50-59" selected>50‚Äì59</option>
<option value="60-69">60‚Äì69</option>
<option value="70+">70+</option>
</select>
</div>

<div class="field-group">
<div class="field-label">V√¶gt (kg)</div>
<input type="number" id="weight" min="40" max="200" step="0.5" value="85" />
<div class="help-text">
Brug gerne din reelle kropsv√¶gt ‚Äì det g√∏r estimaterne mere brugbare.
</div>
</div>

<div class="field-group">
<div class="field-label">Muskelmasse</div>
<select id="muscleLevel">
<option value="low">Lav / stillesiddende</option>
<option value="normal" selected>Normal</option>
<option value="high">H√∏j / meget muskul√∏s</option>
</select>
<div class="help-text">
H√∏j muskelmasse = h√∏jere dagligt energiforbrug.
</div>
</div>
</div>

<div>
<div class="field-group">
<div class="field-label">
Allerede i gang?
</div>
<div class="field-inline">
<div>
<input type="number" id="alreadyHours" min="0" max="72" step="0.25" value="0" />
</div>
<div>
<div class="help-text">
Hvor mange timer siden er det, du sidst spiste?<br />
(0 = jeg starter nu)
</div>
</div>
</div>
</div>

<div class="field-group">
<div class="field-label">Faste-kontrol</div>
<div class="controls">
<button class="btn-primary" id="startBtn">
<span class="icon">‚ñ∂Ô∏è</span>
Start / genoptag faste
</button>
<button class="btn-secondary" id="stopBtn" disabled>
<span class="icon">‚èπ</span>
Stop og evt. gem
</button>
</div>
<div class="help-text">
N√•r du stopper, kan du v√¶lge at gemme fasten i din historik (kr√¶ver min. 12 timers faste).
</div>
<div class="warning-text" id="shortFastWarning" style="display:none;">
Fasten er under 12 timer ‚Äì den kan ikke gemmes i historikken.
</div>
</div>
</div>
</div>

<div class="footer-note">
Denne app er kun til motivation og selv-eksperimenter. Den kan ikke erstatte l√¶gefaglig r√•dgivning.
S√∏g altid l√¶ge, hvis du er i tvivl, har sygdom, er p√• medicin eller har haft spiseforstyrrelser.
</div>
</div>
</div>
</div>

<script>
// ----------- STATE & PERSISTENCE -----------
const STORAGE_KEY = "fastAppState_v42";

let state = {
version: 42,
profile: {
gender: "male",
ageGroup: "50-59",
weight: 85,
muscleLevel: "normal",
},
startTime: null, // ISO string
offsetSeconds: 0, // allerede-fastet tid i sekunder ved start
isRunning: false,
history: [],
};

function loadState() {
try {
const raw = localStorage.getItem(STORAGE_KEY);
if (!raw) return;
const saved = JSON.parse(raw);
if (!saved || typeof saved !== "object") return;

// basic merge
state = {
...state,
...saved,
profile: { ...state.profile, ...(saved.profile || {}) },
history: Array.isArray(saved.history) ? saved.history : [],
};

// Re-hydrate UI
if (state.profile) {
document.getElementById("gender").value = state.profile.gender || "male";
document.getElementById("ageGroup").value = state.profile.ageGroup || "50-59";
document.getElementById("weight").value = state.profile.weight ?? 85;
document.getElementById("muscleLevel").value = state.profile.muscleLevel || "normal";
}

updateBmrDisplay();
renderHistorySummary();
} catch (e) {
console.error("Kunne ikke loade state:", e);
}
}

function saveState() {
try {
localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
} catch (e) {
console.error("Kunne ikke gemme state:", e);
}
}

// ----------- PROFILE & BMR ESTIMATE -----------
function getNumericAge(ageGroup) {
switch (ageGroup) {
case "18-29": return 25;
case "30-39": return 35;
case "40-49": return 45;
case "50-59": return 55;
case "60-69": return 65;
case "70+": return 75;
default: return 40;
}
}

function estimateDailyEnergy(profile) {
const weight = profile.weight || 80;
const ageGroup = profile.ageGroup || "40-49";
const gender = profile.gender || "male";
const muscleLevel = profile.muscleLevel || "normal";

// Grov TDEE-model baseret prim√¶rt p√• v√¶gt + muskulatur
let factor = 28; // kcal/kg/d√∏gn baseline
if (muscleLevel === "high") factor = 31;
if (muscleLevel === "low") factor = 25;

let tdee = weight * factor;

// K√∏n
if (gender === "female") tdee *= 0.9;
if (gender === "other") tdee *= 0.95;

// Alder
const age = getNumericAge(ageGroup);
if (age >= 50 && age < 60) tdee *= 0.95;
else if (age >= 60 && age < 70) tdee *= 0.9;
else if (age >= 70) tdee *= 0.85;

return Math.max(1400, Math.round(tdee));
}

function updateBmrDisplay() {
const daily = estimateDailyEnergy(state.profile);
const chip = document.getElementById("bmrChip");
chip.textContent = `Dagligt forbrug: ca. ${daily.toLocaleString("da-DK")} kcal`;
}

// ----------- FASTING MODEL -----------
function getFastingHours(nowSec) {
if (!state.startTime) return 0;
const start = new Date(state.startTime).getTime() / 1000;
const elapsed = nowSec - start + (state.offsetSeconds || 0);
return Math.max(0, elapsed / 3600);
}

function formatTime(totalSeconds) {
const s = Math.max(0, Math.floor(totalSeconds));
const h = Math.floor(s / 3600);
const m = Math.floor((s % 3600) / 60);
const sec = s % 60;
const pad = (x) => String(x).padStart(2, "0");
return `${pad(h)}:${pad(m)}:${pad(sec)}`;
}

// Modeller andel energi fra fedt som funktion af timer
function fatShareAtHour(h) {
if (h <= 0) return 0.10;
if (h <= 4) {
// 0-4 timer: 10% -> 15%
const t = h / 4;
return 0.10 + t * (0.15 - 0.10);
}
if (h <= 12) {
// 4-12 timer: 15% -> 50%
const t = (h - 4) / 8;
return 0.15 + t * (0.50 - 0.15);
}
if (h <= 24) {
// 12-24 timer: 50% -> 80%
const t = (h - 12) / 12;
return 0.50 + t * (0.80 - 0.50);
}
if (h <= 36) {
// 24-36 timer: 80% -> 90%
const t = (h - 24) / 12;
return 0.80 + t * (0.90 - 0.80);
}
// >36 timer: ca. 90% fra fedt
return 0.90;
}

function muscleBoneShareAtHour(h) {
let muscle = 0;
let bone = 0;
if (h > 24 && h <= 48) {
muscle = ((h - 24) / 24) * 0.03; // op til 3%
} else if (h > 48) {
muscle = 0.03 + Math.min((h - 48) / 24, 1) * 0.02; // op til 5%
bone = Math.min((h - 48) / 24, 1) * 0.03; // op til 3%
}
return { muscle, bone };
}

function energyBreakdown(h) {
const fat = fatShareAtHour(h);
const { muscle, bone } = muscleBoneShareAtHour(h);
let carb = 1 - fat - muscle - bone;
if (carb < 0) carb = 0;
return { fat, carb, muscle, bone };
}

function averageFatShare(h) {
if (h <= 0) return 0.10;
const fNow = fatShareAtHour(h);
// simpel gennemsnit mellem start og nu
return (0.10 + fNow) / 2;
}

function estimateWeightLossGrams(h, dailyEnergyKcal) {
if (h <= 0) return 0;
const avgFat = averageFatShare(h);
const totalEnergy = (dailyEnergyKcal * h) / 24; // kcal
const fatEnergy = totalEnergy * avgFat;
const gramsFat = fatEnergy / 7.7; // 1g fedt ‚âà 7,7 kcal
return gramsFat;
}

function getFatBoost(fatShare) {
const baseline = 0.10; // "normal" hverdag
if (fatShare <= 0) return 1;
return fatShare / baseline;
}

// ----------- HISTORY -----------
function addHistoryEntry(entry) {
state.history.unshift(entry);
// begr√¶ns til fx 50 entries
if (state.history.length > 50) state.history.pop();
saveState();
renderHistorySummary();
}

function renderHistorySummary() {
const summaryEl = document.getElementById("historySummary");
const listEl = document.getElementById("historyList");
const history = state.history || [];

if (!history.length) {
summaryEl.textContent = "Ingen gemte faster endnu.";
listEl.innerHTML = "";
return;
}

let totalFat = 0;
let totalHours = 0;
let totalAuto = 0;
const now = Date.now();

history.forEach((h) => {
totalFat += h.gramsFat || 0;
totalHours += h.hours || 0;
totalAuto += h.autophagyHours || 0;
});

summaryEl.innerHTML =
`Gemte faster: <strong>${history.length}</strong><br/>` +
`Samlet v√¶gttab: <strong>${totalFat.toFixed(0)} g</strong> ¬∑ ` +
`Samlet fastetid: <strong>${totalHours.toFixed(1)} timer</strong><br/>` +
`Tid i autofagi (estimat): <strong>${totalAuto.toFixed(1)} timer</strong>`;

listEl.innerHTML = "";
history.slice(0, 12).forEach((h) => {
const li = document.createElement("div");
li.className = "history-item";

const dt = new Date(h.endedAt || now);
const dateStr = dt.toLocaleDateString("da-DK", {
day: "2-digit",
month: "2-digit",
year: "2-digit",
});

const timeStr = dt.toLocaleTimeString("da-DK", {
hour: "2-digit",
minute: "2-digit",
});

li.innerHTML = `
<div class="history-main">
<div>${h.hours.toFixed(1)} t ¬∑ ${Math.round(h.gramsFat)} g</div>
<div style="color:var(--subtle);">Autofagi: ${h.autophagyHours.toFixed(1)} t</div>
</div>
<div class="history-sub">
<div>${dateStr}</div>
<div>${timeStr}</div>
</div>
`;
listEl.appendChild(li);
});
}

// ----------- UI UPDATE LOOP -----------
let tickInterval = null;

function updateUI() {
const nowSec = Date.now() / 1000;
const hours = getFastingHours(nowSec);
const seconds = hours * 3600;

// Top metrics
document.getElementById("elapsedTime").textContent = formatTime(seconds);
document.getElementById("elapsedHoursLabel").textContent =
hours.toFixed(1).replace(".", ",") + " timer";

// Energy / weight
const breakdown = energyBreakdown(hours);
const daily = estimateDailyEnergy(state.profile);
const gramsFat = estimateWeightLossGrams(hours, daily);

document.getElementById("weightLossGrams").textContent =
Math.round(gramsFat) + " g";
document.getElementById("weightLossKilos").textContent =
(gramsFat / 1000).toFixed(3).replace(".", ",") + " kg";

// Gauge
const fatBoost = getFatBoost(breakdown.fat);
const boostText = fatBoost.toFixed(1).replace(".", ",") + "√ó";
document.getElementById("fatBoost").textContent = boostText;

// Gauge indicator: map boost (1‚Äì9+) til -90¬∞ til +90¬∞
let normalizedBoost = Math.max(1, Math.min(fatBoost, 9));
const angle = -90 + ((normalizedBoost - 1) / 8) * 180;
const indicator = document.getElementById("gaugeIndicator");
indicator.style.transform = `rotate(${angle}deg)`;

// Energy bars
function setBar(idFill, idPct, value) {
const pct = Math.round(value * 100);
const elFill = document.getElementById(idFill);
const elPct = document.getElementById(idPct);
const clamped = Math.max(0, Math.min(100, pct));
elFill.style.transform = `scaleX(${clamped / 100})`;
elPct.textContent = clamped + "%";
}

setBar("fatFill", "fatPct", breakdown.fat);
setBar("carbFill", "carbPct", breakdown.carb);
setBar("muscleFill", "musclePct", breakdown.muscle);
setBar("boneFill", "bonePct", breakdown.bone);

// Autofagi
const autoStart = 16;
let autoHours = 0;
let timeToAuto = 0;
if (hours >= autoStart) {
autoHours = hours - autoStart;
timeToAuto = 0;
} else {
timeToAuto = autoStart - hours;
}

const autoCountdownEl = document.getElementById("autophagyCountdown");
const autoActiveEl = document.getElementById("autophagyActive");

if (timeToAuto > 0) {
autoCountdownEl.textContent =
"Tid til autofagi: " + timeToAuto.toFixed(1).replace(".", ",") + " timer";
} else {
autoCountdownEl.textContent = "Tid til autofagi: 0,0 timer (allerede i gang)";
}

autoActiveEl.textContent =
"Timer i autofagi: " + Math.max(0, autoHours).toFixed(1).replace(".", ",");
autoActiveEl.style.color = hours >= autoStart ? "#4ade80" : "var(--subtle)";

// Badges
const badgeRow = document.getElementById("badgeRow");
badgeRow.innerHTML = "";
let hasBadge = false;

if (hours >= 12) {
const b = document.createElement("span");
b.className = "badge gold";
b.innerHTML = `<span class="badge-icon">ü•á</span> Faste-badge (12+ timer)`;
badgeRow.appendChild(b);
hasBadge = true;
}
if (hours >= autoStart) {
const b2 = document.createElement("span");
b2.className = "badge blue";
b2.innerHTML = `<span class="badge-icon">üß¨</span> Autofagi-badge (16+ timer)`;
badgeRow.appendChild(b2);
hasBadge = true;
}
if (!hasBadge) {
const b3 = document.createElement("span");
b3.className = "badge";
b3.innerHTML = `<span class="badge-icon">‚¨ú</span> Ingen badges endnu ‚Äì hold fast lidt l√¶ngere`;
badgeRow.appendChild(b3);
}

// Status chip
const statusChip = document.getElementById("statusChip");
if (!state.startTime) {
statusChip.textContent = "Ikke startet";
statusChip.style.color = "var(--subtle)";
statusChip.style.borderColor = "rgba(148, 163, 184, 0.35)";
} else if (state.isRunning) {
statusChip.textContent = "Faste k√∏rer";
statusChip.style.color = "#bbf7d0";
statusChip.style.borderColor = "rgba(34, 197, 94, 0.8)";
} else {
statusChip.textContent = "Sat p√• stop";
statusChip.style.color = "#fde68a";
statusChip.style.borderColor = "rgba(234, 179, 8, 0.8)";
}

// Kort advarsel, hvis under 12 timer (kun info ‚Äì gem-logikken ligger i stopHandler)
const warnEl = document.getElementById("shortFastWarning");
if (hours > 0 && hours < 12) {
warnEl.style.display = "block";
warnEl.textContent = "Fasten er under 12 timer ‚Äì den kan stoppes, men vil ikke blive gemt som officiel faste.";
} else {
warnEl.style.display = "none";
}
}

function startTicking() {
if (tickInterval) clearInterval(tickInterval);
tickInterval = setInterval(() => {
updateUI();
saveState();
}, 1000);
updateUI();
}

// ----------- EVENT HANDLERS -----------
function handleProfileChange() {
const gender = document.getElementById("gender").value;
const ageGroup = document.getElementById("ageGroup").value;
const weight = parseFloat(document.getElementById("weight").value) || 80;
const muscleLevel = document.getElementById("muscleLevel").value;

state.profile = {
gender,
ageGroup,
weight,
muscleLevel,
};
updateBmrDisplay();
saveState();
updateUI();
}

function handleStart() {
// L√¶s profil
handleProfileChange();
const already = parseFloat(document.getElementById("alreadyHours").value) || 0;
const now = new Date();

if (!state.startTime) {
state.startTime = now.toISOString();
state.offsetSeconds = already * 3600;
} else if (!state.isRunning) {
// genoptag fra tidligere startTime + offsetSeconds (vi √¶ndrer ikke startTime, s√• historik bevares)
// men vi kan opdatere offset, hvis brugeren manuelt har justeret "allerede i gang"
state.offsetSeconds = already * 3600;
state.startTime = now.toISOString();
}

state.isRunning = true;

document.getElementById("startBtn").disabled = true;
document.getElementById("stopBtn").disabled = false;

saveState();
startTicking();
}

function handleStop() {
if (!state.startTime) return;

const nowSec = Date.now() / 1000;
const hours = getFastingHours(nowSec);

state.isRunning = false;

document.getElementById("startBtn").disabled = false;
document.getElementById("stopBtn").disabled = true;

// Gem / ikke gem logik
let saved = false;
if (hours >= 12) {
const daily = estimateDailyEnergy(state.profile);
const gramsFat = estimateWeightLossGrams(hours, daily);
const autoHours = Math.max(0, hours - 16);

const wantSave = confirm(
`Fasten har varet ${hours.toFixed(1).replace(".", ",")} timer.\n` +
`Estimeret v√¶gttab: ca. ${Math.round(gramsFat)} g.\n\n` +
`Vil du gemme denne faste i din historik?`
);

if (wantSave) {
addHistoryEntry({
hours,
gramsFat,
autophagyHours: autoHours > 0 ? autoHours : 0,
endedAt: Date.now(),
});
saved = true;
}
} else {
alert(
"Fasten er under 12 timer, s√• den gemmes ikke i historikken.\n\n" +
"Du kan stadig starte en ny faste, n√•r du vil."
);
}

saveState();
updateUI();

// Vi nulstiller IKKE state.startTime osv. ‚Äì s√• man kan se sidste resultat,
// men historik er kun opdateret, hvis der blev gemt.
}

// ----------- INIT -----------
function init() {
// Input events
["gender", "ageGroup", "weight", "muscleLevel"].forEach((id) => {
document.getElementById(id).addEventListener("change", handleProfileChange);
});
document.getElementById("alreadyHours").addEventListener("change", () => {
// bare gem i state, s√• brugeren ikke mister tallet
const v = parseFloat(document.getElementById("alreadyHours").value) || 0;
state.offsetSeconds = v * 3600;
saveState();
});

document.getElementById("startBtn").addEventListener("click", handleStart);
document.getElementById("stopBtn").addEventListener("click", handleStop);

loadState();
updateBmrDisplay();

// Hvis der var en aktiv faste, genoptag ticking
if (state.startTime && state.isRunning) {
document.getElementById("startBtn").disabled = true;
document.getElementById("stopBtn").disabled = false;
startTicking();
} else if (state.startTime) {
// vis sidste kendte status
updateUI();
} else {
updateUI();
}
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
