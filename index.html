<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8" />
<title>Faste-tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
:root {
--bg: #050816;
--card: #0e1529;
--card-soft: #141b33;
--accent: #ff6b3d;
--accent-soft: #ffb347;
--accent-strong: #ff2d55;
--text-main: #ffffff;
--text-dim: #a7b3d9;
--border-subtle: #252d4a;
--green: #3dd68c;
--yellow: #ffc857;
--red: #ff4b5c;
--chip-bg: #121a30;
--chip-border: #283253;
--shadow-soft: 0 18px 45px rgba(0,0,0,0.55);
--radius-card: 18px;
--radius-inner: 12px;
--transition-fast: 0.18s ease-out;
--font-sans: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
"SF Pro Display", "Segoe UI", Roboto, sans-serif;
}

* {
box-sizing: border-box;
}

html, body {
margin: 0;
padding: 0;
min-height: 100vh;
}

body {
font-family: var(--font-sans);
background:
radial-gradient(circle at top, #222b4a 0, #050816 55%, #02000a 100%);
color: var(--text-main);
overflow-x: hidden;
overflow-y: auto;
}

.app {
max-width: 960px;
margin: 0 auto;
padding: 16px 16px 40px;
}

@media (min-width: 768px) {
.app {
padding: 24px 24px 60px;
}
}

h1 {
font-size: 26px;
margin: 0 0 6px;
letter-spacing: 0.02em;
}

.subtitle {
font-size: 13px;
color: var(--text-dim);
margin-bottom: 18px;
}

.pill {
display: inline-flex;
align-items: center;
gap: 6px;
padding: 4px 10px;
border-radius: 999px;
font-size: 11px;
background: rgba(255,255,255,0.05);
color: var(--text-dim);
}

.pill-dot {
width: 6px;
height: 6px;
border-radius: 50%;
background: var(--accent);
}

/* Cards */
.card {
background: radial-gradient(circle at top, #1b2440 0, #090f20 70%);
border-radius: var(--radius-card);
border: 1px solid rgba(255,255,255,0.03);
box-shadow: var(--shadow-soft);
padding: 16px 14px 18px;
margin-bottom: 16px;
position: relative;
overflow: hidden;
}

.card::before {
content: "";
position: absolute;
inset: 0;
background:
radial-gradient(circle at top left, rgba(255,255,255,0.06), transparent 55%);
opacity: 0.75;
pointer-events: none;
mix-blend-mode: screen;
}

.card-inner {
position: relative;
z-index: 1;
}

.card-header {
display: flex;
align-items: center;
justify-content: space-between;
gap: 8px;
margin-bottom: 10px;
}

.card-title {
font-size: 15px;
font-weight: 600;
}

.card-subtitle {
font-size: 11px;
color: var(--text-dim);
}

.small-btn {
border: none;
border-radius: 999px;
font-size: 11px;
padding: 3px 10px;
background: rgba(255,255,255,0.06);
color: var(--text-main);
cursor: pointer;
display: inline-flex;
align-items: center;
gap: 6px;
}

.small-btn span.dot {
width: 7px;
height: 7px;
border-radius: 50%;
background: var(--green);
}

.small-btn.secondary {
background: transparent;
border: 1px solid rgba(255,255,255,0.1);
color: var(--text-dim);
}

/* Profile section */
.profile-grid {
display: grid;
grid-template-columns: minmax(0,1fr);
gap: 10px;
}

@media (min-width: 640px) {
.profile-grid {
grid-template-columns: repeat(2,minmax(0,1fr));
}
}

.field {
display: flex;
flex-direction: column;
gap: 3px;
font-size: 12px;
}

.field label {
color: var(--text-dim);
font-size: 11px;
}

select, input[type="number"] {
background: var(--card-soft);
border-radius: 999px;
border: 1px solid var(--border-subtle);
padding: 7px 11px;
color: var(--text-main);
font-size: 13px;
outline: none;
appearance: none;
width: 100%;
}

select:focus, input[type="number"]:focus {
border-color: var(--accent-soft);
box-shadow: 0 0 0 1px rgba(255,179,71,0.35);
}

.calorie-chip {
margin-top: 4px;
font-size: 12px;
color: var(--accent-soft);
display: inline-flex;
align-items: center;
gap: 6px;
}

.calorie-chip span.badge {
border-radius: 999px;
border: 1px solid rgba(255,255,255,0.16);
padding: 2px 8px;
font-size: 11px;
}

/* Fasting overview layout */
.overview-layout {
display: grid;
grid-template-columns: minmax(0,1.1fr) minmax(0,1fr);
gap: 12px;
}

@media (max-width: 720px) {
.overview-layout {
grid-template-columns: minmax(0,1fr);
}
}

.timer-main {
font-size: 30px;
font-variant-numeric: tabular-nums;
letter-spacing: 0.04em;
margin-bottom: 4px;
}

.timer-label {
font-size: 11px;
color: var(--text-dim);
}

.timer-secondary {
font-size: 13px;
margin-top: 4px;
margin-bottom: 8px;
}

.timer-secondary span {
font-variant-numeric: tabular-nums;
}

.weight-badge {
margin-top: 8px;
display: inline-flex;
align-items: center;
gap: 8px;
padding: 8px 11px;
border-radius: 12px;
background: linear-gradient(145deg,#ff7a45,#ffb347);
color: #1b0c08;
box-shadow: 0 10px 25px rgba(0,0,0,0.5);
}

.weight-icon {
width: 26px;
height: 26px;
border-radius: 7px;
background: radial-gradient(circle at 30% 20%,#fff, #ffe4c4);
border: 1px solid rgba(0,0,0,0.2);
display: flex;
align-items: center;
justify-content: center;
position: relative;
overflow: hidden;
}

.weight-icon::before {
content: "";
position: absolute;
inset: 40% 15% 8%;
border-radius: 4px;
border: 2px solid #b75b27;
border-top: none;
}

.weight-icon::after {
content: "";
position: absolute;
top: 18%;
left: 32%;
width: 36%;
height: 32%;
border-radius: 4px 4px 3px 3px;
border: 2px solid #b75b27;
background: rgba(255,255,255,0.7);
}

.weight-text-main {
font-size: 14px;
font-weight: 600;
}

.weight-text-sub {
font-size: 11px;
}

.label-small {
font-size: 11px;
color: var(--text-dim);
margin-top: 6px;
}

/* Speedometer */
.speedometer-card {
background: radial-gradient(circle at top,#1a213b 0,#070b16 70%);
border-radius: var(--radius-inner);
border: 1px solid rgba(255,255,255,0.06);
padding: 10px 10px 14px;
}

.speedometer-title {
font-size: 11px;
color: var(--text-dim);
margin-bottom: 4px;
display: flex;
justify-content: space-between;
align-items: center;
}

.speedometer {
position: relative;
width: 100%;
aspect-ratio: 2 / 1.2;
max-width: 260px;
margin: 2px auto 2px;
}

.speedometer-arc {
position: absolute;
inset: 10% 6% 0;
border-radius: 999px 999px 0 0;
background:
conic-gradient(
from 180deg,
var(--red) 0deg 45deg,
var(--yellow) 45deg 115deg,
var(--green) 115deg 180deg,
#111827 180deg 360deg
);
mask:
radial-gradient(circle at 50% 100%, transparent 55%, black 55%);
-webkit-mask:
radial-gradient(circle at 50% 100%, transparent 55%, black 55%);
}

.speedometer-inner {
position: absolute;
inset: 18% 14% 4%;
border-radius: 999px 999px 10px 10px;
background: radial-gradient(circle at top,#020617,#02000b);
border: 1px solid rgba(255,255,255,0.06);
}

.speedometer-needle {
position: absolute;
bottom: 4%;
left: 50%;
width: 2px;
height: 52%;
background: #f9fafb;
transform-origin: 50% 100%;
transform: rotate(210deg);
transition: transform var(--transition-fast);
box-shadow: 0 0 6px rgba(255,255,255,0.6);
}

.speedometer-hub {
position: absolute;
bottom: 4%;
left: 50%;
width: 12px;
height: 12px;
border-radius: 50%;
transform: translate(-50%,50%);
background: radial-gradient(circle,#ffffff,#9ca3af);
box-shadow: 0 0 10px rgba(255,255,255,0.7);
}

.speedometer-labels {
position: absolute;
inset: 5% 3% 0;
pointer-events: none;
font-size: 9px;
color: var(--text-dim);
display: flex;
justify-content: space-between;
align-items: flex-start;
padding: 0 4px;
}

.speedometer-labels span:nth-child(2) {
transform: translateY(-4px);
}

.boost-label {
font-size: 11px;
color: var(--accent-soft);
text-align: center;
margin-top: 4px;
}

/* Autofagi card */
.autophagy-card {
margin-top: 10px;
background: radial-gradient(circle at left,#1f2937 0,#020617 70%);
border-radius: var(--radius-inner);
border: 1px solid rgba(248,113,113,0.55);
padding: 8px 10px;
display: flex;
gap: 10px;
align-items: center;
}

.autophagy-icon {
width: 30px;
height: 30px;
border-radius: 10px;
background: linear-gradient(145deg,#ef4444,#f97316);
display: flex;
align-items: center;
justify-content: center;
position: relative;
box-shadow: 0 10px 18px rgba(0,0,0,0.6);
}

.autophagy-icon::before {
content: "";
width: 16px;
height: 16px;
border-radius: 50%;
background: #fef2f2;
position: absolute;
box-shadow: 0 0 6px rgba(248,250,252,0.9);
}

.autophagy-icon::after {
content: "";
position: absolute;
width: 8px;
height: 2px;
background: #ef4444;
border-radius: 999px;
box-shadow: 0 -6px 0 0 #ef4444;
}

.autophagy-text-main {
font-size: 12px;
font-weight: 500;
}

.autophagy-text-sub {
font-size: 11px;
color: var(--text-dim);
}

.autophagy-badge {
font-size: 10px;
padding: 2px 6px;
border-radius: 999px;
border: 1px solid rgba(248,250,252,0.35);
margin-bottom: 2px;
display: inline-block;
}

.autophagy-ok {
color: var(--green);
border-color: rgba(74,222,128,0.6);
}

/* Energy chips */
.energy-row {
margin-top: 10px;
display: grid;
grid-template-columns: repeat(4,minmax(0,1fr));
gap: 6px;
}

.energy-chip {
background: var(--chip-bg);
border-radius: 999px;
padding: 6px 6px 5px;
border: 1px solid var(--chip-border);
font-size: 10px;
text-align: center;
display: flex;
flex-direction: column;
gap: 2px;
}

.energy-label {
color: var(--text-dim);
}

.energy-value {
font-size: 12px;
font-variant-numeric: tabular-nums;
}

/* Controls & activity */
.controls-row {
margin-top: 10px;
display: flex;
flex-wrap: wrap;
gap: 6px;
}

.btn-main {
flex: 1 1 110px;
padding: 8px 10px;
border-radius: 999px;
border: none;
font-size: 13px;
font-weight: 500;
cursor: pointer;
background: linear-gradient(135deg,#22c55e,#4ade80);
color: #022c14;
box-shadow: 0 10px 18px rgba(34,197,94,0.4);
display: inline-flex;
align-items: center;
justify-content: center;
gap: 6px;
}

.btn-main.stop {
flex: 0 0 auto;
background: rgba(248,113,113,0.1);
color: #fecaca;
border: 1px solid rgba(248,113,113,0.6);
box-shadow: none;
}

.btn-main.pause {
background: linear-gradient(135deg,#f97316,#fdba74);
color: #3b0b0b;
box-shadow: 0 10px 18px rgba(248,113,113,0.35);
}

.btn-main:active {
transform: translateY(1px);
box-shadow: none;
}

.activity-grid {
margin-top: 12px;
display: grid;
grid-template-columns: minmax(0,1fr);
gap: 8px;
font-size: 11px;
}

@media (min-width: 640px) {
.activity-grid {
grid-template-columns: repeat(2,minmax(0,1fr));
}
}

.activity-box {
background: rgba(15,23,42,0.9);
border-radius: 12px;
padding: 8px 9px;
border: 1px solid rgba(255,255,255,0.07);
}

.activity-title {
font-size: 11px;
margin-bottom: 4px;
color: var(--text-dim);
}

.activity-row {
display: flex;
gap: 6px;
align-items: center;
}

.activity-row input {
flex: 1;
border-radius: 999px;
background: #020617;
border: 1px solid var(--border-subtle);
color: var(--text-main);
padding: 6px 8px;
font-size: 12px;
}

.activity-add {
border-radius: 999px;
border: none;
padding: 6px 9px;
background: rgba(56,189,248,0.12);
color: #7dd3fc;
font-size: 11px;
cursor: pointer;
white-space: nowrap;
}

.activity-summary {
margin-top: 4px;
font-size: 11px;
color: var(--text-dim);
}

/* Small status text */
.status-row {
display: flex;
justify-content: space-between;
align-items: center;
margin-top: 4px;
font-size: 11px;
color: var(--text-dim);
}

.status-pill {
padding: 2px 8px;
border-radius: 999px;
border: 1px solid rgba(255,255,255,0.12);
font-size: 10px;
}

.status-pill.good {
border-color: rgba(74,222,128,0.7);
color: var(--green);
}

.status-pill.warn {
border-color: rgba(248,113,113,0.7);
color: var(--accent-strong);
}
</style>
</head>
<body>
<div class="app">
<header style="margin-bottom: 10px;">
<div class="pill" style="margin-bottom: 6px;">
<span class="pill-dot"></span>
Beta ‚Äì personlig faste-tracker
</div>
<h1>Faste-tracker</h1>
<p class="subtitle">
Start n√•r du tager sidste bid mad ‚Äì appen fors√∏ger at huske din faste,
ogs√• n√•r du lukker den.
</p>
</header>

<!-- Profil -->
<section class="card">
<div class="card-inner">
<div class="card-header">
<div>
<div class="card-title">Profil &amp; styring</div>
<div class="card-subtitle">Bruges til at g√¶tte kaloriebehov og hastighed.</div>
</div>
<button class="small-btn secondary" id="resetProfileBtn">Nulstil profil</button>
</div>

<div class="profile-grid">
<div class="field">
<label for="ageGroup">Aldersgruppe</label>
<select id="ageGroup">
<option value="18-29">18‚Äì29</option>
<option value="30-39">30‚Äì39</option>
<option value="40-49">40‚Äì49</option>
<option value="50-59" selected>50‚Äì59</option>
<option value="60-69">60‚Äì69</option>
<option value="70+">70+</option>
</select>
</div>
<div class="field">
<label for="sex">K√∏n</label>
<select id="sex">
<option value="male" selected>Mand</option>
<option value="female">Kvinde</option>
<option value="other">Andet / vil ikke sige</option>
</select>
</div>
<div class="field">
<label for="weight">V√¶gt (kg)</label>
<input id="weight" type="number" min="40" max="200" value="85" />
</div>
<div class="field">
<label for="muscleLevel">Muskel-niveau</label>
<select id="muscleLevel">
<option value="low">Lav / stillesiddende</option>
<option value="normal" selected>Normal</option>
<option value="muscular">Muskul√∏s / atletisk</option>
</select>
</div>
</div>

<div class="calorie-chip">
Dagligt kaloriebehov (model)
<span class="badge"><span id="dailyCalories">2000</span> kcal</span>
</div>
</div>
</section>

<!-- Faste overblik -->
<section class="card">
<div class="card-inner">
<div class="card-header">
<div>
<div class="card-title">Faste-overblik</div>
<div class="card-subtitle" id="stateLabel">Klar til start</div>
</div>
<button class="small-btn" id="infoToggle">
<span class="dot"></span>
Kort forklaring
</button>
</div>

<div id="infoBox" style="display:none;font-size:11px;color:var(--text-dim);margin-bottom:8px;">
Uret viser reel faste-tid (fra sidste m√•ltid) og effektiv faste-tid,
der tager h√∏jde for aktivitet (hurtigere) og et enkelt refeed-m√•ltid (langsommere).
</div>

<div class="overview-layout">
<!-- Tids- og v√¶gtdel -->
<div>
<div class="timer-main" id="realTimer">00:00:00</div>
<div class="timer-label">Reel faste</div>

<div class="timer-secondary">
Effektiv faste (sport / refeed):
<span id="effectiveTimer">00:00:00</span>
</div>

<div class="weight-badge">
<div class="weight-icon"></div>
<div>
<div class="weight-text-main">
<span id="weightLossGrams">0</span> g tabt
</div>
<div class="weight-text-sub">
(model, prim√¶rt fra fedt)
</div>
</div>
</div>

<div class="label-small">
Tidsoversigt:
<span id="hoursSummary">0,0 timer effektiv / 0,0 timer reel</span>
</div>

<div class="status-row">
<span>Medaljer &amp; niveau</span>
<span class="status-pill" id="levelBadge">Ingen medalje</span>
</div>
</div>

<!-- Speedometer -->
<div class="speedometer-card">
<div class="speedometer-title">
<span>Fedtforbr√¶nding lige nu</span>
<span id="speedText">Lav hastighed</span>
</div>
<div class="speedometer">
<div class="speedometer-arc"></div>
<div class="speedometer-inner"></div>
<div class="speedometer-needle" id="speedNeedle"></div>
<div class="speedometer-hub"></div>
<div class="speedometer-labels">
<span>Lav</span>
<span>Midt</span>
<span>Max</span>
</div>
</div>
<div class="boost-label" id="boostLabel">
Booster: 1,0√ó hurtigere end ‚Äúnormalt‚Äù
</div>
</div>
</div>

<!-- Autofagi -->
<div class="autophagy-card" id="autophagyCard">
<div class="autophagy-icon"></div>
<div>
<div class="autophagy-badge" id="autophagyBadge">Autofagi om</div>
<div class="autophagy-text-main" id="autophagyMain">
16 t 00 min
</div>
<div class="autophagy-text-sub">
Hold fasten (og lidt bev√¶gelse) for at n√• oprydnings-fasen i cellerne.
</div>
</div>
</div>

<!-- Energi-kilder -->
<div class="energy-row">
<div class="energy-chip">
<div class="energy-label" style="color:#facc15;">Kulhydrat</div>
<div class="energy-value" id="carbPct">90%</div>
</div>
<div class="energy-chip">
<div class="energy-label" style="color:#4ade80;">Fedt</div>
<div class="energy-value" id="fatPct">10%</div>
</div>
<div class="energy-chip">
<div class="energy-label" style="color:#fb7185;">Muskler</div>
<div class="energy-value" id="musclePct">0%</div>
</div>
<div class="energy-chip">
<div class="energy-label" style="color:#f97373;">Knogle</div>
<div class="energy-value" id="bonePct">0%</div>
</div>
</div>

<!-- Start / stop -->
<div class="controls-row">
<button class="btn-main" id="startBtn">
‚ñ∂ Start faste
</button>
<button class="btn-main pause" id="pauseBtn">
‚ùö‚ùö Pause
</button>
<button class="btn-main stop" id="resetBtn">
‚èπ Stop / nulstil
</button>
</div>

<!-- Allerede i gang -->
<div class="activity-grid" style="margin-top:10px;">
<div class="activity-box">
<div class="activity-title">Allerede i gang?</div>
<div style="font-size:11px;color:var(--text-dim);margin-bottom:4px;">
Angiv hvor mange timer siden du sidst spiste, f√∏r du trykker Start.
</div>
<div class="activity-row">
<input id="initialHours" type="number" min="0" max="72" step="0.5"
placeholder="Timer siden sidste m√•ltid" />
</div>
</div>

<!-- Aktivitet & refeed -->
<div class="activity-box">
<div class="activity-title">Genvej med aktivitet &amp; √©t m√•ltid</div>
<div class="activity-grid" style="grid-template-columns:1fr;">
<div>
<div class="activity-title">Tilf√∏j aktivitet (kcal)</div>
<div class="activity-row">
<input id="activityCalories" type="number" min="0" step="10"
placeholder="fx 400 kcal cykling" />
<button class="activity-add" id="addActivityBtn">+ Aktivitet</button>
</div>
<div class="activity-summary" id="activitySummary">
Aktivitet i alt: 0 kcal (~0,0 ekstra timer)
</div>
</div>
<div>
<div class="activity-title">Refeed-m√•ltid (kcal)</div>
<div class="activity-row">
<input id="refeedCalories" type="number" min="0" step="10"
placeholder="fx 400 kcal lille m√•ltid" />
<button class="activity-add" id="addRefeedBtn">+ Refeed</button>
</div>
<div class="activity-summary" id="refeedSummary">
Refeed i alt: 0 kcal (~0,0 ‚Äústraffe-timer‚Äù)
</div>
</div>
</div>
</div>
</div>

<div class="status-row" style="margin-top:10px;">
<span>Model-noter</span>
<span class="status-pill">
Grov model ‚Äì ikke medicinsk r√•dgivning
</span>
</div>
</div>
</section>
</div>

<script>
// ======= KONSTANTER =======
const STORAGE_KEY = "fastingApp_v25";
const AUTOPHAGY_HOURS = 16;
const OPTIMAL_HOURS = 24;
const MAX_HOURS = 40; // hvor effekten begynder at aftage

// ======= STATE =======
const defaultState = {
profile: {
ageGroup: "50-59",
sex: "male",
weight: 85,
muscleLevel: "normal"
},
dailyCalories: 2000,
elapsedRealMs: 0, // akkumuleret (pause/stop)
runningSince: null, // timestamp (ms) n√•r k√∏rende
totalActivityCalories: 0,
totalRefeedCalories: 0
};

let state = { ...defaultState };

// ======= ELEMENTER =======
const ageGroupEl = document.getElementById("ageGroup");
const sexEl = document.getElementById("sex");
const weightEl = document.getElementById("weight");
const muscleLevelEl = document.getElementById("muscleLevel");
const dailyCaloriesEl = document.getElementById("dailyCalories");

const realTimerEl = document.getElementById("realTimer");
const effectiveTimerEl = document.getElementById("effectiveTimer");
const weightLossGramsEl = document.getElementById("weightLossGrams");
const hoursSummaryEl = document.getElementById("hoursSummary");
const levelBadgeEl = document.getElementById("levelBadge");
const stateLabelEl = document.getElementById("stateLabel");

const speedNeedleEl = document.getElementById("speedNeedle");
const speedTextEl = document.getElementById("speedText");
const boostLabelEl = document.getElementById("boostLabel");

const autophagyCardEl = document.getElementById("autophagyCard");
const autophagyBadgeEl = document.getElementById("autophagyBadge");
const autophagyMainEl = document.getElementById("autophagyMain");

const carbPctEl = document.getElementById("carbPct");
const fatPctEl = document.getElementById("fatPct");
const musclePctEl = document.getElementById("musclePct");
const bonePctEl = document.getElementById("bonePct");

const startBtn = document.getElementById("startBtn");
const pauseBtn = document.getElementById("pauseBtn");
const resetBtn = document.getElementById("resetBtn");
const initialHoursEl = document.getElementById("initialHours");

const activityCaloriesEl = document.getElementById("activityCalories");
const refeedCaloriesEl = document.getElementById("refeedCalories");
const addActivityBtn = document.getElementById("addActivityBtn");
const addRefeedBtn = document.getElementById("addRefeedBtn");
const activitySummaryEl = document.getElementById("activitySummary");
const refeedSummaryEl = document.getElementById("refeedSummary");

const resetProfileBtn = document.getElementById("resetProfileBtn");
const infoToggleBtn = document.getElementById("infoToggle");
const infoBoxEl = document.getElementById("infoBox");

// ======= HJ√ÜLPEFUNKTIONER =======
function loadState() {
try {
const raw = localStorage.getItem(STORAGE_KEY);
if (!raw) return;
const parsed = JSON.parse(raw);
state = {
...defaultState,
...parsed,
profile: { ...defaultState.profile, ...parsed.profile }
};
} catch (e) {
console.warn("Kunne ikke loade state:", e);
}
}

function saveState() {
try {
localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
} catch (e) {
console.warn("Kunne ikke gemme state:", e);
}
}

function computeDailyCalories(profile) {
const { ageGroup, sex, weight, muscleLevel } = profile;
let base;

if (sex === "female") base = 20 * weight + 400;
else if (sex === "male") base = 22 * weight + 500;
else base = 21 * weight + 450;

// alder
if (ageGroup === "18-29") base *= 1.05;
else if (ageGroup === "30-39") base *= 1.02;
else if (ageGroup === "40-49") base *= 1.0;
else if (ageGroup === "50-59") base *= 0.96;
else if (ageGroup === "60-69") base *= 0.92;
else base *= 0.88;

// muskelmasse
if (muscleLevel === "low") base *= 0.93;
else if (muscleLevel === "muscular") base *= 1.12;

return Math.round(base);
}

function formatTime(totalMs) {
if (totalMs < 0) totalMs = 0;
const totalSec = Math.floor(totalMs / 1000);
const h = Math.floor(totalSec / 3600);
const m = Math.floor((totalSec % 3600) / 60);
const s = totalSec % 60;
const pad = (n) => String(n).padStart(2, "0");
return `${pad(h)}:${pad(m)}:${pad(s)}`;
}

function formatHours(h) {
return h.toFixed(1).replace(".", ",");
}

function clamp(v, min, max) {
return Math.max(min, Math.min(max, v));
}

// Energifordeling (meget simpel model)
function energyFractions(effHours) {
let carb = 0, fat = 0, muscle = 0, bone = 0;

if (effHours < 4) {
carb = 0.9; fat = 0.1;
} else if (effHours < 12) {
const t = (effHours - 4) / 8; // 0..1
carb = 0.9 - 0.4 * t; // 90 -> 50
fat = 0.1 + 0.4 * t; // 10 -> 50
} else if (effHours < 24) {
const t = (effHours - 12) / 12;
carb = 0.5 - 0.35 * t; // 50 -> 15
fat = 0.5 + 0.25 * t; // 50 -> 75
} else if (effHours < 36) {
const t = (effHours - 24) / 12;
carb = 0.15 - 0.1 * t; // 15 -> 5
fat = 0.75 - 0.05 * t; // 75 -> 70
muscle = 0 + 0.15 * t; // 0 -> 15
} else {
carb = 0.05;
fat = 0.6;
muscle = 0.25;
bone = 0.10;
}

const total = carb + fat + muscle + bone || 1;
return {
carb: carb / total,
fat: fat / total,
muscle: muscle / total,
bone: bone / total
};
}

function updateUI() {
// beregn real tid
const now = Date.now();
let realMs = state.elapsedRealMs;
if (state.runningSince) {
realMs += now - state.runningSince;
}

const realHours = realMs / 3_600_000;

// beregn effektive timer
const daily = state.dailyCalories || 2000;
const baseRate = daily / 24; // kcal/time

const activityHours = state.totalActivityCalories / baseRate;
const refeedPenaltyHours = (state.totalRefeedCalories / baseRate) * 2;

const effHours = Math.max(0, realHours + activityHours - refeedPenaltyHours);
const effMs = effHours * 3_600_000;

// v√¶gttab (fra faste + aktivitet)
const kcalDeficit = effHours * baseRate;
const gramsLost = kcalDeficit / 7.7; // 7700 kcal ~ 1 kg

// opdater tekst
realTimerEl.textContent = formatTime(realMs);
effectiveTimerEl.textContent = formatTime(effMs);
weightLossGramsEl.textContent = Math.max(0, Math.round(gramsLost));

hoursSummaryEl.textContent =
`${formatHours(effHours)} timer effektiv / ${formatHours(realHours)} timer reel`;

// niveau / medalje (meget simpel)
let level = "Ingen medalje";
let badgeClass = "status-pill";
if (effHours >= 24 && effHours < 36) {
level = "üü¢ Guld ‚Äì optimal faste";
badgeClass = "status-pill good";
} else if (effHours >= 16 && effHours < 24) {
level = "üü† S√∏lv ‚Äì st√¶rk faste";
badgeClass = "status-pill good";
} else if (effHours >= 12 && effHours < 16) {
level = "üü° Bronze ‚Äì god indsats";
badgeClass = "status-pill";
} else if (effHours >= 36) {
level = "‚ö†Ô∏è Risiko ‚Äì lang faste";
badgeClass = "status-pill warn";
}
levelBadgeEl.className = badgeClass;
levelBadgeEl.textContent = level;

// state label
if (!state.runningSince && realMs === 0) {
stateLabelEl.textContent = "Klar til start";
} else if (effHours < AUTOPHAGY_HOURS) {
stateLabelEl.textContent = "P√• vej";
} else if (effHours >= AUTOPHAGY_HOURS && effHours <= OPTIMAL_HOURS) {
stateLabelEl.textContent = "I st√¶rk fase";
} else if (effHours > OPTIMAL_HOURS && effHours < MAX_HOURS) {
stateLabelEl.textContent = "Aftagende effekt";
} else {
stateLabelEl.textContent = "Meget lang faste ‚Äì v√¶r forsigtig";
}

// speedometer: 0..1 stigende til OPTIMAL, derefter aftagende til MAX
let intensity;
if (effHours <= OPTIMAL_HOURS) {
intensity = effHours / OPTIMAL_HOURS; // 0..1
} else if (effHours >= MAX_HOURS) {
intensity = 0;
} else {
const t = (effHours - OPTIMAL_HOURS) / (MAX_HOURS - OPTIMAL_HOURS);
intensity = 1 - t; // falder fra 1 -> 0
}
intensity = clamp(intensity, 0, 1);

// vinkel 180¬∞ (lav) til 360¬∞ (max)
const angle = 180 + intensity * 180;
speedNeedleEl.style.transform = `rotate(${angle}deg)`;

let speedText = "Lav hastighed";
if (intensity < 0.35) speedText = "Lav hastighed";
else if (intensity < 0.75) speedText = "Middel hastighed";
else speedText = "Max-zone";
speedTextEl.textContent = speedText;

const boost = 1 + intensity * 4; // 1x -> 5x
boostLabelEl.textContent =
`Booster: ${boost.toFixed(1).replace(".", ",")}√ó hurtigere end ‚Äúnormalt‚Äù`;

// autofagi countdown
const remainingAutophagy = AUTOPHAGY_HOURS - effHours;
if (remainingAutophagy <= 0) {
autophagyBadgeEl.textContent = "I autofagi";
autophagyBadgeEl.classList.add("autophagy-ok");
autophagyMainEl.textContent = "Kroppen rydder op i cellerne nu (model)";
} else {
autophagyBadgeEl.textContent = "Autofagi om";
autophagyBadgeEl.classList.remove("autophagy-ok");
const h = Math.floor(remainingAutophagy);
const m = Math.round((remainingAutophagy - h) * 60);
const hh = h.toString();
const mm = m.toString().padStart(2, "0");
autophagyMainEl.textContent = `${hh} t ${mm} min`;
}

// energikilder
const fractions = energyFractions(effHours);
const toPct = (x) => `${Math.round(x * 100)}%`;
carbPctEl.textContent = toPct(fractions.carb);
fatPctEl.textContent = toPct(fractions.fat);
musclePctEl.textContent = toPct(fractions.muscle);
bonePctEl.textContent = toPct(fractions.bone);

// Aktivitet / refeed tekst
const activityHours = state.totalActivityCalories / baseRate;
const refeedPenaltyHours = (state.totalRefeedCalories / baseRate) * 2;

activitySummaryEl.textContent =
`Aktivitet i alt: ${state.totalActivityCalories} kcal (~${formatHours(activityHours)} ekstra timer)`;

refeedSummaryEl.textContent =
`Refeed i alt: ${state.totalRefeedCalories} kcal (~${formatHours(refeedPenaltyHours)} ‚Äústraffe-timer‚Äù)`;
}

function syncProfileUI() {
const p = state.profile;
ageGroupEl.value = p.ageGroup;
sexEl.value = p.sex;
weightEl.value = p.weight;
muscleLevelEl.value = p.muscleLevel;
dailyCaloriesEl.textContent = state.dailyCalories;
}

function updateProfileFromUI() {
const profile = {
ageGroup: ageGroupEl.value,
sex: sexEl.value,
weight: Number(weightEl.value) || 80,
muscleLevel: muscleLevelEl.value
};
const daily = computeDailyCalories(profile);
state.profile = profile;
state.dailyCalories = daily;
dailyCaloriesEl.textContent = daily;
saveState();
updateUI();
}

// ======= HANDLERE =======
function handleStart() {
if (!state.runningSince) {
const extraHours = Number(initialHoursEl.value) || 0;
if (state.elapsedRealMs === 0 && extraHours > 0) {
state.elapsedRealMs = extraHours * 3_600_000;
}
state.runningSince = Date.now();
}
saveState();
updateUI();
}

function handlePause() {
if (state.runningSince) {
const now = Date.now();
state.elapsedRealMs += now - state.runningSince;
state.runningSince = null;
saveState();
updateUI();
}
}

function handleReset() {
if (!confirm("Nulstil fasten og starte helt forfra?")) return;
state.elapsedRealMs = 0;
state.runningSince = null;
state.totalActivityCalories = 0;
state.totalRefeedCalories = 0;
initialHoursEl.value = "";
activityCaloriesEl.value = "";
refeedCaloriesEl.value = "";
saveState();
updateUI();
}

function handleAddActivity() {
const val = Number(activityCaloriesEl.value);
if (!val || val <= 0) {
alert("Skriv et kalorie-anslag for din aktivitet.");
return;
}
state.totalActivityCalories += val;
activityCaloriesEl.value = "";
saveState();
updateUI();
}

function handleAddRefeed() {
const val = Number(refeedCaloriesEl.value);
if (!val || val <= 0) {
alert("Skriv et kalorie-anslag for m√•ltidet.");
return;
}
state.totalRefeedCalories += val;
refeedCaloriesEl.value = "";
saveState();
updateUI();
}

function handleResetProfile() {
if (!confirm("Nulstil profil til standard?")) return;
state.profile = { ...defaultState.profile };
state.dailyCalories = computeDailyCalories(state.profile);
syncProfileUI();
saveState();
updateUI();
}

// ======= INIT =======
loadState();
// beregn dagligt kaloriebehov hvis n√∏dvendigt
state.dailyCalories = computeDailyCalories(state.profile);
syncProfileUI();
updateUI();

// Event-listeners
ageGroupEl.addEventListener("change", updateProfileFromUI);
sexEl.addEventListener("change", updateProfileFromUI);
weightEl.addEventListener("change", updateProfileFromUI);
muscleLevelEl.addEventListener("change", updateProfileFromUI);

startBtn.addEventListener("click", handleStart);
pauseBtn.addEventListener("click", handlePause);
resetBtn.addEventListener("click", handleReset);

addActivityBtn.addEventListener("click", handleAddActivity);
addRefeedBtn.addEventListener("click", handleAddRefeed);

resetProfileBtn.addEventListener("click", handleResetProfile);

infoToggleBtn.addEventListener("click", () => {
const visible = infoBoxEl.style.display === "block";
infoBoxEl.style.display = visible ? "none" : "block";
});

// tick hver sekund
setInterval(() => {
if (state.runningSince) {
updateUI();
}
}, 1000);
</script>
</body>
</html>
