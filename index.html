<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8" />
<title>Faste-tracker v25</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
:root {
--bg: #050816;
--bg-card: #0d1220;
--accent: #ff4b91;
--accent-soft: #ffc7dd;
--accent-2: #26c6da;
--accent-3: #ffca28;
--text: #f5f5f7;
--text-soft: #a0aec0;
--danger: #ff1744;
--ok: #00e676;
--border-subtle: #20263a;
}

* {
box-sizing: border-box;
font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
"Segoe UI", sans-serif;
}

body {
margin: 0;
padding: 0;
background: radial-gradient(circle at top, #181a3a, #050816 55%);
color: var(--text);
display: flex;
justify-content: center;
min-height: 100vh;
}

.page {
width: 100%;
max-width: 960px;
padding: 12px;
}

h1 {
margin: 0 0 6px;
font-size: 1.4rem;
display: flex;
align-items: center;
gap: 8px;
}

h1 span.logo-pill {
display: inline-flex;
align-items: center;
justify-content: center;
width: 30px;
height: 30px;
border-radius: 999px;
background: radial-gradient(circle at 30% 30%, #ff9a9e, #ff4b91);
color: #fff;
font-weight: 700;
font-size: 0.9rem;
}

.subtitle {
font-size: 0.8rem;
color: var(--text-soft);
margin-bottom: 10px;
}

/* Layout: flex s√• vi kan bytte r√¶kkef√∏lge via .prestart */
.layout {
display: flex;
flex-direction: column;
gap: 10px;
}

@media (min-width: 820px) {
.layout {
flex-direction: row;
align-items: flex-start;
}
}

.card {
background: linear-gradient(145deg, #0b1020, #11172a);
border-radius: 14px;
padding: 10px 10px 12px;
border: 1px solid var(--border-subtle);
box-shadow: 0 18px 32px rgba(0, 0, 0, 0.5);
position: relative;
overflow: hidden;
}

.card-status {
flex: 3 1 320px;
}

.card-profile {
flex: 2 1 280px;
}

/* F√∏r start: profil √∏verst, status nederst */
body.prestart .card-status {
order: 2;
}
body.prestart .card-profile {
order: 1;
}

/* Efter start (standard r√¶kkef√∏lge): status √∏verst */
body:not(.prestart) .card-status {
order: 1;
}
body:not(.prestart) .card-profile {
order: 2;
}

.card h2 {
margin: 0 0 6px;
font-size: 0.95rem;
display: flex;
align-items: center;
gap: 6px;
}

.card h2 span.tag {
font-size: 0.65rem;
padding: 2px 8px;
border-radius: 999px;
border: 1px solid rgba(255, 255, 255, 0.08);
color: var(--text-soft);
}

.info-btn {
position: absolute;
top: 8px;
right: 8px;
width: 20px;
height: 20px;
border-radius: 999px;
background: rgba(15, 23, 42, 0.9);
border: 1px solid rgba(148, 163, 184, 0.7);
display: flex;
align-items: center;
justify-content: center;
font-size: 0.8rem;
color: #e5e7eb;
cursor: pointer;
}

.top-row {
display: flex;
flex-wrap: wrap;
gap: 10px;
align-items: stretch;
}

.timer-block {
flex: 2 1 160px;
display: flex;
flex-direction: column;
gap: 2px;
}

.timer-main {
font-variant-numeric: tabular-nums;
font-size: 1.9rem;
font-weight: 600;
letter-spacing: 0.04em;
}

.timer-label {
font-size: 0.75rem;
color: var(--text-soft);
}

.timer-secondary {
font-variant-numeric: tabular-nums;
font-size: 1.1rem;
margin-top: 2px;
}

.mini-label {
font-size: 0.7rem;
color: var(--text-soft);
}

.top-meters {
flex: 2 1 180px;
display: flex;
flex-direction: column;
gap: 4px;
align-items: center;
justify-content: center;
}

/* SPEEDOMETER */
.speedometer {
width: 150px;
height: 85px;
position: relative;
margin-bottom: 3px;
}

.speedometer-arc {
position: absolute;
bottom: -75px;
left: 0;
right: 0;
margin: 0 auto;
width: 150px;
height: 150px;
border-radius: 999px;
background: conic-gradient(
from 180deg,
#22c55e 0deg,
#22c55e 60deg,
#facc15 60deg,
#facc15 120deg,
#ef4444 120deg,
#ef4444 180deg,
#020617 180deg,
#020617 360deg
);
border: 2px solid #020617;
box-shadow: 0 4px 10px rgba(15, 23, 42, 0.9);
}

.speedometer-center {
position: absolute;
bottom: 0;
left: 50%;
width: 14px;
height: 14px;
border-radius: 50%;
background: #020617;
border: 2px solid #e5e7eb;
transform: translateX(-50%);
box-shadow: 0 0 6px rgba(248, 250, 252, 0.8);
}

.speedometer-needle {
position: absolute;
bottom: 0;
left: 50%;
width: 2px;
height: 70px;
background: #e5e7eb;
transform-origin: bottom center;
transform: rotate(-90deg);
box-shadow: 0 0 6px rgba(248, 250, 252, 0.8);
transition: transform 0.2s ease-out;
}

.speedometer-labels {
position: absolute;
top: 0;
left: 0;
right: 0;
display: flex;
justify-content: space-between;
padding: 0 6px;
font-size: 0.65rem;
color: var(--text-soft);
}

.speedometer-text {
margin-top: 1px;
font-size: 0.72rem;
text-align: center;
color: var(--text-soft);
}

/* V√ÜGTL√ÖD */
.weight-lod {
position: relative;
width: 70px;
height: 70px;
margin-top: 0;
}

.weight-lod-handle {
position: absolute;
top: 2px;
left: 50%;
width: 22px;
height: 12px;
border-radius: 999px;
border: 2px solid #fef3c7;
transform: translateX(-50%);
background: rgba(15, 23, 42, 0.9);
}

.weight-lod-body {
position: absolute;
bottom: 0;
left: 50%;
width: 52px;
height: 52px;
transform: translateX(-50%);
border-radius: 8px;
background: radial-gradient(circle at 30% 20%, #f97316, #b91c1c);
box-shadow: 0 6px 12px rgba(248, 113, 113, 0.6);
display: flex;
align-items: center;
justify-content: center;
flex-direction: column;
color: #fefce8;
font-size: 0.7rem;
font-variant-numeric: tabular-nums;
}

.weight-lod-body strong {
font-size: 0.9rem;
}

.weight-lod-body span {
font-size: 0.65rem;
opacity: 0.9;
}

/* AUTOFAGI BOKS */
.autofagi-box {
margin-top: 8px;
padding: 6px 8px;
border-radius: 12px;
background: radial-gradient(circle at top left, #093f5f, #020617);
border: 1px solid rgba(56, 189, 248, 0.7);
display: flex;
gap: 8px;
align-items: center;
}

.autofagi-icon {
width: 34px;
height: 34px;
border-radius: 12px;
background: radial-gradient(circle at 30% 20%, #e0f2fe, #0284c7);
display: flex;
align-items: center;
justify-content: center;
box-shadow: 0 0 12px rgba(56, 189, 248, 0.8);
font-size: 1.4rem;
}

.autofagi-text-main {
font-size: 0.8rem;
font-weight: 500;
}

.autofagi-text-sub {
font-size: 0.7rem;
color: var(--text-soft);
}

.fat-grid {
display: grid;
grid-template-columns: repeat(4, minmax(0, 1fr));
gap: 4px;
margin-top: 6px;
}

.fat-pill {
text-align: center;
border-radius: 999px;
padding: 3px 0;
font-size: 0.65rem;
background: rgba(15, 23, 42, 0.9);
border: 1px solid rgba(148, 163, 184, 0.3);
color: var(--text-soft);
}

.fat-pill span.val {
display: block;
font-variant-numeric: tabular-nums;
font-size: 0.78rem;
color: var(--text);
}

.fat-pill.carb {
border-color: #fb923c;
background: rgba(251, 146, 60, 0.08);
}
.fat-pill.fat {
border-color: #4ade80;
background: rgba(34, 197, 94, 0.08);
}
.fat-pill.muscle {
border-color: #f472b6;
background: rgba(236, 72, 153, 0.08);
}
.fat-pill.bone {
border-color: #38bdf8;
background: rgba(56, 189, 248, 0.08);
}

.medal-row {
margin-top: 6px;
display: flex;
justify-content: space-between;
align-items: center;
font-size: 0.75rem;
}

.medal-main {
display: inline-flex;
align-items: center;
gap: 6px;
}

.medal-emoji {
font-size: 1.2rem;
}

.medal-title {
font-size: 0.78rem;
}

.phase-short {
font-size: 0.7rem;
padding: 2px 8px;
border-radius: 999px;
background: rgba(15, 23, 42, 0.8);
border: 1px solid rgba(148, 163, 184, 0.55);
color: var(--text-soft);
}

.tiny-note {
font-size: 0.65rem;
color: var(--text-soft);
margin-top: 4px;
}

/* H√òJRE SIDE */

.grid-2 {
display: grid;
gap: 6px;
}

@media (min-width: 600px) {
.grid-2 {
grid-template-columns: repeat(2, minmax(0, 1fr));
}
}

.field {
display: flex;
flex-direction: column;
gap: 3px;
margin-bottom: 4px;
}

.field label {
font-size: 0.75rem;
color: var(--text-soft);
}

.field input,
.field select {
border-radius: 999px;
border: 1px solid rgba(255, 255, 255, 0.14);
background: rgba(0, 0, 0, 0.2);
color: var(--text);
padding: 5px 10px;
font-size: 0.8rem;
outline: none;
}

.field input::placeholder {
color: #5c6477;
}

.pill-stat {
background: rgba(0, 0, 0, 0.35);
border-radius: 12px;
padding: 6px 8px;
display: flex;
justify-content: space-between;
align-items: baseline;
margin-top: 3px;
border: 1px solid rgba(255, 255, 255, 0.04);
}

.pill-stat-label {
font-size: 0.7rem;
color: var(--text-soft);
}

.pill-stat-value {
font-variant-numeric: tabular-nums;
font-size: 0.9rem;
}

.pill-stat-value strong {
font-weight: 600;
color: var(--accent-soft);
}

.btn-row {
display: flex;
flex-wrap: wrap;
gap: 6px;
margin: 6px 0 0;
}

button {
border-radius: 999px;
border: none;
cursor: pointer;
font-size: 0.8rem;
padding: 6px 12px;
display: inline-flex;
align-items: center;
gap: 6px;
background: #22263b;
color: var(--text);
transition: transform 0.07s ease, box-shadow 0.07s ease,
background 0.15s ease;
}

button.primary {
background: linear-gradient(135deg, #ff4b91, #ff7b54);
color: #fff;
box-shadow: 0 8px 16px rgba(255, 75, 145, 0.45);
}

button.danger {
background: rgba(255, 53, 94, 0.08);
color: #ff8a80;
border: 1px solid rgba(255, 82, 82, 0.4);
}

button.secondary {
background: rgba(144, 202, 249, 0.12);
color: #e3f2fd;
border: 1px solid rgba(144, 202, 249, 0.5);
}

button:active {
transform: translateY(1px) scale(0.99);
box-shadow: none;
}

.disclaimer {
margin-top: 8px;
font-size: 0.65rem;
color: var(--text-soft);
}

/* INFO OVERLAY */
.info-overlay {
position: fixed;
inset: 0;
background: rgba(15, 23, 42, 0.85);
display: none;
align-items: center;
justify-content: center;
z-index: 50;
}

.info-panel {
width: 90%;
max-width: 420px;
max-height: 80vh;
background: #020617;
border-radius: 16px;
border: 1px solid rgba(148, 163, 184, 0.6);
padding: 12px 14px;
overflow-y: auto;
box-shadow: 0 24px 40px rgba(0, 0, 0, 0.8);
font-size: 0.78rem;
}

.info-panel h3 {
margin: 0 0 8px;
font-size: 0.9rem;
}

.info-panel h4 {
margin: 8px 0 4px;
font-size: 0.85rem;
}

.info-panel p {
margin: 2px 0;
color: var(--text-soft);
}

.info-panel ul {
margin: 4px 0 4px 18px;
padding: 0;
color: var(--text-soft);
}

.info-close-row {
display: flex;
justify-content: flex-end;
margin-top: 8px;
}

.info-close-btn {
border-radius: 999px;
border: 1px solid rgba(148, 163, 184, 0.7);
background: rgba(15, 23, 42, 0.9);
color: #e5e7eb;
padding: 4px 10px;
font-size: 0.75rem;
cursor: pointer;
}
</style>
</head>
<body class="prestart">
<div class="page">
<h1>
<span class="logo-pill">F</span>
Faste-tracker
</h1>
<div class="subtitle">
Start n√•r du tager sidste bid mad ‚Äì appen fors√∏ger at huske din faste, ogs√• n√•r du lukker den.
</div>

<div class="layout">
<!-- STATUS-KORT -->
<div class="card card-status">
<h2>
Faste-overblik
<span class="tag" id="phaseTag">Klar til start</span>
</h2>
<div class="info-btn" id="infoBtn">i</div>

<div class="top-row">
<div class="timer-block">
<div class="timer-main" id="realTimer">00:00:00</div>
<div class="timer-label">Reel faste</div>
<div class="timer-secondary" id="effectiveTimer">00:00:00</div>
<div class="mini-label">Effektiv faste (sport / refeed)</div>

<div style="margin-top:6px; display:flex; gap:8px; align-items:center;">
<div class="weight-lod">
<div class="weight-lod-handle"></div>
<div class="weight-lod-body">
<strong id="weightLossGrams">0</strong>
<span>g tabt (model)</span>
</div>
</div>
<div>
<div class="mini-label">Tidsoversigt</div>
<div class="timer-secondary" style="font-size:0.9rem;" id="effectiveHoursLabelText">
0,0 timer effektiv
</div>
<div class="mini-label" id="realHoursLabelText">
0,0 timer reel
</div>
</div>
</div>
</div>

<div class="top-meters">
<!-- SPEEDOMETER -->
<div class="speedometer">
<div class="speedometer-arc"></div>
<div class="speedometer-needle" id="speedNeedle"></div>
<div class="speedometer-center"></div>
<div class="speedometer-labels">
<span>Lav</span>
<span>Midt</span>
<span>Max</span>
</div>
</div>
<div class="speedometer-text" id="speedText">
Faste-hastighed (modelleret)
</div>
<div class="speedometer-text" id="boosterText" style="font-size:0.75rem;">
Fedt-booster: 0,0√ó
</div>
</div>
</div>

<!-- AUTOFAGI BOKS -->
<div class="autofagi-box" id="autofagiBox">
<div class="autofagi-icon" id="autofagiIcon">‚õëÔ∏è</div>
<div>
<div class="autofagi-text-main" id="autofagiMain">
Autofagi om: ‚Äì
</div>
<div class="autofagi-text-sub" id="autofagiSub">
Autofagi = kroppens oprydning i slidte celler (forenklet model).
</div>
</div>
</div>

<!-- ENERGIKILDER -->
<div class="fat-grid">
<div class="fat-pill carb">
Kulhydrat
<span class="val" id="carbPercent">‚Äì%</span>
</div>
<div class="fat-pill fat">
Fedt
<span class="val" id="fatPercent">‚Äì%</span>
</div>
<div class="fat-pill muscle">
Muskler
<span class="val" id="musclePercent">‚Äì%</span>
</div>
<div class="fat-pill bone">
Knogle
<span class="val" id="bonePercent">‚Äì%</span>
</div>
</div>

<!-- MEDALJE -->
<div class="medal-row">
<div class="medal-main">
<span class="medal-emoji" id="medalEmoji">‚¨ú</span>
<span class="medal-title" id="medalTitle">Ingen medalje endnu</span>
</div>
<span class="phase-short" id="phaseShort">
Ikke i optimal zone
</span>
</div>

<div class="tiny-note">
Alle tal er forenklede modeller ‚Äì ikke medicinske anbefalinger.
</div>
</div>

<!-- PROFIL-KORT -->
<div class="card card-profile">
<h2>
Profil & styring
<span class="tag">Gemmes lokalt</span>
</h2>

<div class="grid-2">
<div class="field">
<label>Aldersgruppe</label>
<select id="ageGroup">
<option value="18-29">18‚Äì29</option>
<option value="30-39">30‚Äì39</option>
<option value="40-49" selected>40‚Äì49</option>
<option value="50-59">50‚Äì59</option>
<option value="60-69">60‚Äì69</option>
<option value="70+">70+</option>
</select>
</div>
<div class="field">
<label>K√∏n</label>
<select id="gender">
<option value="mand" selected>Mand</option>
<option value="kvinde">Kvinde</option>
<option value="andet">Andet</option>
</select>
</div>
</div>

<div class="grid-2">
<div class="field">
<label>V√¶gt (kg)</label>
<input type="number" id="weight" min="30" max="250" step="0.5" placeholder="fx 85" />
</div>
<div class="field">
<label>Muskel-niveau</label>
<select id="muscleLevel">
<option value="lav">Lav</option>
<option value="normal" selected>Normal</option>
<option value="muskul√∏s">Muskul√∏s</option>
<option value="atletisk">Atletisk</option>
</select>
</div>
</div>

<div class="pill-stat">
<div class="pill-stat-label">Dagligt kaloriebehov (model)</div>
<div class="pill-stat-value">
<strong id="dailyCalories">‚Äì</strong> kcal
</div>
</div>

<div class="pill-stat">
<div class="pill-stat-label">Basisforbr√¶nding pr. time</div>
<div class="pill-stat-value">
<strong id="bmrHour">‚Äì</strong> kcal/t
</div>
</div>

<div class="field" style="margin-top:6px;">
<label>Timer siden sidste m√•ltid</label>
<input type="number" id="preHours" min="0" step="0.25" placeholder="fx 3" />
</div>

<div class="btn-row">
<button class="primary" id="startBtn">‚ñ∂Ô∏è Start / forts√¶t</button>
<button class="danger" id="resetBtn">üîÅ Nulstil</button>
</div>

<div class="pill-stat">
<div class="pill-stat-label">Effektiv faste (timer)</div>
<div class="pill-stat-value">
<strong id="effectiveHoursLabel">0,0</strong>
</div>
</div>

<div class="pill-stat">
<div class="pill-stat-label">Reel faste (timer)</div>
<div class="pill-stat-value">
<strong id="realHoursLabel">0,0</strong>
</div>
</div>

<hr style="border:none;border-top:1px solid rgba(148,163,184,0.35);margin:8px 0" />

<h2 style="font-size:0.9rem;margin-top:0;">Aktivitet</h2>

<div class="field">
<label>Kalorier fra sport</label>
<input type="number" id="activityCalories" min="0" step="10" placeholder="fx 400" />
</div>
<div class="btn-row">
<button class="secondary" id="addActivityBtn">üí™ Tilf√∏j</button>
</div>

<div class="pill-stat">
<div class="pill-stat-label">Aktivitet i denne faste</div>
<div class="pill-stat-value">
<strong id="totalActivityCalories">0</strong> kcal
</div>
</div>

<hr style="border:none;border-top:1px solid rgba(148,163,184,0.35);margin:8px 0" />

<h2 style="font-size:0.9rem;margin-top:0;">Refeed</h2>

<div class="field">
<label>Kalorier i lille m√•ltid</label>
<input type="number" id="refeedCalories" min="0" step="10" placeholder="fx 300" />
</div>
<div class="btn-row">
<button class="secondary" id="applyRefeedBtn">üçΩÔ∏è Brug refeed</button>
</div>

<div class="pill-stat">
<div class="pill-stat-label">Refeed i denne faste</div>
<div class="pill-stat-value">
<strong id="totalRefeedCalories">0</strong> kcal
</div>
</div>

<div class="disclaimer">
Kun til motivation. Tal er modeller ‚Äì ikke medicinsk r√•dgivning.
</div>
</div>
</div>
</div>

<!-- INFO POPUP -->
<div class="info-overlay" id="infoOverlay">
<div class="info-panel">
<h3>S√•dan l√¶ser du appen</h3>

<h4>Reel vs. effektiv faste</h4>
<p><strong>Reel faste</strong> er den faktiske tid siden sidste m√•ltid + eventuelle timer, du har v√¶ret i gang, mens appen k√∏rer.</p>
<p><strong>Effektiv faste</strong> er en model, hvor:</p>
<ul>
<li>Sport giver ekstra ‚Äúfaste-timer‚Äù</li>
<li>Sm√• m√•ltider (refeed) tr√¶kker ‚Äúfaste-timer‚Äù fra</li>
</ul>
<p>Effektiv faste bruges til booster, autofagi og medaljer.</p>

<h4>Fedt-booster</h4>
<p>Fedt-booster viser, hvor stor en del af energien, der kommer fra fedt.</p>
<p>Forenklet: hvis 10 % af energien er fedt = 1√ó, 40 % fedt ‚âà 4√ó.</p>
<p>Det er <strong>ikke</strong> et klinisk pr√¶cist tal ‚Äì men et motiverende billede.</p>

<h4>Autofagi (oprydning i celler)</h4>
<p>Autofagi er kroppens egen proces, hvor slidte celler nedbrydes og genbruges.</p>
<p>I modellen antager vi, at autofagi typisk begynder omkring <strong>16 timers effektiv faste</strong>.</p>
<ul>
<li>Nedt√¶llingen viser, hvor l√¶nge der er til (modelleret).</li>
<li>Sport kan forkorte vejen, fordi sukkerdepoter t√∏mmes hurtigere.</li>
</ul>

<h4>Medaljer</h4>
<p>Medaljer gives ud fra effektiv faste:</p>
<ul>
<li>Bronze: ca. 10 t</li>
<li>S√∏lv: ca. 16 t</li>
<li>Guld: ca. 20 t</li>
<li>Platin: ca. 24 t</li>
</ul>
<p>Det er kun til motivation ‚Äì ikke et m√•l, du n√∏dvendigvis b√∏r str√¶be efter.</p>

<h4>Energikilder</h4>
<p>Bokse med kulhydrat, fedt, muskler og knogle viser en forenklet fordeling af, hvor energien antages at komme fra, alt efter hvor langt du er i fasten.</p>

<div class="info-close-row">
<button class="info-close-btn" id="infoCloseBtn">Luk</button>
</div>
</div>
</div>

<script>
const els = {
realTimer: document.getElementById("realTimer"),
effectiveTimer: document.getElementById("effectiveTimer"),
effectiveHoursLabelText: document.getElementById("effectiveHoursLabelText"),
realHoursLabelText: document.getElementById("realHoursLabelText"),
effectiveHoursLabel: document.getElementById("effectiveHoursLabel"),
realHoursLabel: document.getElementById("realHoursLabel"),
weightLossGrams: document.getElementById("weightLossGrams"),
carbPercent: document.getElementById("carbPercent"),
fatPercent: document.getElementById("fatPercent"),
musclePercent: document.getElementById("musclePercent"),
bonePercent: document.getElementById("bonePercent"),
speedNeedle: document.getElementById("speedNeedle"),
speedText: document.getElementById("speedText"),
boosterText: document.getElementById("boosterText"),
autofagiBox: document.getElementById("autofagiBox"),
autofagiIcon: document.getElementById("autofagiIcon"),
autofagiMain: document.getElementById("autofagiMain"),
autofagiSub: document.getElementById("autofagiSub"),
medalEmoji: document.getElementById("medalEmoji"),
medalTitle: document.getElementById("medalTitle"),
phaseShort: document.getElementById("phaseShort"),
phaseTag: document.getElementById("phaseTag"),
ageGroup: document.getElementById("ageGroup"),
gender: document.getElementById("gender"),
weight: document.getElementById("weight"),
muscleLevel: document.getElementById("muscleLevel"),
dailyCalories: document.getElementById("dailyCalories"),
bmrHour: document.getElementById("bmrHour"),
preHours: document.getElementById("preHours"),
startBtn: document.getElementById("startBtn"),
resetBtn: document.getElementById("resetBtn"),
activityCalories: document.getElementById("activityCalories"),
addActivityBtn: document.getElementById("addActivityBtn"),
totalActivityCalories: document.getElementById("totalActivityCalories"),
refeedCalories: document.getElementById("refeedCalories"),
applyRefeedBtn: document.getElementById("applyRefeedBtn"),
totalRefeedCalories: document.getElementById("totalRefeedCalories"),
infoBtn: document.getElementById("infoBtn"),
infoOverlay: document.getElementById("infoOverlay"),
infoCloseBtn: document.getElementById("infoCloseBtn")
};

const AUTO_THRESHOLD_HOURS = 16;
const STORAGE_KEY = "fastetracker_v25_state";

let state = {
startTimestamp: null,
preHours: 0,
totalActivityCalories: 0,
totalRefeedCalories: 0,
dailyCalories: null,
bmrPerHour: null,
ageGroup: "40-49",
gender: "mand",
weight: null,
muscleLevel: "normal"
};

let timerId = null;

function saveState() {
try {
localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
} catch (e) {}
}

function loadState() {
try {
const raw = localStorage.getItem(STORAGE_KEY);
if (!raw) return;
const obj = JSON.parse(raw);
Object.assign(state, obj);
} catch (e) {}
}

function formatHMSFromHours(hours) {
if (hours < 0) hours = 0;
const totalSec = Math.floor(hours * 3600);
const h = Math.floor(totalSec / 3600);
const m = Math.floor((totalSec % 3600) / 60);
const s = totalSec % 60;
const pad = (n) => String(n).padStart(2, "0");
return `${pad(h)}:${pad(m)}:${pad(s)}`;
}

function formatHours(hours) {
return hours.toFixed(1).replace(".", ",");
}

function calcBmr() {
let weight = parseFloat(els.weight.value.replace(",", "."));
if (!isFinite(weight) || weight <= 0) {
// beskedent default
weight = state.gender === "kvinde" ? 70 : 80;
}

const gender = els.gender.value;
const ageGroup = els.ageGroup.value;
const muscleLevel = els.muscleLevel.value;

let factorGender = gender === "kvinde" ? 22 : 24;
let base = factorGender * weight;

let ageFactor = 1.0;
if (ageGroup === "30-39") ageFactor = 0.97;
else if (ageGroup === "40-49") ageFactor = 0.95;
else if (ageGroup === "50-59") ageFactor = 0.92;
else if (ageGroup === "60-69") ageFactor = 0.9;
else if (ageGroup === "70+") ageFactor = 0.85;

let muscleFactor = 1.0;
if (muscleLevel === "lav") muscleFactor = 0.9;
else if (muscleLevel === "muskul√∏s") muscleFactor = 1.08;
else if (muscleLevel === "atletisk") muscleFactor = 1.16;

let daily = base * ageFactor * muscleFactor;
if (!isFinite(daily) || daily <= 0) daily = 2000;

const bmrHour = daily / 24;

state.dailyCalories = daily;
state.bmrPerHour = bmrHour;
state.ageGroup = ageGroup;
state.gender = gender;
state.weight = weight;
state.muscleLevel = muscleLevel;

els.dailyCalories.textContent = Math.round(daily);
els.bmrHour.textContent = Math.round(bmrHour);
}

function energyDistribution(effHours) {
// meget simpel, men glidende
if (effHours < 0) effHours = 0;
let carbs, fat, muscle, bone;

if (effHours <= 4) {
// 0-4 t: fra 90% kulhydrat / 10% fedt til 70/30
const t = effHours / 4;
carbs = 90 - 20 * t;
fat = 10 + 20 * t;
muscle = 0;
bone = 0;
} else if (effHours <= 16) {
// 4-16 t: fra 70/30 til 20/80
const t = (effHours - 4) / 12;
carbs = 70 - 50 * t;
fat = 30 + 50 * t;
muscle = 0;
bone = 0;
} else if (effHours <= 24) {
// 16-24 t: fra 20/80 til 10/85 + lidt muskler
const t = (effHours - 16) / 8;
carbs = 20 - 10 * t;
fat = 80 + 5 * t;
muscle = 0 + 5 * t;
bone = 0;
} else if (effHours <= 36) {
// 24-36 t: prim√¶rt fedt, lidt muskler/knogle dukker op
const t = (effHours - 24) / 12;
carbs = 10 - 5 * t;
fat = 85 - 5 * t;
muscle = 5 + 7 * t;
bone = 0 + 3 * t;
} else {
// >36 t: hold 5% kulhydrat, 75% fedt, 15% muskler, 5% knogle
carbs = 5;
fat = 75;
muscle = 15;
bone = 5;
}

const sum = carbs + fat + muscle + bone;
const scale = sum > 0 ? 100 / sum : 1;
return {
carbs: Math.round(carbs * scale),
fat: Math.round(fat * scale),
muscle: Math.round(muscle * scale),
bone: Math.round(bone * scale)
};
}

function updateUI() {
const now = Date.now();

let realHours = 0;
if (state.startTimestamp) {
const elapsedMs = now - state.startTimestamp;
const elapsedHours = elapsedMs / (1000 * 60 * 60);
realHours = state.preHours + Math.max(0, elapsedHours);
}

if (!isFinite(realHours) || realHours < 0) realHours = 0;

const bmrHour = state.bmrPerHour || 80;
const activityBonusHours = state.totalActivityCalories / bmrHour;
const refeedPenaltyHours = (state.totalRefeedCalories / bmrHour) * 2;

let effectiveHours = realHours + activityBonusHours - refeedPenaltyHours;
if (effectiveHours < 0) effectiveHours = 0;

// Timere
els.realTimer.textContent = formatHMSFromHours(realHours);
els.effectiveTimer.textContent = formatHMSFromHours(effectiveHours);
els.realHoursLabel.textContent = formatHours(realHours);
els.effectiveHoursLabel.textContent = formatHours(effectiveHours);
els.realHoursLabelText.textContent = formatHours(realHours) + " timer reel";
els.effectiveHoursLabelText.textContent =
formatHours(effectiveHours) + " timer effektiv";

// V√¶gttab (samlet energi fra krop)
const totalCaloriesFromBody =
Math.max(0, realHours * bmrHour + state.totalActivityCalories - state.totalRefeedCalories);
const weightLossKg = totalCaloriesFromBody / 7700;
const weightLossGrams = Math.round(weightLossKg * 1000);
els.weightLossGrams.textContent = weightLossGrams;

// Energifordeling
const dist = energyDistribution(effectiveHours);
els.carbPercent.textContent = dist.carbs + "%";
els.fatPercent.textContent = dist.fat + "%";
els.musclePercent.textContent = dist.muscle + "%";
els.bonePercent.textContent = dist.bone + "%";

// Speedometer baseret p√• fedt%
const fatPct = dist.fat;
// -90 grader (lav) til +90 grader (max)
let angle = -90 + (fatPct / 100) * 180;
if (angle < -90) angle = -90;
if (angle > 90) angle = 90;
els.speedNeedle.style.transform = `rotate(${angle}deg)`;

// Booster
let booster = fatPct / 10; // 10% = 1x
if (booster < 0) booster = 0;
els.boosterText.textContent =
"Fedt-booster: " + booster.toFixed(1).replace(".", ",") + "√ó";

if (fatPct < 20) {
els.speedText.textContent = "Lav fedtforbr√¶nding (modelleret)";
} else if (fatPct < 60) {
els.speedText.textContent = "Middel fedtforbr√¶nding (modelleret)";
} else {
els.speedText.textContent = "H√∏j fedtforbr√¶nding (modelleret)";
}

// Autofagi
const remainingHours = AUTO_THRESHOLD_HOURS - effectiveHours;
if (remainingHours > 0) {
const hrs = Math.floor(remainingHours);
const mins = Math.floor((remainingHours - hrs) * 60);
els.autofagiMain.textContent =
"Autofagi om: " +
hrs +
" t " +
String(mins).padStart(2, "0") +
" min";
els.autofagiSub.textContent =
"Hold fasten (og evt. lidt bev√¶gelse) for at n√• oprydningsfasen.";
els.autofagiBox.style.borderColor = "rgba(56,189,248,0.7)";
els.autofagiIcon.textContent = "‚õëÔ∏è";
} else {
els.autofagiMain.textContent = "Autofagi aktiv (model)";
els.autofagiSub.textContent =
"Kroppen rydder sandsynligvis mere op i slidte celler ‚Äì lyt altid til din krop.";
els.autofagiBox.style.borderColor = "rgba(74,222,128,0.9)";
els.autofagiIcon.textContent = "‚ú®";
}

// Medaljer ‚Äì baseret p√• effektiv faste
let medalEmoji = "‚¨ú";
let medalTitle = "Ingen medalje endnu";

if (effectiveHours >= 24) {
medalEmoji = "üèÖ";
medalTitle = "Platin ‚Äì maratonfaste";
} else if (effectiveHours >= 20) {
medalEmoji = "ü•á";
medalTitle = "Guld ‚Äì meget lang faste";
} else if (effectiveHours >= 16) {
medalEmoji = "ü•à";
medalTitle = "S√∏lv ‚Äì st√¶rk faste";
} else if (effectiveHours >= 10) {
medalEmoji = "ü•â";
medalTitle = "Bronze ‚Äì flot indsats";
}

els.medalEmoji.textContent = medalEmoji;
els.medalTitle.textContent = medalTitle;

// Fase-beskrivelse
if (effectiveHours === 0) {
els.phaseShort.textContent = "Ikke i gang endnu";
els.phaseTag.textContent = "Klar til start";
} else if (effectiveHours < 16) {
els.phaseShort.textContent = "P√• vej mod optimal zone";
els.phaseTag.textContent = "P√• vej";
} else if (effectiveHours <= 24) {
els.phaseShort.textContent = "I optimal zone (model)";
els.phaseTag.textContent = "Optimal";
} else {
els.phaseShort.textContent = "Over optimal zone (aftagende effekt)";
els.phaseTag.textContent = "Over optimal";
}

// Aktivitet / refeed labels
els.totalActivityCalories.textContent = Math.round(
state.totalActivityCalories
);
els.totalRefeedCalories.textContent = Math.round(
state.totalRefeedCalories
);
}

function startTimerLoop() {
if (timerId) return;
timerId = setInterval(updateUI, 1000);
updateUI();
}

function stopTimerLoop() {
if (timerId) {
clearInterval(timerId);
timerId = null;
}
}

// Event handlers
els.ageGroup.addEventListener("change", () => {
calcBmr();
saveState();
updateUI();
});
els.gender.addEventListener("change", () => {
calcBmr();
saveState();
updateUI();
});
els.weight.addEventListener("input", () => {
calcBmr();
saveState();
updateUI();
});
els.muscleLevel.addEventListener("change", () => {
calcBmr();
saveState();
updateUI();
});

els.startBtn.addEventListener("click", () => {
if (!state.startTimestamp) {
// Ny faste
let pre = parseFloat(els.preHours.value.replace(",", "."));
if (!isFinite(pre) || pre < 0) pre = 0;
state.preHours = pre;
state.startTimestamp = Date.now();
state.totalActivityCalories = 0;
state.totalRefeedCalories = 0;
els.totalActivityCalories.textContent = "0";
els.totalRefeedCalories.textContent = "0";
}
document.body.classList.remove("prestart");
calcBmr();
saveState();
startTimerLoop();
});

els.resetBtn.addEventListener("click", () => {
// Nulstil hele fasen
state.startTimestamp = null;
state.preHours = 0;
state.totalActivityCalories = 0;
state.totalRefeedCalories = 0;
els.preHours.value = "";
els.activityCalories.value = "";
els.refeedCalories.value = "";
els.totalActivityCalories.textContent = "0";
els.totalRefeedCalories.textContent = "0";
document.body.classList.add("prestart");
stopTimerLoop();
updateUI();
saveState();
});

els.addActivityBtn.addEventListener("click", () => {
let cals = parseFloat(els.activityCalories.value.replace(",", "."));
if (!isFinite(cals) || cals <= 0) return;
state.totalActivityCalories += cals;
els.activityCalories.value = "";
saveState();
updateUI();
});

els.applyRefeedBtn.addEventListener("click", () => {
let cals = parseFloat(els.refeedCalories.value.replace(",", "."));
if (!isFinite(cals) || cals <= 0) return;
state.totalRefeedCalories += cals;
els.refeedCalories.value = "";
saveState();
updateUI();
});

// Info-popup
els.infoBtn.addEventListener("click", () => {
els.infoOverlay.style.display = "flex";
});
els.infoCloseBtn.addEventListener("click", () => {
els.infoOverlay.style.display = "none";
});
els.infoOverlay.addEventListener("click", (e) => {
if (e.target === els.infoOverlay) {
els.infoOverlay.style.display = "none";
}
});

// Init
loadState();

// S√¶t UI felter til gemt profil
if (state.ageGroup) els.ageGroup.value = state.ageGroup;
if (state.gender) els.gender.value = state.gender;
if (state.muscleLevel) els.muscleLevel.value = state.muscleLevel;
if (state.weight) els.weight.value = state.weight;

calcBmr();

if (state.startTimestamp) {
// der var en igangv√¶rende faste
document.body.classList.remove("prestart");
startTimerLoop();
} else {
document.body.classList.add("prestart");
updateUI();
}
</script>
</body>
</html>
